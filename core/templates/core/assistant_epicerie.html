{% extends "core/base.html" %}
{% load static %}

{% block title %}Gestion d'Inventaire et Liste d'Épicerie{% endblock %}

{% block head_styles %}
<link rel="stylesheet" href="{% static 'css/tutorial.css' %}">
<style>
    :root {
        --bg-color: #f3f4f6;
        --card-bg: #ffffff;
        --primary-color: #4f46e5; /* Indigo moderne */
        --primary-hover: #4338ca;
        --danger-color: #ef4444;
        --text-main: #1f2937;
        --text-muted: #6b7280;
        --border-color: #e5e7eb;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --radius: 12px;
    }

    body {
        background-color: var(--bg-color);
        color: var(--text-main);
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    h1, h2, h3 {
        color: var(--text-main);
        font-weight: 600;
        margin-bottom: 1rem;
        border: none !important; /* On enlève les lignes moches */
    }

    h1 { font-size: 1.5rem; }
    h2 { font-size: 1.25rem; }
    h3 { font-size: 1.1rem; color: var(--primary-color); margin-top: 1.5rem; }

    /* --- Style des Widgets (Cartes) --- */
    .grid-stack-item-content {
        background-color: var(--card-bg);
        border-radius: var(--radius);
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-sm);
        padding: 24px !important;
        transition: box-shadow 0.3s ease;
        /* --- AJOUTS IMPORTANTS POUR L'AFFICHAGE --- */
        display: flex;
        flex-direction: column;
        overflow: auto !important; /* Restaure la barre de défilement */
    }

    .grid-stack-item-content:hover {
        box-shadow: var(--shadow-md);
    }

    /* --- Liste d'inventaire --- */
    ul { padding: 0; }
    
    .inventory-item {
        display: flex;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s;
    }

    .inventory-item:hover {
        background-color: #f9fafb;
    }

    .item-details {
        flex-grow: 1;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .inventory-item-name {
        font-weight: 500;
        font-size: 1rem;
        color: var(--text-main);
        cursor: pointer;
    }

    /* --- Contrôles (Boutons et Inputs) --- */
    .item-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Inputs minimalistes */
    .item-quantity-input, .item-threshold-input {
        width: 45px;
        text-align: center;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 4px;
        font-weight: 600;
        color: var(--primary-color);
        background: #f9fafb;
    }

    /* Boutons d'actions discrets (Icônes) */
    .btn-icon {
        background: none;
        border: none;
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        color: var(--text-muted);
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-icon:hover {
        background-color: #f3f4f6;
        color: var(--primary-color);
    }

    .btn-icon.delete:hover {
        color: var(--danger-color);
        background-color: #fee2e2;
    }

    /* Boutons principaux */
    .btn-primary {
        background-color: var(--primary-color);
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 500;
        box-shadow: var(--shadow-sm);
    }
    
    .btn-primary:hover {
        background-color: var(--primary-hover);
        transform: translateY(-1px);
    }

    /* --- Formulaire Ajout --- */
    #addItemForm {
        background-color: #f8fafc;
        border: 1px solid var(--border-color);
        box-shadow: none;
        padding: 20px;
    }
    
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid var(--border-color);
        padding: 10px;
    }

    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    /* Alerte stock bas */
    .low-quantity-warning {
        border-left: 4px solid #f59e0b; /* Orange ambré */
        background-color: #fffbeb;
        padding-left: 12px;
    }
    
    /* Checkbox custom */
    input[type="checkbox"] {
        accent-color: var(--primary-color);
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    /* --- Style pour la minimisation des widgets --- */
    .widget-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
    }

    .btn-minimize {
        background: transparent;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        padding: 2px 6px;
        color: var(--text-muted);
        transition: all 0.2s;
        font-size: 0.9rem;
    }

    .btn-minimize:hover {
        background-color: #e5e7eb;
        color: var(--primary-color);
    }

    /* État minimisé */
    .grid-stack-item-content.minimized {
        overflow: hidden !important;
        padding: 0 !important; /* On retire le padding global pour mieux centrer via flex */
        display: flex !important;
        align-items: center;     /* Centre verticalement */
        justify-content: center; /* Centre horizontalement */
    }

    /* 1. On cache tout SAUF h1, h2 et les conteneurs .d-flex. Les h3 seront donc cachés. */
    .grid-stack-item-content.minimized section > *:not(h1):not(h2):not(.d-flex) {
        display: none !important;
    }

    /* 2. Nettoyage spécifique pour les conteneurs .d-flex (comme dans l'Inventaire) */
    .grid-stack-item-content.minimized .d-flex > *:not(h1):not(h2) {
        display: none !important;
    }

    /* 3. Style du conteneur .d-flex pour qu'il ne perturbe pas l'alignement */
    .grid-stack-item-content.minimized .d-flex {
        border: none !important;
        margin: 0 !important;
        padding: 0 !important;
        width: auto !important; /* S'adapte au contenu */
        height: auto !important;
    }
    
    /* 4. On s'assure que les sections vides (dont on a caché le h3) ne prennent pas de place */
    .grid-stack-item-content.minimized section {
        margin: 0 !important;
        padding: 0 !important;
        display: contents; /* Astuce: la section n'agit plus comme une boîte, seuls ses fils (h1/h2) comptent */
    }

    /* 5. Style final des titres restants */
    .grid-stack-item-content.minimized h1, 
    .grid-stack-item-content.minimized h2 {
        margin: 0 !important;
        padding: 0 35px 0 10px !important; /* Padding droit pour éviter de chevaucher le bouton '-' */
        font-size: 1rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.5;
        text-align: center;
        border: none !important;
        width: 100%;
    }
    
    /* --- AJOUTS POUR LA MODALE RECETTE --- */
    
    /* 1. Taille par défaut réduite */
    #recipe-view-modal .modal-content {
        max-width: 700px; /* Largeur confortable mais pas pleine page */
        width: 90%;
        transition: all 0.3s ease-in-out;
        display: flex;
        flex-direction: column;
        max-height: 85vh; /* Évite que ça dépasse de l'écran */
    }

    #recipe-view-modal .modal-body {
        overflow-y: auto; /* Scroll uniquement dans le corps */
    }

    /* 2. État Maximisé */
    #recipe-view-modal .modal-content.maximized {
        max-width: 98%;
        width: 98%;
        height: 95vh;
        max-height: 95vh;
    }

    /* 3. Contrôles de fenêtre (Header) */
    .modal-header .window-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .modal-header h2 {
        flex-grow: 1;
        margin-right: 15px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* AJOUT POUR LE DRAG & DROP */
    #recipe-view-modal .modal-header {
        cursor: move; /* Curseur de déplacement */
        user-select: none; /* Empêche de sélectionner le texte pendant qu'on bouge */
    }

    /* Important : on s'assure que le curseur reste normal sur les boutons */
    #recipe-view-modal .modal-header button,
    #recipe-view-modal .modal-header .close-btn {
        cursor: pointer;
    }
    
    /* Si la fenêtre est maximisée, on ne veut pas suggérer qu'elle est déplaçable */
    #recipe-view-modal .modal-content.maximized .modal-header {
        cursor: default; 
    }
    /* AJOUT : Désactive l'animation pendant le déplacement pour éviter le lag */
    .modal-content.dragging {
        transition: none !important;
    }
    /* Ajustement pour aligner le bouton d'aide */
    .grid-stack-item-content h1, 
    .grid-stack-item-content h2,
    .section-header {
        display: flex;
        align-items: center;
    }
    
    .section-header-text {
        flex-grow: 1;
    }
</style>
{% endblock %}

{% block content %}
            <div class="grid-stack">
                <!-- WIDGET 1: Inventaire -->
                <div class="grid-stack-item" gs-id="inventory-widget" gs-w="8" gs-h="6" gs-x="0" gs-y="0">
                    <div class="grid-stack-item-content">
                        <section id="inventory-section">
                            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                                <h1 class="m-0 fs-4 text-primary"><i class="bi bi-box-seam me-2"></i>Inventaire</h1>
                                <div class="d-flex align-items-center" style="flex-grow: 1;">
                                    <h1 class="m-0 fs-4 text-primary me-2"><i class="bi bi-box-seam me-2"></i>Inventaire</h1>
                                    <button class="btn-help" onclick="startInventoryTutorial()" title="Comment ça marche ?">?</button>
                                </div>
                                <button id="addLowStockItemsBtn" class="btn btn-outline-warning btn-sm rounded-pill">
                                    <i class="bi bi-cart-plus"></i> Pénuries vers liste
                                </button>
                            </div>
                            <div class="inventory-controls mb-3">
                                <input type="checkbox" id="toggleAll">
                                <label for="toggleAll" style="margin-left: 8px; cursor: pointer;">Tout sélectionner pour la recette</label>
                            </div>
                            <div id="inventory-display"></div>
                        </section>
                    </div>
                </div>

                <!-- WIDGET 2: Outils -->
                <div class="grid-stack-item" gs-id="tools-widget" gs-w="4" gs-h="7" gs-x="8" gs-y="0">
                    <div class="grid-stack-item-content">
                        <section id="add-item-section" class="mb-4">
                            <h2>Ajouter un Nouvel Article à l'Inventaire</h2>
                            <form id="addItemForm" class="row g-3 align-items-center p-3 bg-light rounded-3 border">
                                <div class="col-sm-4">
                                    <label for="itemName" class="visually-hidden">Nom</label>
                                    <input type="text" class="form-control" id="itemName" placeholder="Nom de l'article" required>
                                </div>
                                <div class="col-sm-2">
                                    <label for="itemQuantity" class="visually-hidden">Quantité</label>
                                    <input type="text" class="form-control" id="itemQuantity" value="1" placeholder="Quantité">
                                </div>
                                <!-- DÉBUT DES MODIFICATIONS DU FORMULAIRE -->
                                <div class="col-sm-3">
                                    <label for="itemCategory" class="visually-hidden">Catégorie</label>
                                    <div class="input-group">
                                        <select id="itemCategory" class="form-select">
                                            <!-- Les catégories seront chargées ici par JS -->
                                        </select>
                                    <button class="btn btn-outline-secondary" type="button" id="add-category-btn" title="Ajouter une catégorie">+</button>
                                    </div>
                                </div>
                                <!-- FIN DES MODIFICATIONS DU FORMULAIRE -->
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Ajouter</button>
                                </div>
                            </form>
                        </section>
                        <section id="data-management" class="data-management-section">
                            <h3>Gestion des Données d'Inventaire</h3>
                            <p>Utilisez ces outils pour migrer votre ancien inventaire local vers votre compte.</p>
                            <div class="data-management-buttons">
                                <button id="view-old-inventory-btn" class="btn" style="background-color: #95a5a6;">Voir l'inventaire local</button>
                                <button id="export-inventory-btn" class="btn" style="background-color: #16a085;">Exporter l'inventaire local</button>
                                <button id="export-server-inventory-btn" class="btn" style="background-color: #27ae60;">Exporter l'inventaire utilisateur</button>
                                <button id="import-inventory-btn" class="btn" style="background-color: #3498db;">Importer un inventaire</button>
                                <!-- Input caché pour la sélection de fichier -->
                                <input type="file" id="inventory-file-input" class="hidden" accept=".json">
                            </div>
                        </section>
                    </div>
                </div>

                <div class="grid-stack-item" gs-id="shopping-list-widget" gs-w="8" gs-h="5" gs-x="0" gs-y="6">
                    <div class="grid-stack-item-content">
                        <section id="shopping-list-section" class="shopping-list-section">
                            <h2>Liste d'Épicerie</h2>
                            <div id="shopping-list-display"></div>
                            <h3>Ajouter à la liste d'épicerie</h3>
                            <form id="addShoppingItemForm" class="add-item-form">
                                <input type="text" id="shoppingItemName" placeholder="Nom de l'article" required>
                                <input type="text" id="shoppingItemQuantity" value="1" placeholder="Quantité">
                                <button type="submit">Ajouter à la liste</button>
                            </form>

                            <div id="import-section" class="import-section">
                                <h3>Importer une liste depuis Gemini</h3>
                                <p style="margin-top:0; font-size: 0.9em; color: #555;">Collez ici le JSON fourni par Gemini pour ajouter plusieurs articles à votre liste.</p>
                                <textarea id="importShoppingListTextarea" placeholder='[{"name": "Oignons", "quantity": "2"}, {"name": "Ail", "quantity": "1 tête"}]'></textarea>
                                <button id="importShoppingListBtn" class="btn">Importer la liste</button>
                            </div>
                        </section>
                    </div>
                </div>
                        
                <div class="grid-stack-item" gs-id="recipe-book-widget" gs-w="4" gs-h="5" gs-x="8" gs-y="6">
                    <div class="grid-stack-item-content">
                        <section id="recipe-book-section">
                            <h2>Livre de recettes</h2>
                            <button id="show-add-recipe-modal-btn" class="btn" style="background-color: #16a085; margin-bottom: 20px;">Ajouter une recette</button>
                            <!-- Utilisation du système de grille de Bootstrap pour les cartes -->
                            <div id="recipe-list-display" class="row row-cols-1 g-3">
                                <!-- Le JS remplira cette section avec des cartes -->
                            </div>
                        </section>
                    </div>
                </div>

                <div class="grid-stack-item" gs-id="generate-list-widget" gs-w="6" gs-h="5" gs-x="0" gs-y="11">
                    <div class="grid-stack-item-content">
                        <section id="ai-shopping-list-generator">
                            <h2>Générer une Liste d'Épicerie avec l'IA</h2>
                            <form id="aiShoppingListForm" class="add-item-form" style="display: block;">
                                <div style="width: 100%; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                                    <label for="numPeople">Nombre de personnes:</label>
                                    <input type="number" id="numPeople" value="2" min="1" style="width: 80px; padding: 8px;">
                                </div>
                                <div style="width: 100%; margin-bottom: 10px;">
                                    <label for="mealsList" style="display: block; margin-bottom: 5px;">Repas à préparer (un par ligne):</label>
                                    <textarea id="mealsList" rows="4" placeholder="Ex: Pâté chinois&#10;Spaghetti bolognaise&#10;Soupe aux légumes" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #bdc3c7; font-size: 16px; box-sizing: border-box;"></textarea>
                                </div>
                                <button type="button" id="generateShoppingListBtn" class="btn-recipe" style="width: 100%;">Générer l'instruction pour l'IA</button>
                            </form>
                        </section>
                    </div>
                </div>

                <div class="grid-stack-item" gs-id="recipe-generator-widget" gs-w="6" gs-h="5" gs-x="6" gs-y="11">
                    <div class="grid-stack-item-content">
                        <section id="recipe-section" class="recipe-section">
                            <h2>Trouver une Recette</h2>
                            <div class="recipe-options" style="margin-bottom: 5px;">
                                <input type="checkbox" id="includeExtraIngredients" name="includeExtraIngredients">
                                <label for="includeExtraIngredients">Permettre des ingrédients manquants</label>
                            </div>
                            <div class="recipe-options">
                                <input type="checkbox" id="useFlyerDeals" name="useFlyerDeals">
                                <label for="useFlyerDeals">Utiliser les articles en rabais des circulaires</label>
                            </div>
                            
                            <h3 style="color: #34495e; font-size: 1.1em; margin-top: 20px; margin-bottom: 10px; border-top: 1px solid #eee; padding-top: 15px;">Options de cuisson</h3>
                            <div class="recipe-options" style="flex-direction: column; align-items: flex-start; gap: 8px; max-width: 300px; margin-left: auto; margin-right: auto; text-align: left;">
                                <div>
                                    <input type="checkbox" id="recipeCatNoOven" name="recipeCatNoOven">
                                    <label for="recipeCatNoOven">Pas de four (cuisinière seulement)</label>
                                </div>
                                <div>
                                    <input type="checkbox" id="recipeCatNoCook" name="recipeCatNoCook">
                                    <label for="recipeCatNoCook">Pas de cuisson</label>
                                </div>
                                <div>
                                    <input type="checkbox" id="recipeCatQuick" name="recipeCatQuick">
                                    <label for="recipeCatQuick">Repas rapide (moins de 30 minutes)</label>
                                </div>
                            </div>

                            <button id="generateRecipeBtn" class="btn-recipe" style="margin-top: 20px;">Générer l'instruction pour l'IA</button>
                        </section>

                        <section id="prompt-output-section" style="display: none;">
                            <h3>Votre instruction pour l'IA est prête</h3>
                            <p><strong>Étape 1 :</strong> Copiez le texte ci-dessous. <strong>Étape 2 :</strong> Ouvrez Gemini et collez-le.</p>
                            <textarea id="prompt-output-textarea" rows="10" style="width: 100%; box-sizing: border-box; font-family: monospace; padding: 10px; border-radius: 5px; border: 1px solid #ccc;"></textarea>
                            <div style="margin-top: 10px; display: flex; gap: 10px;">
                                <button id="copy-prompt-btn" class="btn" style="background-color: #27ae60;">Copier le texte</button>
                                <a href="https://gemini.google.com/app" target="_blank" class="btn" style="background-color: #8e44ad; text-decoration: none; text-align: center;">Ouvrir Gemini</a>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        

    <!-- Modale pour ajouter/éditer une recette -->
    <div id="recipe-form-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="recipe-modal-title">Ajouter une Nouvelle Recette</h2>
                <span class="close-btn" id="close-recipe-form-modal">&times;</span>
            </div>
            <div class="modal-body">

                <!-- NOUVELLE SECTION D'IMPORTATION IA -->
                <div class="ai-importer-section">
                    <h4>Importer une recette avec l'IA</h4>
                    <p style="margin-top:0; font-size: 0.9em; color: #555;">
                        <b>Étape 1:</b> Copiez l'instruction. <b>Étape 2:</b> Collez-la dans Gemini, suivie du lien ou du texte de la recette.
                    </p>
                    <textarea id="ai-recipe-prompt" rows="8" readonly>
Agis comme un extracteur de données de recettes. Transforme la recette que je vais fournir en un format JSON.
Le JSON doit contenir les clés suivantes : "name" (string), "ingredients" (string, avec chaque ingrédient sur une nouvelle ligne), "instructions" (string, avec chaque étape sur une nouvelle ligne), et "comments" (string, pour les notes additionnelles).

Ne fournis AUCUN texte avant ou après le bloc JSON.

Exemple de format :
{
  "name": "Crêpes faciles",
  "ingredients": "1 tasse de farine\n2 oeufs\n1/2 tasse de lait\n1/4 tasse d'eau\n2 c. à soupe de beurre fondu",
  "instructions": "Mélanger tous les ingrédients.\nFaire cuire dans une poêle chaude.",
  "comments": "Servir avec du sirop d'érable."
}

Maintenant, analyse la recette suivante :
                    </textarea>
                    <div class="btn-group">
                        <button type="button" id="copy-recipe-prompt-btn" class="btn" style="background-color: #27ae60;">Copier l'instruction</button>
                        <a href="https://gemini.google.com/app" target="_blank" class="btn" style="background-color: #8e44ad; text-decoration: none;">Ouvrir Gemini</a>
                    </div>
                </div>

                <div class="json-importer-section">
                    <label for="recipe-json-input"><b>Étape 3:</b> Collez le JSON de Gemini ici</label>
                    <textarea id="recipe-json-input" rows="4" placeholder='{ "name": "...", "ingredients": "...", ... }'></textarea>
                    <button type="button" id="import-recipe-json-btn" class="btn" style="background-color: #3498db; width: 100%;">Importer et Remplir les champs</button>
                </div>
                <!-- FIN DE LA NOUVELLE SECTION -->
                
                <hr style="margin: 30px 0;">

                <form id="recipe-form">
                    <input type="hidden" id="recipe-id">
                    <label for="recipe-name">Nom de la recette</label>
                    <input type="text" id="recipe-name" required>
                    
                    <label for="recipe-ingredients">Ingrédients (un par ligne)</label>
                    <textarea id="recipe-ingredients" placeholder="Ex: 1 tasse de farine&#10;2 oeufs" required></textarea>
                    
                    <label for="recipe-instructions">Instructions</label>
                    <textarea id="recipe-instructions" required></textarea>
                    
                    <label for="recipe-comments">Commentaires / Notes</label>
                    <textarea id="recipe-comments"></textarea>
                    
                    <div class="modal-footer">
                        <button type="submit" class="btn" style="background-color: #2ecc71;">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modale pour voir une recette -->
    <div id="recipe-view-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="recipe-view-title"></h2>
                
                <!-- Contrôles de fenêtre -->
                <div class="window-controls">
                    <button id="btn-popout-recipe" class="btn-icon" title="Ouvrir dans une nouvelle fenêtre">
                        <i class="bi bi-box-arrow-up-right"></i>
                    </button>
                    <button id="btn-maximize-recipe" class="btn-icon" title="Agrandir / Réduire">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                    <span class="close-btn" id="close-recipe-view-modal">&times;</span>
                </div>

            </div>
            <div class="modal-body recipe-view-content">
                <h3>Ingrédients</h3>
                <pre id="recipe-view-ingredients"></pre>
                
                <h3>Instructions</h3>
                <pre id="recipe-view-instructions"></pre>
                
                <h3>Commentaires / Notes</h3>
                <pre id="recipe-view-comments"></pre>
            </div>
            <div class="modal-footer" id="recipe-view-footer">
                <!-- Les boutons seront injectés par le script -->
            </div>
        </div>
    </div>

    <!-- Modale pour voir l'ancien inventaire -->
    <div id="view-old-data-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ancien Inventaire (depuis le stockage local)</h2>
                <span class="close-btn" id="close-old-data-modal">&times;</span>
            </div>
            <div class="modal-body" id="old-data-content">
                <!-- Le contenu sera injecté par le script -->
            </div>
        </div>
    </div>

{% endblock %}

{% block body_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/gridstack@10.2.0/dist/gridstack-all.js"></script>
    <script src="{% static 'js/assistant_page.js' %}"></script>
    
    <script src="{% static 'js/tutorial.js' %}"></script>
    <script>
        // --- SCÉNARIOS DE TUTORIEL ---

        function startInventoryTutorial() {
            // 1. Vérification de sécurité
            if (document.querySelectorAll('.inventory-item').length === 0) {
                alert("Votre inventaire est vide ! Ajoutez d'abord un article via le formulaire de droite pour voir le tutoriel.");
                return;
            }

            window.Tutorial.run([
                // --- VUE D'ENSEMBLE ---
                { 
                    selector: '#inventory-display', 
                    text: "Bienvenue dans votre Inventaire intelligent. Vos articles sont triés par catégorie.",
                    waitAfter: 2000
                },

                // --- MODIFICATION QUANTITÉ (BOUTONS) ---
                { 
                    selector: '.btn-quantity-change[data-amount="1"]', 
                    text: "Action basique : Cliquez sur '+' pour augmenter la quantité...",
                    action: 'click',
                    waitAfter: 500
                },
                { 
                    selector: '.btn-quantity-change[data-amount="-1"]', 
                    text: "...ou sur '-' pour la diminuer au fur et à mesure que vous consommez.",
                    action: 'click',
                    waitAfter: 1000
                },

                // --- MODIFICATION QUANTITÉ (SAISIE) ---
                { 
                    selector: '.item-quantity-input', 
                    text: "Pour les grands changements, cliquez et tapez directement le chiffre.",
                    action: 'type',
                    value: "12" 
                },

                // --- SEUIL D'ALERTE ---
                { 
                    selector: '.item-threshold-input', 
                    text: "L'intelligence est ici : définissez un 'Seuil d'alerte'.",
                    waitAfter: 1000
                },
                {
                    selector: '.item-threshold-input',
                    text: "Si je mets '15' ici alors que j'en ai 12...",
                    action: 'type',
                    value: "15"
                },
                {
                    selector: '.inventory-item',
                    text: "...l'article changera de couleur pour signaler une pénurie !",
                    waitAfter: 2000
                },

                // --- ÉDITION DU NOM ---
                {
                    selector: '.inventory-item-name',
                    text: "Une faute de frappe ? Cliquez simplement sur le nom pour le corriger instantanément.",
                    action: 'click',
                    waitAfter: 1500
                },

                // --- SÉLECTION POUR RECETTE (INDIVIDUELLE) ---
                {
                    selector: '.include-item',
                    text: "Cochez les ingrédients que vous voulez utiliser ce soir...",
                    action: 'click',
                    waitAfter: 1000
                },

                // --- SÉLECTION POUR RECETTE (GLOBALE) ---
                {
                    selector: 'label[for="toggleAll"]',
                    text: "...ou utilisez 'Tout sélectionner' pour dire à l'IA d'utiliser tout votre inventaire.",
                    action: 'click',
                    waitAfter: 1500
                },

                // --- TRANSFERT INTELLIGENT ---
                {
                    selector: '#addLowStockItemsBtn',
                    text: "Fonctionnalité Clé : Un seul clic ici analyse vos seuils et ajoute TOUTES les pénuries à votre liste d'épicerie.",
                    action: 'click',
                    waitAfter: 2500
                },

                // --- GLISSER-DÉPOSER ---
                {
                    selector: '.inventory-item',
                    text: "Astuce Pro : Maintenez le clic et glissez l'article pour réorganiser votre liste.",
                    waitAfter: 2000
                },

                // --- SUPPRESSION ---
                {
                    selector: '.btn-icon.delete',
                    text: "Et si vous ne tenez plus cet article en stock, supprimez-le ici.",
                    waitAfter: 1500
                }
            ]);
        }

        function startAddToolTutorial() {
            window.Tutorial.run([
                {
                    selector: '#itemName',
                    text: "Tapez le nom de l'article ici.",
                    action: 'type',
                    value: "Pommes Rouges"
                },
                {
                    selector: '#itemQuantity',
                    text: "Indiquez la quantité.",
                    action: 'type',
                    value: "6"
                },
                {
                    selector: '#itemCategory',
                    text: "Choisissez une catégorie pour organiser votre inventaire.",
                    action: 'click'
                },
                {
                    selector: '#addItemForm button[type="submit"]',
                    text: "Cliquez ici pour ajouter à l'inventaire.",
                    action: 'click' // Pas de realClick pour ne pas polluer la DB
                }
            ]);
        }
        
        function startShoppingListTutorial() {
             window.Tutorial.run([
                {
                    selector: '#addShoppingItemForm input[type="text"]',
                    text: "Ajoutez manuellement des articles ici.",
                    action: 'type',
                    value: "Lait"
                },
                {
                    selector: '#generate-list-widget',
                    text: "Ou utilisez l'IA plus bas pour générer une liste à partir de vos repas !",
                    waitAfter: 2000
                },
                {
                    selector: '.btn-move:first-of-type', 
                    text: "Après l'achat, cliquez ici pour envoyer l'article vers votre inventaire.",
                    // Utiliser un sélecteur générique au cas où la liste est vide, 
                    // idéalement vérifier s'il y a des items avant de lancer cette étape
                }
            ]);
        }

        function startRecipeTutorial() {
            window.Tutorial.run([
                {
                    selector: '#show-add-recipe-modal-btn',
                    text: "Cliquez ici pour créer une nouvelle recette.",
                    action: 'click'
                },
                {
                    selector: '#ai-recipe-prompt',
                    text: "Astuce : Utilisez ce texte avec Gemini pour importer n'importe quelle recette du web !",
                    waitAfter: 3000
                }
            ]);
        }
    </script>
{% endblock %}