{% extends "core/base.html" %}
{% load static %}

{% block title %}Gestion d'Inventaire et Liste d'Épicerie{% endblock %}

{% block head_styles %}
    <style>
        .container {
            width: 100%;
            max-width: 1400px !important;
            padding: 0 !important;
            background: transparent !important;
            box-shadow: none !important;
        }
        .grid-stack-item-content {
            background-color: #ffffff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: auto !important;
            padding: 20px;
            height: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        .grid-stack-item-content section {
            flex-grow: 1;
        }
        .grid-stack-item-content h1, .grid-stack-item-content h2, .grid-stack-item-content h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        .ui-resizable-handle {
            filter: brightness(0.8);
        }


        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .content-wrapper {
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        h1, h2 {
            color: #2c3e50;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        h3.category-title {
             scroll-margin-top: 20px;
        }
        .inventory-section, .shopping-list-section {
            margin-bottom: 30px;
        }
        .category-title {
            color: #3498db;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        ul {
            list-style: none;
            padding: 0;
        }
        li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        li:last-child {
            border-bottom: none;
        }
        .shopping-list-item {
            cursor: grab;
        }
        .shopping-list-item.dragging {
            opacity: 0.5;
            background-color: #ecf0f1;
        }
        .shopping-list-item.drag-over {
            border-top: 2px solid #3498db;
        }
        .inventory-item {
            cursor: grab;
        }
        .inventory-item.dragging {
            opacity: 0.5;
            background-color: #ecf0f1;
        }
        .inventory-item.drag-over {
            border-top: 2px solid #3498db;
        }
        .inventory-section.drag-over {
            background-color: #e8f4fd; /* Bleu clair pour indiquer une zone de dépôt */
            border-radius: 8px;
        }
        .low-quantity-warning {
            background-color: #fcf8e3; /* Jaune pâle */
            border-left: 4px solid #f39c12; /* Bordure orange */
            padding-left: 10px; /* Ajouter un peu d'espace */
            margin-left: -14px; /* Compenser le padding et la bordure */
        }
        li.low-quantity-warning {
             border-bottom: 1px solid #e0d9c3;
        }
        .item-details {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1; /* Permet aux détails de prendre l'espace */
        }
        .item-name {
            font-weight: 500;
        }
        .inventory-item-name {
             cursor: pointer;
             font-weight: 500;
        }
        .inventory-item-name:hover {
            text-decoration: underline;
            color: #3498db;
        }
        .item-controls, .shopping-item-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .item-controls input[type="text"] {
            width: 50px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }
        .btn-delete { background-color: #e74c3c; }
        .btn-delete:hover { background-color: #c0392b; }
        .btn-move { background-color: #3498db; }
        .btn-move:hover { background-color: #2980b9; }
        .add-item-form {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .add-item-form input, .add-item-form select, .add-item-form button {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #bdc3c7;
            font-size: 16px;
        }
        .add-item-form input[type="text"] { flex: 2; }
        .add-item-form input[type="text"], .add-item-form select { min-width: 150px; }
        .add-item-form button {
            background-color: #2ecc71;
            color: white;
            border: none;
            cursor: pointer;
            flex: 1;
            min-width: 100px;
        }
        .add-item-form button:hover { background-color: #27ae60; }
        .recipe-section {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        .recipe-options {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #555;
        }
        .btn-recipe {
            background-color: #8e44ad;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-recipe:hover { background-color: #9b59b6; }
        .inventory-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        #prompt-output-section {
            background-color: #e8f4fd;
            border: 1px solid #d1e9fc;
            border-radius: 8px;
            padding: 20px;
            margin-top: 25px;
        }
        .import-section {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .import-section textarea {
            width: 100%;
            min-height: 100px;
            box-sizing: border-box;
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            margin-bottom: 10px;
        }
        .import-section button {
            width: 100%;
            background-color: #16a085;
        }
        .import-section button:hover {
            background-color: #117a65;
        }
        #recipe-list-display {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
        }
        .recipe-card {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: box-shadow 0.3s, transform 0.3s;
        }
        .recipe-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-3px);
        }
        .recipe-card h3 {
            margin: 0 0 10px 0;
            color: #34495e;
            font-size: 1.1em;
        }
        .modal {
            display: none; position: fixed; z-index: 1056; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content {
            background-color: #fefefe; margin: 5% auto; padding: 25px;
            border: 1px solid #888; width: 90%; max-width: 700px; /* Largeur augmentée */
            border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            animation: slideIn 0.4s;
        }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #ddd; padding-bottom: 15px; margin-bottom: 20px;
        }
        .modal-header h2 { margin: 0; color: #2c3e50; border: none; }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: black; }
        .modal-body label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; }
        .modal-body textarea, .modal-body input {
            width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 5px;
            border: 1px solid #ccc; font-size: 1em; box-sizing: border-box;
        }
        .modal-body textarea { min-height: 120px; resize: vertical; }
        .modal-footer { text-align: right; margin-top: 20px; }
        .recipe-view-content h3 { color: #3498db; margin-top: 15px; }
        .recipe-view-content pre {
            background-color: #f4f7f9; padding: 10px; border-radius: 5px;
            white-space: pre-wrap; word-wrap: break-word; font-family: inherit;
        }
        .ai-importer-section {
            background-color: #e8f4fd;
            border: 1px solid #d1e9fc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .ai-importer-section h4 {
            margin-top: 0;
            color: #2c3e50;
        }
        .ai-importer-section textarea {
            font-family: monospace;
            background-color: #f8f9fa;
        }
        .ai-importer-section .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .json-importer-section {
             background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        /* --- STYLES POUR L'AUTHENTIFICATION --- */
        #auth-section {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid #bdc3c7;
        }
        .auth-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #user-status {
            font-weight: 500;
        }
        #user-status button {
            margin-left: 10px;
        }
        #auth-forms {
            display: flex;
            gap: 10px;
        }
        #auth-forms input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #bdc3c7;
        }
        .auth-toggle {
            margin-top: 10px;
            font-size: 0.9em;
        }
        .auth-toggle a {
            color: #3498db;
            cursor: pointer;
            text-decoration: underline;
        }

        /* --- STYLES POUR CACHER/AFFICHER LES ÉLÉMENTS --- */
        .hidden {
            display: none !important;
        }
           
        /* Styles pour la section de gestion */
        .data-management-section {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }
        .data-management-section h3 {
            margin-top: 0;
            color: #34495e;
        }
        .data-management-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
{% endblock %}

{% block content %}

{% load static %}
            <div class="grid-stack">
                <!-- WIDGET 1: Inventaire -->
                <div class="grid-stack-item" gs-id="inventory-widget" gs-w="8" gs-h="6" gs-x="0" gs-y="0">
                    <div class="grid-stack-item-content">
                        <section id="inventory-section">
                            <h1>Inventaire des Denrées</h1>
                            <div class="inventory-controls">
                                <div>
                                    <input type="checkbox" id="toggleAll" name="toggleAll">
                                    <label for="toggleAll">Cocher/décocher tout</label>
                                </div>
                                <button id="addLowStockItemsBtn" class="btn" style="background-color: #e67e22;">Ajouter les articles en pénurie à la liste</button>
                            </div>
                            <div id="inventory-display"></div>
                        </section>
                    </div>
                </div>

                <!-- WIDGET 2: Outils -->
                <div class="grid-stack-item" gs-id="tools-widget" gs-w="4" gs-h="7" gs-x="8" gs-y="0">
                    <div class="grid-stack-item-content">
                        <section id="add-item-section" class="mb-4">
                            <h2>Ajouter un Nouvel Article à l'Inventaire</h2>
                            <form id="addItemForm" class="row g-3 align-items-center p-3 bg-light rounded-3 border">
                                <div class="col-sm-4">
                                    <label for="itemName" class="visually-hidden">Nom</label>
                                    <input type="text" class="form-control" id="itemName" placeholder="Nom de l'article" required>
                                </div>
                                <div class="col-sm-2">
                                    <label for="itemQuantity" class="visually-hidden">Quantité</label>
                                    <input type="text" class="form-control" id="itemQuantity" value="1" placeholder="Quantité">
                                </div>
                                <!-- DÉBUT DES MODIFICATIONS DU FORMULAIRE -->
                                <div class="col-sm-3">
                                    <label for="itemCategory" class="visually-hidden">Catégorie</label>
                                    <div class="input-group">
                                        <select id="itemCategory" class="form-select">
                                            <!-- Les catégories seront chargées ici par JS -->
                                        </select>
                                    <button class="btn btn-outline-secondary" type="button" id="add-category-btn" title="Ajouter une catégorie">+</button>
                                    </div>
                                </div>
                                <!-- FIN DES MODIFICATIONS DU FORMULAIRE -->
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Ajouter</button>
                                </div>
                            </form>
                        </section>
                        <section id="data-management" class="data-management-section">
                            <h3>Gestion des Données d'Inventaire</h3>
                            <p>Utilisez ces outils pour migrer votre ancien inventaire local vers votre compte.</p>
                            <div class="data-management-buttons">
                                <button id="view-old-inventory-btn" class="btn" style="background-color: #95a5a6;">Voir l'inventaire local</button>
                                <button id="export-inventory-btn" class="btn" style="background-color: #16a085;">Exporter l'inventaire local</button>
                                <button id="export-server-inventory-btn" class="btn" style="background-color: #27ae60;">Exporter l'inventaire utilisateur</button>
                                <button id="import-inventory-btn" class="btn" style="background-color: #3498db;">Importer un inventaire</button>
                                <!-- Input caché pour la sélection de fichier -->
                                <input type="file" id="inventory-file-input" class="hidden" accept=".json">
                            </div>
                        </section>
                    </div>
                </div>

                <div class="grid-stack-item" gs-id="shopping-list-widget" gs-w="8" gs-h="5" gs-x="0" gs-y="6">
                    <div class="grid-stack-item-content">
                        <section id="shopping-list-section" class="shopping-list-section">
                            <h2>Liste d'Épicerie</h2>
                            <div id="shopping-list-display"></div>
                            <h3>Ajouter à la liste d'épicerie</h3>
                            <form id="addShoppingItemForm" class="add-item-form">
                                <input type="text" id="shoppingItemName" placeholder="Nom de l'article" required>
                                <input type="text" id="shoppingItemQuantity" value="1" placeholder="Quantité">
                                <button type="submit">Ajouter à la liste</button>
                            </form>

                            <div id="import-section" class="import-section">
                                <h3>Importer une liste depuis Gemini</h3>
                                <p style="margin-top:0; font-size: 0.9em; color: #555;">Collez ici le JSON fourni par Gemini pour ajouter plusieurs articles à votre liste.</p>
                                <textarea id="importShoppingListTextarea" placeholder='[{"name": "Oignons", "quantity": "2"}, {"name": "Ail", "quantity": "1 tête"}]'></textarea>
                                <button id="importShoppingListBtn" class="btn">Importer la liste</button>
                            </div>
                        </section>
                    </div>
                </div>
                        
                <div class="grid-stack-item" gs-id="recipe-book-widget" gs-w="4" gs-h="5" gs-x="8" gs-y="6">
                    <div class="grid-stack-item-content">
                        <section id="recipe-book-section">
                            <h2>Livre de recettes</h2>
                            <button id="show-add-recipe-modal-btn" class="btn" style="background-color: #16a085; margin-bottom: 20px;">Ajouter une recette</button>
                            <!-- Utilisation du système de grille de Bootstrap pour les cartes -->
                            <div id="recipe-list-display" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                                <!-- Le JS remplira cette section avec des cartes -->
                            </div>
                        </section>
                    </div>
                </div>

                <div class="grid-stack-item" gs-id="generate-list-widget" gs-w="6" gs-h="5" gs-x="0" gs-y="11">
                    <div class="grid-stack-item-content">
                        <section id="ai-shopping-list-generator">
                            <h2>Générer une Liste d'Épicerie avec l'IA</h2>
                            <form id="aiShoppingListForm" class="add-item-form" style="display: block;">
                                <div style="width: 100%; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                                    <label for="numPeople">Nombre de personnes:</label>
                                    <input type="number" id="numPeople" value="2" min="1" style="width: 80px; padding: 8px;">
                                </div>
                                <div style="width: 100%; margin-bottom: 10px;">
                                    <label for="mealsList" style="display: block; margin-bottom: 5px;">Repas à préparer (un par ligne):</label>
                                    <textarea id="mealsList" rows="4" placeholder="Ex: Pâté chinois&#10;Spaghetti bolognaise&#10;Soupe aux légumes" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #bdc3c7; font-size: 16px; box-sizing: border-box;"></textarea>
                                </div>
                                <button type="button" id="generateShoppingListBtn" class="btn-recipe" style="width: 100%;">Générer l'instruction pour l'IA</button>
                            </form>
                        </section>
                    </div>
                </div>

                <div class="grid-stack-item" gs-id="recipe-generator-widget" gs-w="6" gs-h="5" gs-x="6" gs-y="11">
                    <div class="grid-stack-item-content">
                        <section id="recipe-section" class="recipe-section">
                            <h2>Trouver une Recette</h2>
                            <div class="recipe-options" style="margin-bottom: 5px;">
                                <input type="checkbox" id="includeExtraIngredients" name="includeExtraIngredients">
                                <label for="includeExtraIngredients">Permettre des ingrédients manquants</label>
                            </div>
                            <div class="recipe-options">
                                <input type="checkbox" id="useFlyerDeals" name="useFlyerDeals">
                                <label for="useFlyerDeals">Utiliser les articles en rabais des circulaires</label>
                            </div>
                            
                            <h3 style="color: #34495e; font-size: 1.1em; margin-top: 20px; margin-bottom: 10px; border-top: 1px solid #eee; padding-top: 15px;">Options de cuisson</h3>
                            <div class="recipe-options" style="flex-direction: column; align-items: flex-start; gap: 8px; max-width: 300px; margin-left: auto; margin-right: auto; text-align: left;">
                                <div>
                                    <input type="checkbox" id="recipeCatNoOven" name="recipeCatNoOven">
                                    <label for="recipeCatNoOven">Pas de four (cuisinière seulement)</label>
                                </div>
                                <div>
                                    <input type="checkbox" id="recipeCatNoCook" name="recipeCatNoCook">
                                    <label for="recipeCatNoCook">Pas de cuisson</label>
                                </div>
                                <div>
                                    <input type="checkbox" id="recipeCatQuick" name="recipeCatQuick">
                                    <label for="recipeCatQuick">Repas rapide (moins de 30 minutes)</label>
                                </div>
                            </div>

                            <button id="generateRecipeBtn" class="btn-recipe" style="margin-top: 20px;">Générer l'instruction pour l'IA</button>
                        </section>

                        <section id="prompt-output-section" style="display: none;">
                            <h3>Votre instruction pour l'IA est prête</h3>
                            <p><strong>Étape 1 :</strong> Copiez le texte ci-dessous. <strong>Étape 2 :</strong> Ouvrez Gemini et collez-le.</p>
                            <textarea id="prompt-output-textarea" rows="10" style="width: 100%; box-sizing: border-box; font-family: monospace; padding: 10px; border-radius: 5px; border: 1px solid #ccc;"></textarea>
                            <div style="margin-top: 10px; display: flex; gap: 10px;">
                                <button id="copy-prompt-btn" class="btn" style="background-color: #27ae60;">Copier le texte</button>
                                <a href="https://gemini.google.com/app" target="_blank" class="btn" style="background-color: #8e44ad; text-decoration: none; text-align: center;">Ouvrir Gemini</a>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        

    <!-- Modale pour ajouter/éditer une recette -->
    <div id="recipe-form-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="recipe-modal-title">Ajouter une Nouvelle Recette</h2>
                <span class="close-btn" id="close-recipe-form-modal">&times;</span>
            </div>
            <div class="modal-body">

                <!-- NOUVELLE SECTION D'IMPORTATION IA -->
                <div class="ai-importer-section">
                    <h4>Importer une recette avec l'IA</h4>
                    <p style="margin-top:0; font-size: 0.9em; color: #555;">
                        <b>Étape 1:</b> Copiez l'instruction. <b>Étape 2:</b> Collez-la dans Gemini, suivie du lien ou du texte de la recette.
                    </p>
                    <textarea id="ai-recipe-prompt" rows="8" readonly>
Agis comme un extracteur de données de recettes. Transforme la recette que je vais fournir en un format JSON.
Le JSON doit contenir les clés suivantes : "name" (string), "ingredients" (string, avec chaque ingrédient sur une nouvelle ligne), "instructions" (string, avec chaque étape sur une nouvelle ligne), et "comments" (string, pour les notes additionnelles).

Ne fournis AUCUN texte avant ou après le bloc JSON.

Exemple de format :
{
  "name": "Crêpes faciles",
  "ingredients": "1 tasse de farine\n2 oeufs\n1/2 tasse de lait\n1/4 tasse d'eau\n2 c. à soupe de beurre fondu",
  "instructions": "Mélanger tous les ingrédients.\nFaire cuire dans une poêle chaude.",
  "comments": "Servir avec du sirop d'érable."
}

Maintenant, analyse la recette suivante :
                    </textarea>
                    <div class="btn-group">
                        <button type="button" id="copy-recipe-prompt-btn" class="btn" style="background-color: #27ae60;">Copier l'instruction</button>
                        <a href="https://gemini.google.com/app" target="_blank" class="btn" style="background-color: #8e44ad; text-decoration: none;">Ouvrir Gemini</a>
                    </div>
                </div>

                <div class="json-importer-section">
                    <label for="recipe-json-input"><b>Étape 3:</b> Collez le JSON de Gemini ici</label>
                    <textarea id="recipe-json-input" rows="4" placeholder='{ "name": "...", "ingredients": "...", ... }'></textarea>
                    <button type="button" id="import-recipe-json-btn" class="btn" style="background-color: #3498db; width: 100%;">Importer et Remplir les champs</button>
                </div>
                <!-- FIN DE LA NOUVELLE SECTION -->
                
                <hr style="margin: 30px 0;">

                <form id="recipe-form">
                    <input type="hidden" id="recipe-id">
                    <label for="recipe-name">Nom de la recette</label>
                    <input type="text" id="recipe-name" required>
                    
                    <label for="recipe-ingredients">Ingrédients (un par ligne)</label>
                    <textarea id="recipe-ingredients" placeholder="Ex: 1 tasse de farine&#10;2 oeufs" required></textarea>
                    
                    <label for="recipe-instructions">Instructions</label>
                    <textarea id="recipe-instructions" required></textarea>
                    
                    <label for="recipe-comments">Commentaires / Notes</label>
                    <textarea id="recipe-comments"></textarea>
                    
                    <div class="modal-footer">
                        <button type="submit" class="btn" style="background-color: #2ecc71;">Sauvegarder</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modale pour voir une recette -->
    <div id="recipe-view-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="recipe-view-title"></h2>
                <span class="close-btn" id="close-recipe-view-modal">&times;</span>
            </div>
            <div class="modal-body recipe-view-content">
                <h3>Ingrédients</h3>
                <pre id="recipe-view-ingredients"></pre>
                
                <h3>Instructions</h3>
                <pre id="recipe-view-instructions"></pre>
                
                <h3>Commentaires / Notes</h3>
                <pre id="recipe-view-comments"></pre>
            </div>
            <div class="modal-footer" id="recipe-view-footer">
                <!-- Les boutons seront injectés par le script -->
            </div>
        </div>
    </div>

    <!-- Modale pour voir l'ancien inventaire -->
    <div id="view-old-data-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ancien Inventaire (depuis le stockage local)</h2>
                <span class="close-btn" id="close-old-data-modal">&times;</span>
            </div>
            <div class="modal-body" id="old-data-content">
                <!-- Le contenu sera injecté par le script -->
            </div>
        </div>
    </div>

{% endblock %}

{% block body_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/gridstack@10.2.0/dist/gridstack-all.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // --- PARTIE 1 : DÉCLARATION DES VARIABLES (SANS ACCÉDER AU DOM) ---
            let inventory = [];
            let shoppingList = [];
            let recipes = [];
            let grid;
            let draggedShoppingItemIndex = null;
            let draggedInventoryItemIndex = null;
            let draggedItemId = null;
            let userCategories = [];

            let inventoryDisplay, shoppingListDisplay, addItemForm, addShoppingItemForm, 
            generateRecipeBtn, generateShoppingListBtn, toggleAllCheckbox, 
            addLowStockItemsBtn, promptOutputSection, promptOutputTextarea, 
            copyPromptBtn, importShoppingListTextarea, importShoppingListBtn, 
            recipeListDisplay, showAddRecipeBtn, recipeFormModal, recipeViewModal, 
            closeRecipeFormBtn, closeRecipeViewBtn, recipeForm, recipeModalTitle, 
            copyRecipePromptBtn, importRecipeJsonBtn, viewOldInventoryBtn, 
            exportInventoryBtn, importInventoryBtn, inventoryFileInput, 
            viewOldDataModal, closeOldDataModalBtn, oldDataContent, autoArrangeBtn, reorganizeBtn, compactBtn, addCategoryBtn;

            // --- PARTIE 2 : FONCTIONS (ELLES NE S'EXÉCUTENT PAS ENCORE) ---
            
            async function loadUserCategories() {
                if (!localStorage.getItem('authToken')) return;
                try {
                    userCategories = await apiCall('inventory/categories', 'GET');
                    const categorySelect = document.getElementById('itemCategory');
                    categorySelect.innerHTML = '<option value="">Aucune catégorie</option>'; // Option par défaut
                    userCategories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.name;
                        categorySelect.appendChild(option);
                    });
                } catch (error) {
                    console.error("Erreur de chargement des catégories:", error);
                }
            }

            async function handleAddNewCategory() {
                const newCategoryName = prompt("Entrez le nom de la nouvelle catégorie :");
                if (newCategoryName && newCategoryName.trim() !== '') {
                    try {
                        await apiCall('inventory/categories', 'POST', { name: newCategoryName.trim() });
                        await loadUserCategories(); // Recharger la liste
                    } catch (error) {
                        alert(`Erreur : ${error.message}`);
                    }
                }
            }

            async function loadServerData() {
                const token = localStorage.getItem('authToken');
                //console.log("1. Tentative de chargement des données. Jeton trouvé:", token ? "Oui" : "Non");

                if (!token) {
                    renderInventory(); renderShoppingList(); renderRecipeBook();
                    return;
                }

                try {
                    const [inv, sl, rec, layout, cats] = await Promise.all([
                        apiCall('inventory', 'GET'),
                        apiCall('shopping-list', 'GET'),
                        apiCall('recipes', 'GET'),
                        apiCall('user/layout?page=assistant', 'GET'),
                        apiCall('inventory/categories', 'GET')
                    ]);
                    
                    /*console.log("2. Données reçues du serveur:", { 
                        inventory: inv, 
                        shoppingList: sl, 
                        recipes: rec 
                    });*/

                    inventory = inv.map(item => ({ ...item, include: true }));
                    shoppingList = sl;
                    recipes = rec;
                    userCategories = cats;
                    
                    if (grid && layout && layout.length > 0) {
                        //console.log("5. Application de la disposition Gridstack sauvegardée.");
                        grid.batchUpdate();
                        layout.forEach(savedItem => {
                            // GridStack sauvegarde l'ID (gs-id ou id) dans la propriété 'id' ou conserve la clé personnalisée si configuré
                            // On vérifie les deux cas possibles pour être robuste
                            const savedId = savedItem['gs-id'] || savedItem.id; 

                            if (savedId) {
                                // On cherche l'élément HTML correspondant
                                const widgetEl = document.querySelector(`.grid-stack-item[gs-id="${savedId}"]`);
                                
                                if (widgetEl) {
                                    // Si trouvé, on met à jour sa position/taille sans toucher à son contenu HTML
                                    grid.update(widgetEl, {
                                        x: savedItem.x,
                                        y: savedItem.y,
                                        w: savedItem.w,
                                        h: savedItem.h
                                    });
                                }
                            }
                        });

                        grid.commit(); // Applique les changements
                    }

                    //console.log("3. Lancement du rendu des composants...");
                    renderInventory();
                    renderShoppingList();
                    renderRecipeBook();
                    //console.log("4. Rendu terminé.");

                    // On peuple la liste déroulante après avoir récupéré les catégories
                    const categorySelect = document.getElementById('itemCategory');
                    categorySelect.innerHTML = '<option value="">Aucune catégorie</option>';
                    userCategories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.name;
                        categorySelect.appendChild(option);
                    });

                    attachStaticListeners();

                } catch (error) {
                    console.error("ERREUR CRITIQUE lors du chargement des données:", error);
                    if (String(error).includes('401') || String(error).includes('403')) {
                        handleLogout();
                    }
                }
            }
            function saveShoppingList() { localStorage.setItem('shoppingList', JSON.stringify(shoppingList)); }

            function initializeGrid() {
                // Initialise Gridstack et stocke l'instance dans la variable globale 'grid'.
                grid = GridStack.init({
                    float: true,
                    cellHeight: '70px',
                    minRow: 1,
                    draggable: {
                        cancel: '#inventory-display, #shopping-list-display'
                    }
                });

                // Attache l'événement de sauvegarde une seule fois, à la création.
                // Il se déclenchera à chaque fois que l'utilisateur déplace ou redimensionne un widget.
                grid.on('change', async function (event, items) {
                    // On ne tente de sauvegarder que si l'utilisateur est connecté.
                    if (localStorage.getItem('authToken')) {
                        const serializedData = grid.save();
                        try {
                            await apiCall('user/layout?page=assistant', 'POST', serializedData);
                        } catch (error) {
                            console.error("Erreur de sauvegarde de la disposition:", error);
                        }
                    }
                });
            }

            // --- FONCTIONS DE RENDU ---
            function renderInventory() {
                const inventoryDisplay = document.getElementById('inventory-display');
                if (!inventoryDisplay) {
                    console.error("ERREUR: 'inventoryDisplay' n'a pas été trouvé.");
                    return;
                }

                inventoryDisplay.innerHTML = ''; // On vide l'affichage
                if (!localStorage.getItem('authToken')) {
                    inventoryDisplay.innerHTML = "<p>Veuillez vous connecter pour voir votre inventaire.</p>";
                    return;
                }

                // On groupe les items par catégorie pour le rendu
                const itemsByCategory = inventory.reduce((acc, item) => {
                    const categoryId = item.category === null ? 'null_category' : item.category;
                    if (!acc[categoryId]) {
                        acc[categoryId] = { name: item.category_name || 'Sans catégorie', items: [] };
                    }
                    acc[categoryId].items.push(item);
                    return acc;
                }, {});

                const sortedCategories = Object.keys(itemsByCategory).sort((a,b) => {
                    if (a === 'null_category') return 1;
                    if (b === 'null_category') return -1;
                    return itemsByCategory[a].name.localeCompare(itemsByCategory[b].name);
                });

                sortedCategories.forEach(categoryId => {
                    const categoryData = itemsByCategory[categoryId];
                    const section = document.createElement('div');
                    section.className = 'inventory-section';
                    section.dataset.categoryId = categoryId;
                    
                    const title = document.createElement('h3');
                    title.className = 'category-title';
                    title.textContent = categoryData.name;
                    section.appendChild(title);

                    const list = document.createElement('ul');

                    // ====================== DÉBUT DE LA CORRECTION ======================
                    // On s'assure de trier les articles de chaque catégorie selon leur
                    // champ 'order' avant de les afficher.
                    categoryData.items.sort((a, b) => a.order - b.order).forEach(item => {
                    // ======================= FIN DE LA CORRECTION =======================
                        const index = inventory.findIndex(invItem => invItem.id === item.id);
                        const li = document.createElement('li');
                        li.dataset.itemId = item.id;
                        li.dataset.index = index;
                        li.draggable = true;
                        
                        let liClasses = 'inventory-item';
                        const quantityValue = parseQuantity(item.quantity);
                        if (item.alert_threshold && quantityValue < item.alert_threshold) {
                            liClasses += ' low-quantity-warning';
                        }
                        li.className = liClasses;

                        // --- Construction robuste du contenu du <li> ---

                        // 1. Section des détails (checkbox, nom)
                        const itemDetails = document.createElement('div');
                        itemDetails.className = 'item-details';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'include-item';
                        checkbox.dataset.index = index;
                        checkbox.checked = item.include;
                        checkbox.style.marginRight = '10px';
                        checkbox.style.transform = 'scale(1.2)';
                        
                        const itemNameSpan = document.createElement('span');
                        itemNameSpan.className = 'inventory-item-name';
                        // On ajoute le data-index ici pour corriger le bug de l'édition
                        itemNameSpan.dataset.index = index; 
                        itemNameSpan.textContent = item.name;

                        itemDetails.appendChild(checkbox);
                        itemDetails.appendChild(itemNameSpan);

                        // 2. Section des contrôles (boutons, inputs)
                        const itemControls = document.createElement('div');
                        itemControls.className = 'item-controls';

                        // Boutons et inputs
                        const btnMinus = document.createElement('button');
                        btnMinus.className = 'btn btn-quantity-change';
                        btnMinus.dataset.itemId = item.id;
                        btnMinus.dataset.amount = '-1';
                        btnMinus.textContent = '-';

                        const quantityInput = document.createElement('input');
                        quantityInput.type = 'text';
                        quantityInput.value = item.quantity;
                        quantityInput.dataset.itemId = item.id;
                        quantityInput.className = 'item-quantity-input';

                        const btnPlus = document.createElement('button');
                        btnPlus.className = 'btn btn-quantity-change';
                        btnPlus.dataset.itemId = item.id;
                        btnPlus.dataset.amount = '1';
                        btnPlus.textContent = '+';
                        
                        const alertLabel = document.createElement('label');
                        alertLabel.style.cssText = 'font-size: 0.8em; color: #7f8c8d; margin-left: 8px;';
                        alertLabel.textContent = 'Alerte:';

                        const thresholdInput = document.createElement('input');
                        thresholdInput.type = 'number';
                        thresholdInput.value = item.alert_threshold !== null ? item.alert_threshold : 2;
                        thresholdInput.dataset.itemId = item.id;
                        thresholdInput.className = 'item-threshold-input';
                        thresholdInput.min = '0';
                        thresholdInput.style.width = '45px';
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn btn-delete';
                        deleteBtn.dataset.itemId = item.id;
                        deleteBtn.textContent = 'Supprimer';

                        // Ajout des contrôles à leur conteneur
                        itemControls.append(btnMinus, quantityInput, btnPlus, alertLabel, thresholdInput, deleteBtn);
                        
                        // 3. Ajout des deux sections principales au <li>
                        li.appendChild(itemDetails);
                        li.appendChild(itemControls);
                        
                        list.appendChild(li);
                    });
                    
                    section.appendChild(list);
                    inventoryDisplay.appendChild(section);
                });

                document.querySelectorAll('.btn-delete').forEach(b => b.addEventListener('click', deleteItem));
                document.querySelectorAll('.item-quantity-input').forEach(i => i.addEventListener('change', updateQuantity));
                document.querySelectorAll('.item-threshold-input').forEach(i => i.addEventListener('change', updateItemThreshold));
                document.querySelectorAll('.include-item').forEach(c => c.addEventListener('change', toggleInclusion));
                document.querySelectorAll('.btn-quantity-change').forEach(b => b.addEventListener('click', changeQuantity));
                document.querySelectorAll('.inventory-item-name').forEach(span => span.addEventListener('click', startEditInventoryItemName));

                updateToggleAllCheckboxState();
            }
            
            function renderShoppingList() {
                // SOLUTION : On récupère l'élément à chaque appel.
                const shoppingListDisplay = document.getElementById('shopping-list-display');

                //console.log("--- Exécution de renderShoppingList ---");
                //console.log("Element 'shoppingListDisplay' frais:", shoppingListDisplay); // DEBUG

                if (!shoppingListDisplay) {
                    console.error("ERREUR: 'shoppingListDisplay' n'a pas été trouvé dans le DOM au moment du rendu.");
                    return;
                }

                shoppingListDisplay.innerHTML = '';
                if (!localStorage.getItem('authToken')) {
                    shoppingListDisplay.innerHTML = "<p>Connectez-vous pour gérer votre liste.</p>"; return;
                }
                if (shoppingList.length === 0) {
                    shoppingListDisplay.innerHTML = "<p>Votre liste d'épicerie est vide.</p>"; return;
                }
                const list = document.createElement('ul');
                shoppingList.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'shopping-list-item'; li.dataset.itemId = item.id;
                    li.innerHTML = `
                        <div class="item-details"><span class="item-name">${item.name} (Qté: ${item.quantity})</span></div>
                        <div class="shopping-item-controls">
                            <button class="btn btn-move" data-item-id="${item.id}">Ajouter à l'inventaire</button>
                            <button class="btn btn-delete-shopping" data-item-id="${item.id}">Supprimer</button>
                        </div>`;
                    list.appendChild(li);
                });
                shoppingListDisplay.appendChild(list);
                attachShoppingListListeners();
                //console.log("--- Fin de renderShoppingList ---");
            }

            function renderRecipeBook() {
                // SOLUTION : On récupère l'élément à chaque appel.
                const recipeListDisplay = document.getElementById('recipe-list-display');

                //console.log("--- Exécution de renderRecipeBook ---");
                //console.log("Element 'recipeListDisplay' frais:", recipeListDisplay); // DEBUG

                if (!recipeListDisplay) {
                    console.error("ERREUR: 'recipeListDisplay' n'a pas été trouvé dans le DOM au moment du rendu.");
                    return;
                }

                recipeListDisplay.innerHTML = '';
                if (!localStorage.getItem('authToken')) {
                    recipeListDisplay.innerHTML = "<p>Connectez-vous pour voir vos recettes.</p>"; return;
                }
                if (recipes.length === 0) {
                    recipeListDisplay.innerHTML = '<p>Aucune recette sauvegardée.</p>'; return;
                }
                recipes.forEach((recipe) => {
                    const col = document.createElement('div');
                    col.className = 'col';
                    
                    const card = document.createElement('div');
                    card.className = 'card h-100 shadow-sm recipe-card';
                    card.style.cursor = 'pointer';
                    card.dataset.recipeId = recipe.id;
                    
                    card.innerHTML = `
                        <div class="card-body">
                            <h5 class="card-title">${recipe.name}</h5>
                        </div>
                    `;
                    card.addEventListener('click', () => viewRecipe(recipe.id));
                    
                    col.appendChild(card);
                    recipeListDisplay.appendChild(col);
                });
                //console.log("--- Fin de renderRecipeBook ---");
            }
   
            async function addItem(e) {
                e.preventDefault();
                const categoryId = document.getElementById('itemCategory').value;
                const newItem = {
                    name: document.getElementById('itemName').value.trim(),
                    quantity: document.getElementById('itemQuantity').value.trim(),
                    category: categoryId ? parseInt(categoryId, 10) : null,
                    alert_threshold: 2
                };
                if (!newItem.name) return;

                try {
                    const addedItem = await apiCall('inventory', 'POST', newItem);
                    
                    // --- AMÉLIORATION : Mettre à jour l'état local au lieu de tout recharger ---
                    // La réponse de l'API (`addedItem`) contient maintenant le `category_name` grâce au serializer.
                    inventory.push(addedItem); 
                    renderInventory(); // On redessine juste l'inventaire, c'est instantané.
                    
                    addItemForm.reset();

                } catch (error) { 
                    if (String(error).includes('UNIQUE constraint failed')) {
                        alert("Erreur : L'article existe déjà dans votre inventaire.");
                    } else {
                        alert("Une erreur est survenue lors de l'ajout.");
                    }
                }
            }

            async function deleteItem(e) {
                const itemId = e.currentTarget.dataset.itemId;
                if (!itemId) return;
                try {
                    await apiCall(`inventory/${itemId}`, 'DELETE');
                    inventory = inventory.filter(item => item.id != itemId);
                    renderInventory();
                } catch (error) { console.error("Erreur de suppression:", error); }
            }

            async function updateItem(itemId, dataToUpdate) {
                try {
                    const updatedItem = await apiCall(`inventory/${itemId}`, 'PUT', dataToUpdate);
                    const index = inventory.findIndex(item => item.id == updatedItem.id);
                    if (index !== -1) Object.assign(inventory[index], updatedItem);
                    renderInventory();
                } catch (error) { console.error("Erreur de mise à jour:", error); }
            }

            function updateQuantity(e) { updateItem(e.target.dataset.itemId, { quantity: e.target.value }); }
            function updateItemThreshold(e) { updateItem(e.target.dataset.itemId, { alert_threshold: parseInt(e.target.value, 10) }); }

            async function changeQuantity(e) {
                const button = e.currentTarget;
                const itemId = button.dataset.itemId;
                const amount = parseInt(button.dataset.amount, 10);
                const itemIndex = inventory.findIndex(item => item.id == itemId);
                if (itemIndex === -1) return;
                let currentQuantity = parseQuantity(inventory[itemIndex].quantity);
                if (currentQuantity === Infinity || isNaN(currentQuantity)) {
                    document.querySelector(`.item-quantity-input[data-item-id="${itemId}"]`).focus(); return;
                }
                const newQuantity = Math.max(0, currentQuantity + amount);
                await updateItem(itemId, { quantity: String(newQuantity) });
            }

            async function addShoppingItem(e) {
                e.preventDefault();
                const newItem = {
                    name: document.getElementById('shoppingItemName').value.trim(),
                    quantity: document.getElementById('shoppingItemQuantity').value.trim()
                };
                if (!newItem.name) return;
                try {
                    const addedItem = await apiCall('shopping-list', 'POST', newItem);
                    shoppingList.push(addedItem);
                    renderShoppingList();
                    addShoppingItemForm.reset();
                } catch (error) { console.error("Erreur ajout liste:", error); }
            }

            async function deleteShoppingItem(e) {
                const itemId = e.currentTarget.dataset.itemId;
                if (!itemId) return;
                try {
                    await apiCall(`shopping-list/${itemId}`, 'DELETE');
                    shoppingList = shoppingList.filter(item => item.id != itemId);
                    renderShoppingList();
                } catch (error) { console.error("Erreur suppression liste:", error); }
            }

            async function moveItemToInventory(e) {
                const itemId = e.currentTarget.dataset.itemId;
                const itemToMove = shoppingList.find(item => item.id == itemId);
                if (!itemToMove) return;

                try {
                    // --- DÉBUT DE LA CORRECTION ---
                    // On envoie les données de l'article à l'inventaire SANS spécifier de catégorie.
                    // Le backend assignera la catégorie par défaut ou la laissera nulle.
                    // Le champ 'category' attend un ID, pas un nom. En ne l'envoyant pas, on évite l'erreur.
                    const newItemData = { 
                        name: itemToMove.name, 
                        quantity: itemToMove.quantity 
                        // Pas de 'category: "Épicerie"' ici !
                    };
                    
                    // On ajoute d'abord à l'inventaire
                    const addedToInventory = await apiCall('inventory', 'POST', newItemData);
                    
                    // Ensuite, on supprime de la liste d'épicerie
                    await apiCall(`shopping-list/${itemId}`, 'DELETE');
                    
                    // On met à jour l'état local au lieu de tout recharger
                    inventory.push(addedToInventory);
                    shoppingList = shoppingList.filter(item => item.id != itemId);
                    
                    renderInventory();
                    renderShoppingList();
                    // --- FIN DE LA CORRECTION ---

                } catch (error) { 
                    // Affiche une alerte plus utile si l'article existe déjà
                    if (String(error).includes('UNIQUE constraint failed')) {
                        alert("Erreur: Cet article existe déjà dans votre inventaire.");
                    } else {
                        alert("Une erreur est survenue lors du déplacement de l'article.");
                    }
                }
            }

            async function handleRecipeFormSubmit(e) {
                e.preventDefault();
                const recipeData = {
                    name: document.getElementById('recipe-name').value,
                    ingredients: document.getElementById('recipe-ingredients').value,
                    instructions: document.getElementById('recipe-instructions').value,
                    comments: document.getElementById('recipe-comments').value,
                };
                const recipeId = document.getElementById('recipe-id').value;
                try {
                    if (recipeId) await apiCall(`recipes/${recipeId}`, 'PUT', recipeData);
                    else await apiCall('recipes', 'POST', recipeData);
                    closeRecipeFormModal();
                    await loadServerData();
                } catch (error) { console.error("Erreur sauvegarde recette:", error); }
            }

            async function deleteRecipe(recipeId) {
                if (confirm("Supprimer cette recette?")) {
                    try {
                        await apiCall(`recipes/${recipeId}`, 'DELETE');
                        closeRecipeViewModal();
                        await loadServerData();
                    } catch (error) { console.error("Erreur suppression recette:", error); }
                }
            }

            function startEditInventoryItemName(e) {
                const span = e.target;
                const index = span.dataset.index;
                const currentName = inventory[index].name;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentName;
                input.className = 'edit-inventory-name';
                
                span.parentElement.replaceChild(input, span);
                input.focus();
                
                const save = () => {
                    const newName = input.value.trim();
                    if (newName) {
                        inventory[index].name = newName;
                        saveInventory();
                    }
                    renderInventory();
                };
                
                input.addEventListener('blur', save);
                input.addEventListener('keydown', (evt) => {
                    if (evt.key === 'Enter') {
                        input.blur();
                    } else if (evt.key === 'Escape') {
                        renderInventory(); // Annule l'édition
                    }
                });
            }            

            // --- FONCTIONS IA ET PROMPTS ---
            function displayPrompt(promptText) {
                promptOutputTextarea.value = promptText;
                promptOutputSection.style.display = 'block';
                promptOutputSection.scrollIntoView({ behavior: 'smooth', block: 'end' });
                promptOutputTextarea.focus();
                promptOutputTextarea.select();
            }
            
            function generateRecipePrompt() {
                const includedItems = inventory.filter(item => item.include);
                const useFlyerDeals = document.getElementById('useFlyerDeals').checked;

                if (includedItems.length === 0 && !useFlyerDeals) {
                    alert("Veuillez sélectionner au moins un ingrédient de votre inventaire ou cocher l'option pour utiliser les articles en rabais.");
                    return;
                }

                const includeExtra = document.getElementById('includeExtraIngredients').checked;
                const noOven = document.getElementById('recipeCatNoOven').checked;
                const noCook = document.getElementById('recipeCatNoCook').checked;
                const quickMeal = document.getElementById('recipeCatQuick').checked;
                const ingredientNames = includedItems.map(item => item.name).join(', ');

                let promptText = 'Propose-moi une recette simple. ';
                if(includedItems.length > 0) { promptText += `Voici les ingrédients que je possède : ${ingredientNames}. `; }

                if (useFlyerDeals) {
                    const flyerData = JSON.parse(localStorage.getItem('flyerData')) || {};
                    const flyerItems = new Set();
                    Object.values(flyerData).forEach(itemList => {
                        itemList.forEach(item => {
                            const cleanName = item.name.split(/, | \/ | \(/)[0].trim();
                            if(cleanName) flyerItems.add(cleanName);
                        });
                    });
                    if (flyerItems.size > 0) { promptText += `Je souhaite aussi utiliser des articles en rabais cette semaine. Voici quelques exemples : ${[...flyerItems].join(', ')}. `; }
                }

                if (includeExtra) { 
                    promptText += `Tu peux suggérer 1 ou 2 ingrédients de base supplémentaires à acheter pour compléter la recette. `;
                } else { 
                    promptText += `Essaie de créer une recette qui utilise UNIQUEMENT les ingrédients mentionnés (ceux de mon inventaire et/ou ceux en rabais). `; 
                }
                
                let cookingConstraints = [];
                if (noCook) {
                    cookingConstraints.push("ne nécessite aucune cuisson (pas de four, pas de cuisinière)");
                } else if (noOven) {
                    cookingConstraints.push("n'utilise que la cuisinière (les ronds), pas le four");
                }
                
                if (quickMeal) {
                    cookingConstraints.push("doit pouvoir être préparée en moins de 30 minutes");
                }

                if (cookingConstraints.length > 0) {
                    promptText += `La recette doit respecter les contraintes suivantes : ${cookingConstraints.join(' et ')}. `;
                }

                promptText += "Présente la recette avec la liste complète des ingrédients (en indiquant clairement lesquels je dois acheter) et les instructions.";
                displayPrompt(promptText);
            }

            function generateShoppingListPrompt() {
                const numPeople = document.getElementById('numPeople').value;
                const mealsList = document.getElementById('mealsList').value.trim();
                if (mealsList === '') { alert("Veuillez entrer au moins un repas à préparer."); return; }
                if (parseInt(numPeople, 10) < 1) { alert("Veuillez entrer un nombre de personnes valide."); return; }
                const currentInventory = inventory.map(item => `${item.name} (${item.quantity})`).join(', ');
                const promptText = `Agis comme un assistant de liste d'épicerie. Je veux préparer les repas suivants pour ${numPeople} personne(s) :\n\n${mealsList}\n\nVoici les ingrédients que je possède déjà dans mon inventaire :\n${currentInventory}\n\nCrée une liste d'épicerie qui contient uniquement les ingrédients manquants. Fournis la réponse sous forme de tableau JSON. Chaque objet doit avoir une clé "name" (string) et "quantity" (string). N'ajoute aucun texte avant ou après le tableau JSON.\n\nExemple de format attendu:\n[{"name": "Oignons", "quantity": "2"}, {"name": "Ail", "quantity": "1 tête"}]`;
                displayPrompt(promptText);
            }

            function importRecipeDataFromJson() {
                const jsonString = document.getElementById('recipe-json-input').value.trim();
                 if (jsonString === '') { alert("Veuillez coller le texte JSON dans la zone prévue."); return; }
                try {
                    const recipeData = JSON.parse(jsonString);
                    const { name, ingredients, instructions, comments } = recipeData;
                    
                    if (!name || !ingredients || !instructions) {
                         throw new Error("Le JSON est incomplet. Les clés 'name', 'ingredients', et 'instructions' sont requises.");
                    }
                    
                    document.getElementById('recipe-name').value = name || '';
                    document.getElementById('recipe-ingredients').value = ingredients || '';
                    document.getElementById('recipe-instructions').value = instructions || '';
                    document.getElementById('recipe-comments').value = comments || '';

                    alert("Les champs ont été remplis avec succès !");

                } catch (error) {
                    alert("Erreur lors de l'importation : " + error.message);
                    console.error("Erreur de parsing JSON pour recette:", error);
                }
            }

            function importShoppingListData() {
                const jsonString = importShoppingListTextarea.value.trim();
                if (jsonString === '') { alert("Veuillez coller le texte JSON dans la zone prévue."); return; }
                try {
                    const itemsToImport = JSON.parse(jsonString);
                    if (!Array.isArray(itemsToImport)) { throw new Error("Le JSON doit être un tableau (Array)."); }
                    const validItems = itemsToImport.filter(item => item && typeof item.name === 'string' && typeof item.quantity === 'string');
                    if (validItems.length !== itemsToImport.length) { alert("Certains objets dans le JSON sont mal formatés. Chaque objet doit avoir des clés 'name' et 'quantity'."); }
                    shoppingList.push(...validItems);
                    saveShoppingList(); renderShoppingList();
                    importShoppingListTextarea.value = '';
                    alert(`${validItems.length} article(s) importé(s) avec succès !`);
                } catch (error) {
                    alert("Erreur lors de l'importation. Veuillez vérifier que le texte est un JSON valide et correspond au format attendu.");
                    console.error("Erreur de parsing JSON:", error);
                }
            }
            
            function addLowStockItemsToShoppingList() {
                const lowStockItems = inventory.filter(item => {
                    const quantity = parseQuantity(item.quantity);
                    // Assurez-vous d'utiliser le bon nom de champ de l'API: alert_threshold
                    return item.alert_threshold && quantity < item.alert_threshold;
                });

                if (lowStockItems.length === 0) {
                    alert("Aucun article n'est actuellement en pénurie selon vos seuils d'alerte.");
                    return;
                }

                let itemsToAddPromises = [];
                let itemsSkippedCount = 0;

                lowStockItems.forEach(lowItem => {
                    // Vérifie si l'article est déjà dans la liste d'épicerie (côté client)
                    const alreadyInList = shoppingList.some(shopItem => shopItem.name.trim().toLowerCase() === lowItem.name.trim().toLowerCase());
                    
                    if (!alreadyInList) {
                        const newItem = {
                            name: lowItem.name,
                            quantity: '1' // Quantité par défaut à ajouter
                        };
                        // On prépare l'appel API mais on ne l'attend pas encore
                        itemsToAddPromises.push(apiCall('shopping-list', 'POST', newItem));
                    } else {
                        itemsSkippedCount++;
                    }
                });

                if (itemsToAddPromises.length === 0) {
                    alert("Tous les articles en pénurie sont déjà dans votre liste d'épicerie.");
                    return;
                }

                // On exécute tous les appels API en parallèle
                Promise.all(itemsToAddPromises)
                    .then(results => {
                        alert(`${results.length} article(s) en pénurie ont été ajouté(s) à votre liste d'épicerie.`);
                        // On recharge les données du serveur pour être sûr que tout est à jour
                        loadServerData();
                    })
                    .catch(error => {
                        console.error("Erreur lors de l'ajout d'articles en pénurie:", error);
                        alert("Une erreur est survenue lors de l'ajout des articles.");
                    });
            }

            // --- FONCTIONS DE GESTION DES ANCIENNES DONNÉES ---
            function viewOldInventory() {
                // La clé 'inventory' est celle que nous utilisions avant la migration
                const oldInventoryData = JSON.parse(localStorage.getItem('inventory'));
                
                if (!oldInventoryData || oldInventoryData.length === 0) {
                    oldDataContent.innerHTML = "<p>Aucune donnée d'inventaire local n'a été trouvée.</p>";
                } else {
                    let html = '<ul>';
                    oldInventoryData.forEach(item => {
                        html += `<li><strong>${item.name}</strong> (Quantité: ${item.quantity}, Catégorie: ${item.category})</li>`;
                    });
                    html += '</ul>';
                    oldDataContent.innerHTML = html;
                }
                viewOldDataModal.style.display = 'block';
            }

            function exportOldInventory() {
                const oldInventoryData = localStorage.getItem('inventory');
                if (!oldInventoryData) {
                    alert("Aucune donnée d'inventaire local à exporter.");
                    return;
                }
                
                const blob = new Blob([oldInventoryData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'inventaire_local_backup.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert("Votre fichier d'inventaire local a été téléchargé !");
            }
            
            function exportServerInventory() {
                if (!localStorage.getItem('authToken')) {
                    alert("Veuillez vous connecter pour exporter votre inventaire.");
                    return;
                }

                if (!inventory || inventory.length === 0) {
                    alert("Votre inventaire utilisateur est vide.");
                    return;
                }

                // On crée une copie propre des données pour l'export
                const dataToExport = JSON.stringify(inventory, null, 2);
                
                const blob = new Blob([dataToExport], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const date = new Date().toISOString().slice(0, 10);
                a.download = `inventaire_utilisateur_${date}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            async function handleFileImport(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const itemsToImport = JSON.parse(e.target.result);
                        if(!Array.isArray(itemsToImport)) {
                            throw new Error("Le fichier JSON doit contenir un tableau (une liste) d'articles.");
                        }
                        
                        // On vérifie si l'utilisateur est connecté
                        if (!localStorage.getItem('authToken')) {
                            alert("Veuillez vous connecter avant d'importer un inventaire.");
                            return;
                        }

                        // On appelle la nouvelle API
                        const result = await apiCall('inventory/import', 'POST', itemsToImport);
                        alert(`${result.message}\n- ${result.articles_ajoutes} article(s) ajouté(s)\n- ${result.articles_mis_a_jour} article(s) mis à jour`);
                        
                        // On rafraîchit la liste de l'inventaire pour voir les changements
                        loadServerData(); 
                    } catch (error) {
                        alert("Erreur lors de l'importation : " + error.message);
                        console.error(error);
                    } finally {
                        // Réinitialise l'input pour pouvoir réimporter le même fichier si besoin
                        inventoryFileInput.value = '';
                    }
                };
                reader.readAsText(file);
            }

            // --- FONCTIONS DES MODALES ET UTILITAIRES ---
            function openRecipeFormModal(recipeId = null) {
                recipeForm.reset();
                document.getElementById('recipe-json-input').value = '';
                if (recipeId !== null) {
                    const recipe = recipes.find(r => r.id == recipeId);
                    if (recipe) {
                        document.getElementById('recipe-modal-title').textContent = "Éditer la recette";
                        document.getElementById('recipe-id').value = recipe.id;
                        document.getElementById('recipe-name').value = recipe.name;
                        document.getElementById('recipe-ingredients').value = recipe.ingredients;
                        document.getElementById('recipe-instructions').value = recipe.instructions;
                        document.getElementById('recipe-comments').value = recipe.comments;
                    }
                } else {
                    document.getElementById('recipe-modal-title').textContent = "Ajouter une Recette";
                    document.getElementById('recipe-id').value = '';
                }
                recipeFormModal.style.display = 'block';
            }

            function closeRecipeFormModal() { recipeFormModal.style.display = 'none'; }
            function closeRecipeViewModal() { recipeViewModal.style.display = 'none'; }

            function viewRecipe(recipeId) {
                const recipe = recipes.find(r => r.id == recipeId);
                if (!recipe) return;
                document.getElementById('recipe-view-title').textContent = recipe.name;
                document.getElementById('recipe-view-ingredients').textContent = recipe.ingredients || "N/A";
                document.getElementById('recipe-view-instructions').textContent = recipe.instructions || "N/A";
                document.getElementById('recipe-view-comments').textContent = recipe.comments || "N/A";
                const footer = document.getElementById('recipe-view-footer');
                footer.innerHTML = `
                    <button class="btn btn-success" id="add-ingredients-btn">Ajouter ingrédients à la liste</button>
                    <button class="btn btn-warning" id="edit-recipe-btn">Éditer</button>
                    <button class="btn btn-danger" id="delete-recipe-btn">Supprimer</button>`;
                footer.querySelector('#add-ingredients-btn').addEventListener('click', () => addRecipeIngredientsToShoppingList(recipe.id));
                footer.querySelector('#edit-recipe-btn').addEventListener('click', () => { closeRecipeViewModal(); openRecipeFormModal(recipe.id); });
                footer.querySelector('#delete-recipe-btn').addEventListener('click', () => deleteRecipe(recipe.id));
                recipeViewModal.style.display = 'block';
            }

            async function addRecipeIngredientsToShoppingList(recipeId) {
                const recipe = recipes.find(r => r.id == recipeId);
                if (!recipe || !recipe.ingredients) {
                    alert("Cette recette n'a pas d'ingrédients à ajouter.");
                    return;
                }

                // Sépare les ingrédients par ligne et enlève les lignes vides
                const ingredients = recipe.ingredients.split('\n').filter(line => line.trim() !== '');
                if (ingredients.length === 0) {
                    alert("Aucun ingrédient trouvé dans cette recette.");
                    return;
                }

                if (!confirm(`Voulez-vous ajouter ${ingredients.length} ingrédient(s) à votre liste d'épicerie ?`)) {
                    return;
                }

                const itemsToAddPromises = [];
                let itemsSkippedCount = 0;

                ingredients.forEach(ingredientName => {
                    const cleanedName = ingredientName.split('(')[0].trim();

                    // Vérifie si l'article est déjà dans la liste (insensible à la casse)
                    const alreadyInList = shoppingList.some(shopItem =>
                        shopItem.name.trim().toLowerCase() === cleanedName.toLowerCase()
                    );

                    if (!alreadyInList) {
                        const newItem = {
                            name: cleanedName,
                            quantity: '1' // Quantité par défaut
                        };
                        itemsToAddPromises.push(apiCall('shopping-list', 'POST', newItem));
                    } else {
                        itemsSkippedCount++;
                    }
                });

                if (itemsToAddPromises.length === 0) {
                    alert("Tous les ingrédients de cette recette sont déjà dans votre liste d'épicerie.");
                    return;
                }

                try {
                    await Promise.all(itemsToAddPromises);
                    alert(`${itemsToAddPromises.length} ingrédient(s) ont été ajouté(s) avec succès.`);
                    if (itemsSkippedCount > 0) {
                        //console.log(`${itemsSkippedCount} ingrédient(s) étaient déjà dans la liste et n'ont pas été ajoutés.`);
                    }
                    loadServerData(); // Recharge les données pour voir la liste à jour
                } catch (error) {
                    console.error("Erreur lors de l'ajout des ingrédients:", error);
                    alert("Une erreur est survenue lors de l'ajout des ingrédients.");
                } finally {
                    closeRecipeViewModal(); // Ferme la modale après l'opération
                }
            }

            function toggleInclusion(e) {
                inventory[e.target.dataset.index].include = e.target.checked;
                updateToggleAllCheckboxState();
            }
            function toggleAll(e) {
                inventory.forEach(item => item.include = e.target.checked);
                renderInventory();
            }
            function updateToggleAllCheckboxState() {
                toggleAllCheckbox.checked = inventory.length > 0 && inventory.every(item => item.include);
            }
            function parseQuantity(q) {
                const match = String(q).match(/^[xX]?(\d+)/);
                return match ? parseInt(match[1], 10) : Infinity;
            }
            function copyToClipboard(element, button) {
                element.select();
                document.execCommand('copy');
                const originalText = button.textContent;
                button.textContent = 'Copié!';
                setTimeout(() => { button.textContent = originalText; }, 2000);
            }

            function attachStaticListeners() {
                const addCategoryBtn = document.getElementById('add-category-btn');
                if (addCategoryBtn) {
                    addCategoryBtn.replaceWith(addCategoryBtn.cloneNode(true));
                    document.getElementById('add-category-btn').addEventListener('click', handleAddNewCategory);
                }

                const addItemForm = document.getElementById('addItemForm');
                if (addItemForm) {
                    addItemForm.addEventListener('submit', addItem);
                }
            }
                
            // --- PARTIE 3 : INITIALISATION ET ATTACHEMENT DES ÉVÉNEMENTS (LA PARTIE CORRIGÉE) ---
            function attachShoppingListListeners() {
                document.querySelectorAll('.btn-delete-shopping').forEach(b => b.addEventListener('click', deleteShoppingItem));
                document.querySelectorAll('.btn-move').forEach(b => b.addEventListener('click', moveItemToInventory));
            }

            // Préréglage de la disposition idéale pour la page de l'assistant
            const ASSISTANT_LAYOUT_PRESET = [
                { 'gs-id': 'inventory-widget',       w: 8, h: 6, x: 0, y: 0 },
                { 'gs-id': 'shopping-list-widget',   w: 8, h: 5, x: 0, y: 6 },
                { 'gs-id': 'tools-widget',           w: 4, h: 7, x: 8, y: 0 },
                { 'gs-id': 'recipe-book-widget',     w: 4, h: 5, x: 8, y: 6 },
                { 'gs-id': 'generate-list-widget',   w: 6, h: 5, x: 0, y: 11 },
                { 'gs-id': 'recipe-generator-widget',w: 6, h: 5, x: 6, y: 11 },
            ];

            /**
             * Applique une disposition prédéfinie à la grille.
             * @param {Array} preset Le tableau d'objets définissant la disposition.
             */
            function applyLayoutPreset(preset) {
                if (!grid) return;

                // On désactive temporairement les événements pour éviter des sauvegardes multiples
                grid.batchUpdate();
                preset.forEach(itemPreset => {
                    const element = document.querySelector(`.grid-stack-item[gs-id='${itemPreset['gs-id']}']`);
                    if (element) {
                        grid.update(element, itemPreset);
                    }
                });
                // On réactive les événements et on déclenche le rendu
                grid.commit();
            }

            function initializeApp() {
                console.log("Initialisation de l'application...");

                initializeGrid();
                        
                // ÉTAPE 1 (CORRIGÉE) : On capture d'abord TOUS les éléments du DOM
                // On regroupe toutes les assignations ici pour être certain de ne rien manquer.
                inventoryDisplay = document.getElementById('inventory-display');
                shoppingListDisplay = document.getElementById('shopping-list-display');
                recipeListDisplay = document.getElementById('recipe-list-display');
                
                addItemForm = document.getElementById('addItemForm');
                addShoppingItemForm = document.getElementById('addShoppingItemForm');
                
                promptOutputSection = document.getElementById('prompt-output-section');
                promptOutputTextarea = document.getElementById('prompt-output-textarea');
                importShoppingListTextarea = document.getElementById('importShoppingListTextarea');
                
                recipeFormModal = document.getElementById('recipe-form-modal');
                recipeViewModal = document.getElementById('recipe-view-modal');
                recipeModalTitle = document.getElementById('recipe-modal-title');
                
                viewOldDataModal = document.getElementById('view-old-data-modal');
                oldDataContent = document.getElementById('old-data-content');
                
                toggleAllCheckbox = document.getElementById('toggleAll');
                generateShoppingListBtn = document.getElementById('generateShoppingListBtn');
                copyPromptBtn = document.getElementById('copy-prompt-btn');
                addLowStockItemsBtn = document.getElementById('addLowStockItemsBtn');
                importShoppingListBtn = document.getElementById('importShoppingListBtn');
                generateRecipeBtn = document.getElementById('generateRecipeBtn');
                showAddRecipeBtn = document.getElementById('show-add-recipe-modal-btn');
                closeRecipeFormBtn = document.getElementById('close-recipe-form-modal');
                closeRecipeViewBtn = document.getElementById('close-recipe-view-modal');
                recipeForm = document.getElementById('recipe-form');
                copyRecipePromptBtn = document.getElementById('copy-recipe-prompt-btn');
                importRecipeJsonBtn = document.getElementById('import-recipe-json-btn');
                viewOldInventoryBtn = document.getElementById('view-old-inventory-btn');
                exportInventoryBtn = document.getElementById('export-inventory-btn');
                importInventoryBtn = document.getElementById('import-inventory-btn');
                inventoryFileInput = document.getElementById('inventory-file-input');
                closeOldDataModalBtn = document.getElementById('close-old-data-modal');
                autoArrangeBtn = document.getElementById('auto-arrange-btn');
                reorganizeBtn = document.getElementById('reorganize-layout-btn');
                compactBtn = document.getElementById('compact-layout-btn');
                addCategoryBtn = document.getElementById('add-category-btn');

                document.body.addEventListener('dragstart', function(e) {
                    const item = e.target.closest('.inventory-item');
                    if (item) {
                        draggedItemId = item.dataset.itemId;
                        console.log(`[DRAG-DEBUG] dragstart pour item ID: ${draggedItemId}`);
                        // On ajoute la classe 'dragging' pour le retour visuel
                        setTimeout(() => item.classList.add('dragging'), 0);
                    }
                });

                document.body.addEventListener('dragover', function(e) {
                    const section = e.target.closest('.inventory-section');
                    if (section) {
                        e.preventDefault(); // Nécessaire pour autoriser le 'drop'
                        
                        // Logique pour le retour visuel (survol)
                        document.querySelectorAll('.inventory-item.drag-over, .inventory-section.drag-over').forEach(el => el.classList.remove('drag-over'));
                        const targetItem = e.target.closest('.inventory-item');
                        if (targetItem && targetItem.dataset.itemId !== draggedItemId) {
                            targetItem.classList.add('drag-over');
                        } else {
                            section.classList.add('drag-over');
                        }
                    }
                });

                document.body.addEventListener('dragleave', function(e) {
                    e.target.closest('.inventory-item')?.classList.remove('drag-over');
                    e.target.closest('.inventory-section')?.classList.remove('drag-over');
                });

                document.body.addEventListener('drop', async function(e) {
                    const dropSectionTarget = e.target.closest('.inventory-section');
                    if (!draggedItemId || !dropSectionTarget) {
                        return;
                    }
                    e.preventDefault();
                    console.log(`[DRAG-DEBUG] drop détecté sur la section:`, dropSectionTarget.querySelector('.category-title').textContent.trim());

                    const draggedElement = document.querySelector(`.inventory-item[data-item-id='${draggedItemId}']`);
                    if (!draggedElement) return;

                    const dropItemTarget = e.target.closest('.inventory-item');
                    const targetList = dropSectionTarget.querySelector('ul');

                    // Mettre à jour le DOM immédiatement
                    if (dropItemTarget) {
                        targetList.insertBefore(draggedElement, dropItemTarget);
                    } else {
                        targetList.appendChild(draggedElement);
                    }

                    // Préparer et envoyer les données à l'API
                    const orderedItemIds = Array.from(targetList.querySelectorAll('.inventory-item')).map(item => parseInt(item.dataset.itemId, 10));
                    const targetCategoryIdStr = dropSectionTarget.dataset.categoryId;
                    const targetCategoryId = (targetCategoryIdStr === 'null_category' || !targetCategoryIdStr) ? null : parseInt(targetCategoryIdStr, 10);
                    
                    console.log(`[DRAG-DEBUG] Envoi à l'API:`, { category_id: targetCategoryId, ordered_ids: orderedItemIds });

                    try {
                        await apiCall('inventory/reorder', 'POST', {
                            category_id: targetCategoryId,
                            ordered_ids: orderedItemIds
                        });
                        console.log("[DRAG-DEBUG] API a répondu avec succès. Rechargement des données.");
                        await loadServerData(); // Resynchroniser l'état
                    } catch (error) {
                        console.error("[DRAG-DEBUG] Erreur API:", error);
                        alert("Une erreur est survenue. L'affichage va être rechargé.");
                        window.location.reload();
                    }
                });

                document.body.addEventListener('dragend', function(e) {
                    // Nettoyer toutes les classes de style du drag-and-drop
                    document.querySelectorAll('.dragging, .drag-over').forEach(el => el.classList.remove('dragging', 'drag-over'));
                    draggedItemId = null;
                    console.log("[DRAG-DEBUG] dragend");
                });

                // Cela capture le clic quel que soit l'état de GridStack
                document.body.addEventListener('click', function(e) {
                    // On vérifie si l'élément cliqué (ou son parent) est le bouton d'ajout
                    const btn = e.target.closest('#show-add-recipe-modal-btn');
                    if (btn) {
                        e.preventDefault(); // Empêche le comportement par défaut si nécessaire
                        openRecipeFormModal();
                    }
                });
                
                // --- GESTION DÉLÉGUÉE POUR LES OUTILS D'INVENTAIRE ---
                document.body.addEventListener('click', function(e) {
                    // 1. Bouton "Voir l'inventaire local"
                    if (e.target.closest('#view-old-inventory-btn')) {
                        e.preventDefault();
                        viewOldInventory();
                    }
                    
                    // 2. Bouton "Exporter" (Local)
                    if (e.target.closest('#export-inventory-btn')) {
                        e.preventDefault();
                        exportOldInventory();
                    }

                    // 3. Bouton "Exporter" (Serveur / Utilisateur)
                    if (e.target.closest('#export-server-inventory-btn')) {
                        e.preventDefault();
                        exportServerInventory();
                    }
                    
                    // 4. Bouton "Importer"
                    if (e.target.closest('#import-inventory-btn')) {
                        e.preventDefault();
                        // Important : On cherche l'input file FRAIS dans le DOM actuel
                        const currentFileInput = document.getElementById('inventory-file-input');
                        if (currentFileInput) currentFileInput.click();
                    }
                });

                // 4. Gestion de l'input file (événement 'change' délégué)
                document.body.addEventListener('change', function(e) {
                    if (e.target.id === 'inventory-file-input') {
                        handleFileImport(e);
                    }
                });

                // ÉTAPE 3 : On attache tous les écouteurs d'événements
                if (addShoppingItemForm) addShoppingItemForm.addEventListener('submit', addShoppingItem);
                if (toggleAllCheckbox) toggleAllCheckbox.addEventListener('change', toggleAll);
                if (generateShoppingListBtn) generateShoppingListBtn.addEventListener('click', generateShoppingListPrompt);
                if (copyPromptBtn) copyPromptBtn.addEventListener('click', () => copyToClipboard(promptOutputTextarea, copyPromptBtn));
                if (addLowStockItemsBtn) addLowStockItemsBtn.addEventListener('click', addLowStockItemsToShoppingList);
                if (importShoppingListBtn) importShoppingListBtn.addEventListener('click', importShoppingListData);
                if (generateRecipeBtn) generateRecipeBtn.addEventListener('click', generateRecipePrompt);
                if (closeRecipeFormBtn) closeRecipeFormBtn.addEventListener('click', closeRecipeFormModal);
                if (closeRecipeViewBtn) closeRecipeViewBtn.addEventListener('click', closeRecipeViewModal);
                if (recipeForm) recipeForm.addEventListener('submit', handleRecipeFormSubmit);
                if (copyRecipePromptBtn) copyRecipePromptBtn.addEventListener('click', () => copyToClipboard(document.getElementById('ai-recipe-prompt'), copyRecipePromptBtn));
                if (importRecipeJsonBtn) importRecipeJsonBtn.addEventListener('click', importRecipeDataFromJson);

                attachStaticListeners();
                
                if (reorganizeBtn) {
                    reorganizeBtn.addEventListener('click', (e) => { e.preventDefault(); applyLayoutPreset(ASSISTANT_LAYOUT_PRESET); });
                }
                if (compactBtn) {
                    compactBtn.addEventListener('click', (e) => { e.preventDefault(); if (grid) grid.compact(); });
                }
                if (closeOldDataModalBtn) closeOldDataModalBtn.addEventListener('click', () => viewOldDataModal.style.display = 'none');

                window.addEventListener('click', e => {
                    if (e.target == recipeFormModal) closeRecipeFormModal();
                    if (e.target == recipeViewModal) closeRecipeViewModal();
                    if (e.target == viewOldDataModal) viewOldDataModal.style.display = 'none';
                });

                // Attachement des écouteurs pour le Drag and Drop
                if (shoppingListDisplay) {
                    shoppingListDisplay.addEventListener('dragstart', (e) => { if (e.target.classList.contains('shopping-list-item')) { draggedShoppingItemIndex = parseInt(e.target.dataset.index, 10); setTimeout(() => { e.target.classList.add('dragging'); }, 0); } });
                    shoppingListDisplay.addEventListener('dragover', (e) => { e.preventDefault(); const target = e.target.closest('.shopping-list-item'); if (target && parseInt(target.dataset.index, 10) !== draggedShoppingItemIndex) { document.querySelectorAll('.shopping-list-item.drag-over').forEach(el => el.classList.remove('drag-over')); target.classList.add('drag-over'); } });
                    shoppingListDisplay.addEventListener('dragleave', (e) => { const target = e.target.closest('.shopping-list-item'); if (target) { target.classList.remove('drag-over'); } });
                    shoppingListDisplay.addEventListener('drop', (e) => { e.preventDefault(); const dropTarget = e.target.closest('.shopping-list-item'); if (dropTarget && draggedShoppingItemIndex !== null) { const dropIndex = parseInt(dropTarget.dataset.index, 10); const itemToMove = shoppingList.splice(draggedShoppingItemIndex, 1)[0]; shoppingList.splice(dropIndex, 0, itemToMove); saveShoppingList(); renderShoppingList(); } });
                    shoppingListDisplay.addEventListener('dragend', (e) => { document.querySelectorAll('.shopping-list-item.dragging, .shopping-list-item.drag-over').forEach(el => el.classList.remove('dragging', 'drag-over')); draggedShoppingItemIndex = null; });
                }
            }

            initializeApp();
            // Lancement initial
            loadServerData();
        });
    </script>
{% endblock %}