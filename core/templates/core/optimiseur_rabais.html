{% extends "core/base.html" %}
{% load static %}

{% block title %}Optimiseur de Rabais et Itin√©raire{% endblock %}

{% block head_styles %}
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; background-color: #f4f7f9; color: #333; margin: 0; padding: 0; }
        .content-wrapper { padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        h2 { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;}
        h4 { display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 16px; background-color: #3498db; }
        .btn-small { font-size: 12px; padding: 5px 10px; }
        .btn:hover { background-color: #2980b9; }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .section { margin-bottom: 40px; }
        
        /* --- D√âBUT DE LA SOLUTION ROBUSTE (CSS GRID) --- */
        .optimized-item {
            display: grid;
            grid-template-columns: 1fr auto; /* La 1√®re colonne prend l'espace, la 2√®me s'adapte au contenu */
            grid-template-rows: auto auto; /* 2 rang√©es qui s'adaptent √† la hauteur du contenu */
            grid-template-areas:
                "name price"
                "deals price";
            align-items: center; /* Centre verticalement les √©l√©ments dans leur cellule de grille */
            column-gap: 15px; /* Espace entre les colonnes */
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            cursor: grab;
        }
        .item-name-grid {
            grid-area: name; /* Assigne cet √©l√©ment √† la zone "name" de la grille */
            font-weight: 500;
        }
        .item-deals-grid {
            grid-area: deals; /* Assigne cet √©l√©ment √† la zone "deals" */
            padding-top: 5px;
            font-size: 0.9em;
            color: #7f8c8d;
        }
        .item-deals-grid select {
            width: 100%;
        }
        .item-price-grid {
            grid-area: price; /* Assigne cet √©l√©ment √† la zone "price", qui s'√©tend sur 2 rang√©es */
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        /* --- FIN DE LA SOLUTION ROBUSTE --- */

        .optimized-item.dragging { opacity: 0.5; background-color: #ecf0f1; }
        .optimized-item.drag-over { border-top: 2px solid #3498db; }
        .item-price { color: #27ae60; font-weight: bold; }
        .item-store { font-size: 0.9em; color: #7f8c8d; }
        #route-list { list-style-type: decimal; padding-left: 20px; }
        #route-list li { padding: 8px 0; font-size: 1.1em; color: #34495e; }
        .placeholder { color: #7f8c8d; font-style: italic; }
        .store-item { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 5px; padding: 12px; margin-bottom: 8px; display: flex; align-items: center; }
        .store-item input[type="checkbox"] { margin-right: 12px; transform: scale(1.2); }
        .store-item label { flex-grow: 1; cursor: pointer; }
        .store-name { font-weight: bold; }
        #store-type-filters { margin: 15px 0; padding: 10px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 5px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; }
        #store-type-filters label { cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .store-details { font-size: 0.85em; color: #555; margin-top: 4px; }
        .store-details a { color: #2980b9; text-decoration: none; }
        .store-details a:hover { text-decoration: underline; }
        .store-address { font-size: 0.85em; color: #333; margin-top: 5px; }
        .store-actions { display: flex; flex-direction: column; gap: 5px; align-items: flex-end; }
        .btn-view-flyer { background-color: #9b59b6; font-size: 12px; padding: 5px 10px; margin-top: 5px; }
        .modal { display: none; position: fixed; z-index: 1056; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .modal-header h2 { margin: 0; color: #2c3e50; border-bottom: none; }
        .close-btn, .close-btn-manager, .close-btn-edit { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover, .close-btn:focus, .close-btn-manager:hover, .close-btn-manager:focus, .close-btn-edit:hover, .close-btn-edit:focus { color: black; }
        .flyer-item-list { max-height: 400px; overflow-y: auto; margin-top: 15px; }
        .flyer-item { display: flex; justify-content: space-between; padding: 8px 5px; border-bottom: 1px solid #eee; }
        .flyer-item-name { font-weight: 500; }
        .flyer-item-price { color: #27ae60; }
        .managed-flyer-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid #eee; }
        .btn-delete-flyer { background-color: #e74c3c; }
        .btn-delete-flyer:hover { background-color: #c0392b; }
        .rabais-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        .rabais-item {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            /* --- LIGNES AJOUT√âES --- */
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
            /* --- FIN DES LIGNES AJOUT√âES --- */
        }
        .rabais-item .produit-nom {
            font-weight: bold;
            color: #34495e;
            display: block;
        }
        .rabais-item .commerce-nom {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        .rabais-item .prix-info {
            font-size: 1.2em;
            font-weight: bold;
            color: #27ae60;
            text-align: right;
        }
        
        /* --- NOUVEAUX STYLES POUR L'ACCORD√âON DE RABAIS --- */
        .store-rabais-group {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #fff;
            overflow: hidden; /* Emp√™che le contenu de d√©border lors de l'animation */
            transition: all 0.3s ease-in-out;
        }
        .store-rabais-summary {
            padding: 15px;
            font-weight: bold;
            cursor: pointer;
            color: #34495e;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            list-style: none; /* Cache le marqueur par d√©faut */
        }
        .store-rabais-summary::-webkit-details-marker { display: none; } /* Cache le marqueur sur Chrome/Safari */
        .store-rabais-summary::before { /* Marqueur personnalis√© */
            content: '‚ñ∂';
            margin-right: 10px;
            font-size: 0.8em;
            color: #3498db;
            transition: transform 0.2s ease-in-out;
        }
        .store-rabais-group[open] > .store-rabais-summary::before {
             transform: rotate(90deg);
        }
        .store-rabais-summary:hover {
            background-color: #f8f9fa;
        }
        .deal-count {
            font-size: 0.9em;
            font-weight: normal;
            color: #7f8c8d;
            background-color: #e9ecef;
            padding: 3px 8px;
            border-radius: 12px;
        }
        .store-rabais-group[open] > .store-rabais-summary {
            border-bottom: 1px solid #e9ecef;
        }
        .store-rabais-group .rabais-grid {
            padding: 15px;
        }
        /* --- NOUVEAUX STYLES POUR L'ACCORD√âON DE CAT√âGORIES --- */
        .category-rabais-group {
            margin: 0 15px 10px 15px;
            border: 1px solid #f0f0f0;
            border-radius: 6px;
            background-color: #fcfcfc;
        }
        .category-rabais-summary {
            padding: 10px 15px;
            font-weight: 500; /* Moins gras que le magasin */
            cursor: pointer;
            color: #4a5568; /* Un peu plus clair */
            font-size: 1em;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .category-rabais-summary::-webkit-details-marker { display: none; }
        .category-rabais-summary:hover {
            background-color: #f0f3f5;
        }
        .category-rabais-summary::before {
            content: '‚Ä∫';
            margin-right: 8px;
            font-weight: bold;
            color: #3498db;
            transition: transform 0.2s ease-in-out;
            transform: rotate(0deg);
        }
        .category-rabais-group[open] > .category-rabais-summary::before {
             transform: rotate(90deg);
        }
        .category-rabais-group[open] > .category-rabais-summary {
            border-bottom: 1px solid #e9ecef;
        }
        .container {
            /* On ajuste le conteneur principal pour la grille */
            width: 100%;
            max-width: 1400px !important;
            padding: 0 !important;
            background: transparent !important;
            box-shadow: none !important;
        }
        .grid-stack-item-content {
            /* Style de base pour chaque "widget" */
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: auto !important; /* Permet le d√©filement interne */
            padding: 20px;
            height: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        .grid-stack-item-content section {
            flex-grow: 1; /* Assure que la section remplit le widget */
        }
        .grid-stack-item-content h1, .grid-stack-item-content h2 {
            margin-top: 0;
        }
    </style>
{% endblock %}

{% block content %}

            <div class="grid-stack">
                <!-- WIDGET 1: Rabais Actifs -->
                <div class="grid-stack-item" gs-id="flyer-deals-widget" gs-w="12" gs-h="6" gs-x="0" gs-y="0">
                    <div class="grid-stack-item-content">
                        <section id="flyer-deals-section" class="section">
                            <h2>Rabais Actifs des Circulaires</h2>
                            <input type="search" id="search-rabais-input" class="form-control form-control-lg mb-3" placeholder="Filtrer les rabais par nom de produit...">
                            <div id="rabais-actifs-display">
                                <p class="placeholder">Chargement des rabais en cours...</p>
                            </div>
                        </section>
                    </div>
                </div>
            

                <!-- WIDGET 2: S√©lection des Commerces & Outils -->
                <div class="grid-stack-item" gs-id="store-selection-widget" gs-w="6" gs-h="8" gs-x="0" gs-y="6">
                    <div class="grid-stack-item-content">
                        <section id="store-selection-section" class="section">
                            <!-- Tout le contenu de l'ancienne section "1. S√©lection des Commerces" va ici -->
                            <h2>1. S√©lection des Commerces</h2>
                            <p>Trouvez les magasins √† proximit√© ou ajoutez-les via leur site web ou une circulaire JSON.</p>
                            
                            <div id="store-type-filters">
                                <label><input type="checkbox" class="store-type-filter" value="supermarket" checked> Grandes surfaces</label>
                                <label><input type="checkbox" class="store-type-filter" value="grocery" checked> √âpiceries</label>
                                <label><input type="checkbox" class="store-type-filter" value="convenience" checked> D√©panneurs</label>
                                <label><input type="checkbox" class="store-type-filter" value="pharmacy" checked> Pharmacies</label>
                            </div>
                
                            <div>
                                <button id="findStoresBtn" class="btn btn-primary">
                                    <i class="bi bi-magic"></i> Trouver les commerces √† proximit√©
                                </button>
                                <button id="sortStoresBtn" class="btn btn-primary" style="display: none; background-color: #16a085; margin-left: 10px;">
                                    <i class="bi bi-magic"></i> Trier par distance
                                </button>
                            </div>
                
                            <div id="manual-add-section" style="margin-top: 25px;">
                                <h4>Ajouter un commerce via son site web</h4>
                                <form id="addStoreUrlForm" class="input-group">
                                    <input type="url" id="manualStoreUrl" class="form-control" placeholder="https://www.exemple.com" required>
                                    <button type="submit" class="btn btn-outline-secondary">
                                        <i class="bi bi-plus-lg"></i> Ajouter
                                    </button>
                                </form>
                            </div>

                            <div id="community-add-section" style="margin-top: 25px;">
                                <h4>Contribution Communautaire</h4>
                                <button id="add-deal-btn" class="btn btn-primary" style="background-color: #e67e22;">
                                    <i class="bi bi-magic"></i> Soumettre un rabais
                                </button>
                                <p style="font-size: 0.9em; color: #555;">Aidez la communaut√© en ajoutant un rabais que vous avez vu en magasin ou sur une circulaire.</p>
                            </div>
                            
                            <div id="flyer-import-section" style="margin-top: 25px;">
                                <div id="ai-converter-helper" style="background-color: #e8f4fd; border: 1px solid #d1e9fc; border-radius: 8px; padding: 20px; margin-bottom: 25px;">
                                    <h4>Besoin d'aide pour convertir une circulaire ?</h4>
                                    <p>Utilisez un assistant IA comme Gemini pour transformer automatiquement une circulaire (PDF, image ou site web) en format JSON compatible.</p>
                                    <p><strong>√âtape 1 :</strong> Copiez l'instruction ci-dessous. <br><strong>√âtape 2 :</strong> Ouvrez Gemini, collez l'instruction, puis ajoutez le lien ou le contenu de la circulaire que vous voulez convertir.</p>
                                    
                                    <textarea id="ai-prompt-textarea" rows="12" readonly style="width: 100%; box-sizing: border-box; font-family: monospace; padding: 10px; border-radius: 5px; border: 1px solid #ccc; background-color: #f8f9fa;">
Agis comme un expert en extraction de donn√©es de circulaires d'√©picerie. Ta t√¢che est de transformer les informations d'une circulaire que je vais te fournir en un format JSON structur√©.

Pour les dates, il est imp√©ratif d'utiliser les cl√©s `date_debut` et `date_fin` et de fournir les dates au format `AAAA-MM-JJ`.

Le JSON doit imp√©rativement suivre la structure suivante. Ne fournis aucune explication, commentaire ou texte avant ou apr√®s le bloc de code JSON.

Voici la structure exacte √† respecter :
\`\`\`json
{
"store": "NomDuMagasin",
"address": "123 Rue Principale, Ville, QC",
"website": "https://www.example.com",
"date_debut": "AAAA-MM-JJ",
"date_fin": "AAAA-MM-JJ",
"categories": [
    {
    "category_name": "Nom de la cat√©gorie (ex: √âpicerie, Fruits et l√©gumes)",
    "items": [
        {
        "name": "Nom complet de l'article",
        "brand": "Marque (si disponible)",
        "description": "Description additionnelle",
        "price": "Prix affich√© (ex: 5.99, 2/4.00)",
        "quantity": "Quantit√© ou poids (ex: 500g, Paquet de 2)",
        "unit": "$/lb, l'unit√©, pour 2, etc.",
        "member_price": "Prix membre (si diff√©rent)",
        "regular_price": "Prix r√©gulier (si un rabais est indiqu√©)",
        "single_price": "Prix √† l'unit√© (si un prix de groupe est affich√©, ex: 2.50)",
        "local": true,
        "scene_points": "Points Sc√®ne+ (ou autre programme de points)"
        }
    ]
    }
]
}
\`\`\`

Maintenant, analyse la circulaire que je vais te fournir et g√©n√®re le JSON correspondant.
                                    </textarea>
                                                            
                                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                                        <button id="copy-ai-prompt-btn" class="btn btn-primary" style="background-color: #27ae60;">
                                            <i class="bi bi-magic"></i> Copier l'instruction
                                        </button>
                                        <a href="https://gemini.google.com/app" target="_blank" class="btn btn-primary" style="background-color: #8e44ad; text-decoration: none; text-align: center;">
                                            <i class="bi bi-magic"></i> Ouvrir Gemini
                                        </a>
                                    </div>
                                </div>

                                <h4>
                                    <span>Ajouter une circulaire (JSON)</span>
                                    <button id="manageFlyersBtn" class="btn btn-primary btn-small" style="background-color: #7f8c8d;">
                                        <i class="bi bi-magic"></i> G√©rer les circulaires
                                    </button>
                                </h4>
                                <form id="importFlyerForm">
                                    <p style="margin-top:0; font-size: 0.9em; color: #555;">
                                        Collez ici les donn√©es de la circulaire au format JSON pour l'int√©grer √† l'optimiseur.
                                    </p>
                                    <textarea id="flyerJsonInput" placeholder='{"store": "NomDuMagasin", "categories": [{"items": [...]}]}' style="width: 100%; min-height: 100px; box-sizing: border-box; border: 1px solid #ced4da; border-radius: 4px; padding: 10px; font-family: monospace; margin-bottom: 10px;"></textarea>
                                    <button type="submit" class="btn btn-primary" style="background-color: #8e44ad;">
                                        <i class="bi bi-magic"></i> Int√©grer la circulaire
                                    </button>
                                </form>
                            </div>
                
                            <div id="stores-list-display" style="margin-top: 20px;">
                                <p class="placeholder">La liste des commerces appara√Ætra ici.</p>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- WIDGET 3: Optimisation -->
                <div class="grid-stack-item" gs-id="optimization-widget" gs-w="6" gs-h="5" gs-x="6" gs-y="6">
                    <div class="grid-stack-item-content">
                        <section id="optimization-section" class="section">
                            <h2>
                                <span>2. Optimisation</span>
                                <div>
                                    <button id="findPricesBtn" class="btn btn-primary btn-small" style="background-color: #f39c12; display: none;">
                                        <i class="bi bi-magic"></i> Chercher prix manquants
                                    </button>
                                    <button id="printListBtn" class="btn btn-primary btn-small" style="background-color: #16a085;">
                                        <i class="bi bi-magic"></i> Imprimer la liste
                                    </button>
                                </div>
                            </h2>
                            <p>Comparez votre liste d'√©picerie avec les rabais des commerces s√©lectionn√©s.</p>
                            <button id="optimizeListBtn" class="btn btn-primary">
                                <i class="bi bi-magic"></i> Optimiser ma liste
                            </button>

                            <div id="price-finder-container" style="margin-top: 25px; display: none;">
                                <hr style="margin-bottom: 25px;">
                                <h4><span role="img" aria-label="robot">ü§ñ</span> Trouver les Prix Manquants avec l'IA</h4>
                                <p>Utilisez l'IA pour rechercher le prix r√©gulier des articles sans rabais s√©lectionn√©.</p>
                                
                                <div id="price-finder-prompt-output" style="display: none; background-color: #e8f4fd; border: 1px solid #d1e9fc; border-radius: 8px; padding: 20px; margin-bottom: 25px;">
                                    <p><strong>√âtape 1 :</strong> Copiez l'instruction. <br><strong>√âtape 2 :</strong> Collez-la dans Gemini pour obtenir les prix.</p>
                                    <textarea id="price-finder-prompt-textarea" rows="10" readonly style="width: 100%; box-sizing: border-box; font-family: monospace; padding: 10px; border-radius: 5px; border: 1px solid #ccc; background-color: #f8f9fa;"></textarea>
                                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                                        <button id="copy-price-finder-prompt-btn" class="btn btn-primary" style="background-color: #27ae60;">
                                            <i class="bi bi-magic"></i> Copier l'instruction
                                        </button>
                                        <a href="https://gemini.google.com/app" target="_blank" class="btn btn-primary" style="background-color: #8e44ad; text-decoration: none; text-align: center;">
                                            <i class="bi bi-magic"></i> Ouvrir Gemini
                                        </a>
                                    </div>
                                </div>
                        
                                <div id="price-importer-section">
                                    <p><strong>√âtape 3 :</strong> Collez le JSON fourni par Gemini ci-dessous.</p>
                                    <textarea id="import-prices-json" placeholder='[{"name": "Nom De L&#39;article", "price": 4.99}, ...]' style="width: 100%; min-height: 80px; box-sizing: border-box; border: 1px solid #ced4da; border-radius: 4px; padding: 10px; font-family: monospace; margin-bottom: 10px;"></textarea>
                                    <button id="importPricesBtn" class="btn btn-primary" style="background-color: #16a085;">
                                        <i class="bi bi-magic"></i> Importer les Prix
                                    </button>
                                </div>
                            </div>

                            <div id="optimization-display" style="margin-top: 20px;">
                                <p class="placeholder">Votre liste optimis√©e appara√Ætra ici.</p>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- WIDGET 4: Itin√©raire -->
                <div class="grid-stack-item" gs-id="route-widget" gs-w="6" gs-h="3" gs-x="6" gs-y="11">
                    <div class="grid-stack-item-content">
                        <section id="route-section" class="section">
                            <h2>3. Itin√©raire d'Achat Sugg√©r√©</h2>
                            <p>G√©n√©rez un itin√©raire simple bas√© sur les magasins o√π se trouvent les meilleures offres.</p>
                            <button id="generateRouteBtn" class="btn btn-primary">
                                <i class="bi bi-magic"></i> G√©n√©rer l'itin√©raire
                            </button>
                            <div id="route-display" style="margin-top: 20px;">
                                <p class="placeholder">Votre itin√©raire appara√Ætra ici.</p>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
{% endblock %}

    <div id="flyerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Circulaire</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div id="modal-body" class="flyer-item-list"></div>
        </div>
    </div>
    
    <div id="flyerManagerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-manager-title">G√©rer les Circulaires Sauvegard√©es</h2>
                <span class="close-btn-manager">&times;</span>
            </div>
            <div id="modal-manager-body" class="flyer-item-list"></div>
        </div>
    </div>

    <div id="editStoreModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>√âditer le Commerce</h2>
                <span class="close-btn-edit">&times;</span>
            </div>
            <div id="modal-edit-body">
                <form id="editStoreForm">
                    <input type="hidden" id="originalStoreName">
                    <div style="margin-bottom: 15px;">
                        <label for="editStoreName" style="display: block; margin-bottom: 5px; font-weight: bold;">Nom du commerce</label>
                        <input type="text" id="editStoreName" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="editStoreAddress" style="display: block; margin-bottom: 5px; font-weight: bold;">Adresse</label>
                        <input type="text" id="editStoreAddress" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label for="editStoreWebsite" style="display: block; margin-bottom: 5px; font-weight: bold;">Site web</label>
                        <input type="url" id="editStoreWebsite" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    <div style="text-align: right;">
                        <button type="submit" class="btn btn-primary" style="background-color: #2ecc71;">
                            <i class="bi bi-magic"></i> Sauvegarder
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="submit-price-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Soumettre un Prix R√©gulier</h2>
                <span id="close-price-modal-btn" class="close-btn">&times;</span>
            </div>
            <div id="modal-price-body">
                <p>
                    Vous soumettez un prix pour le produit : 
                    <strong id="modal-product-name"></strong>
                </p>

                <form id="submit-price-form">
                    <!-- Champ cach√© pour garder en m√©moire le nom du produit -->
                    <input type="hidden" id="hidden-product-name">

                    <div style="margin-bottom: 15px;">
                        <label for="modal-store-select" style="display: block; margin-bottom: 5px; font-weight: bold;">
                            Dans quel commerce avez-vous vu ce prix ?
                        </label>
                        <select id="modal-store-select" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                            <option value="">-- Choisissez un commerce --</option>
                            <!-- Les commerces seront ajout√©s ici par JavaScript -->
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label for="modal-price-input" style="display: block; margin-bottom: 5px; font-weight: bold;">
                            Quel est le prix ?
                        </label>
                        <input type="number" id="modal-price-input" step="0.01" min="0" required placeholder="Ex: 4.99" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                    </div>

                    <div style="text-align: right;">
                        <button type="submit" class="btn btn-primary" style="background-color: #2ecc71;">
                            <i class="bi bi-magic"></i> Soumettre
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- ====== D√âBUT DES NOUVELLES MODALES ====== -->
    <!-- ============================================= -->

    <div id="add-product-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Ajouter un Nouveau Produit au Catalogue</h2>
                <span id="close-add-product-modal-btn" class="close-btn">&times;</span>
            </div>
            <div id="modal-add-product-body">
                <p>Le produit "<strong id="new-product-name-display"></strong>" n'a pas √©t√© trouv√©. Veuillez fournir quelques d√©tails pour l'ajouter.</p>
                <form id="add-product-form">
                    <input type="hidden" id="hidden-new-product-name">
                    <div style="margin-bottom: 15px;">
                        <label for="new-product-brand" style="display: block; margin-bottom: 5px; font-weight: bold;">Marque (facultatif)</label>
                        <input type="text" id="new-product-brand" placeholder="Ex: Kraft, St-M√©thode" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    <!-- On pourrait ajouter une s√©lection de cat√©gorie ici plus tard -->
                    <div style="text-align: right;">
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="submit-deal-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Soumettre un Rabais de Circulaire</h2>
                <span id="close-deal-modal-btn" class="close-btn">&times;</span>
            </div>
            <div id="modal-deal-body">
                <form id="submit-deal-form">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label for="deal-product-name" style="font-weight: bold;">Nom du Produit *</label>
                            <input type="text" id="deal-product-name" required placeholder="Ex: Beurre d'arachide">
                        </div>
                        <div>
                            <label for="deal-product-brand" style="font-weight: bold;">Marque</label>
                            <input type="text" id="deal-product-brand" placeholder="Ex: Kraft">
                        </div>
                        <div>
                            <label for="deal-store-select" style="font-weight: bold;">Commerce *</label>
                            <select id="deal-store-select" required></select>
                        </div>
                        <div>
                            <label for="deal-price-details" style="font-weight: bold;">Prix Affich√© *</label>
                            <input type="text" id="deal-price-details" required placeholder="Ex: 2 pour 5.00$">
                        </div>
                         <div>
                            <label for="deal-single-price" style="font-weight: bold;">Prix Unitaire Calcul√© *</label>
                            <input type="number" id="deal-single-price" step="0.01" min="0" required placeholder="Ex: 2.50">
                        </div>
                        <div>
                            <label for="deal-date-debut" style="font-weight: bold;">Date de D√©but du Rabais *</label>
                            <input type="date" id="deal-date-debut" required>
                        </div>
                         <div>
                            <label for="deal-date-fin" style="font-weight: bold;">Date de Fin du Rabais *</label>
                            <input type="date" id="deal-date-fin" required>
                        </div>
                    </div>
                    <style> #submit-deal-form input, #submit-deal-form select { width: 100%; padding: 8px; box-sizing: border-box; margin-top: 5px;} </style>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary" style="background-color: #2ecc71;">
                            <i class="bi bi-magic"></i> Soumettre le Rabais
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="report-price-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Signaler un Prix</h2>
                <span id="close-report-modal-btn" class="close-btn">&times;</span>
            </div>
            <div id="modal-report-body">
                <p>
                    Vous signalez une information pour le produit : 
                    <strong id="report-product-name"></strong>
                </p>
                <form id="report-price-form">
                    <input type="hidden" id="hidden-report-price-id">
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            Quelle est la raison du signalement ? *
                        </label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label><input type="radio" name="report_reason" value="INCORRECT_PRICE" required> Le prix est incorrect</label>
                            <label><input type="radio" name="report_reason" value="WRONG_PRODUCT"> Ce n'est pas le bon produit/commerce</label>
                            <label><input type="radio" name="report_reason" value="EXPIRED_DEAL"> Le rabais est expir√©</label>
                            <label><input type="radio" name="report_reason" value="OTHER"> Autre (pr√©cisez ci-dessous)</label>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label for="report-comments" style="display: block; margin-bottom: 5px; font-weight: bold;">
                            Commentaires (optionnel)
                        </label>
                        <textarea id="report-comments" placeholder="Fournissez plus de d√©tails si n√©cessaire" style="width: 100%; min-height: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"></textarea>
                    </div>

                    <div style="text-align: right;">
                        <button type="submit" class="btn btn-primary" style="background-color: #e74c3c;">
                            <i class="bi bi-magic"></i> Envoyer le signalement
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- ============== FIN DES MODALES ============== -->
    <!-- ============================================= -->

{% block body_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/gridstack@10.2.0/dist/gridstack-all.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- PARTIE 1 : D√âCLARATION DES VARIABLES ---
        // Les variables pour les √©l√©ments du DOM seront assign√©es dans initializePage()
        let findStoresBtn, sortStoresBtn, optimizeListBtn, printListBtn,
            generateRouteBtn, addStoreUrlForm,
            manualStoreUrlInput, importFlyerForm, flyerJsonInput, flyerModal, modalTitle,
            modalBody, closeBtn, manageFlyersBtn, flyerManagerModal, modalManagerBody,
            closeBtnManager, editStoreModal, closeBtnEdit, editStoreForm, copyAiPromptBtn,
            aiPromptTextarea, findPricesBtn, priceFinderContainer, priceFinderPromptOutput,
            priceFinderPromptTextarea, copyPriceFinderPromptBtn, importPricesJsonTextarea,
            importPricesBtn, priceModal, closePriceModalBtn, submitPriceForm, modalProductName,
            hiddenProductNameInput, storeSelect, priceInput, addProductModal,
            closeAddProductModalBtn, addProductForm, newProductNameDisplay,
            hiddenNewProductNameInput, addDealBtn, submitDealModal, closeDealModalBtn,
            submitDealForm, reportPriceModal, closeReportModalBtn, reportPriceForm,
            reportProductName, hiddenReportPriceId, optimizationDisplay;

        // Variables d'√©tat
        let optimizedItems = [];
        let allStores = [];
        let nearbyStores = [];
        let manualStores = [];
        let flyerData = {};
        let activeDeals = [];
        let grid;
        let draggedItemIndex = null;
        const ACCORDION_STATE_KEY = 'optimiseurAccordionStates';

        // --- PARTIE 2 : D√âFINITION DES FONCTIONS ---

        function initializeGrid() {
            grid = GridStack.init({
                float: true,
                cellHeight: '70px',
                minRow: 1,
            });

            grid.on('change', async function (event, items) {
                if (localStorage.getItem('authToken')) {
                    const serializedData = grid.save();
                    try {
                        await apiCall('/api/user/layout/', 'POST', serializedData);
                    } catch (error) {
                        console.error("Erreur de sauvegarde de la disposition:", error);
                    }
                }
            });
        }

        /**
         * Sauvegarde l'√©tat (ouvert/ferm√©) de chaque accord√©on de magasin.
         */
        function saveAccordionStates() {
            const states = {};
            document.querySelectorAll('#rabais-actifs-display .store-rabais-group').forEach(details => {
                const summary = details.querySelector('.store-rabais-summary');
                if (summary && summary.firstChild) {
                    // Extrait le nom du magasin, qui est le premier n≈ìud de texte dans le <summary>
                    const storeName = summary.firstChild.textContent.trim();
                    if (storeName) {
                        states[storeName] = details.open;
                    }
                }
            });
            localStorage.setItem(ACCORDION_STATE_KEY, JSON.stringify(states));
        }

        /**
         * Applique l'√©tat sauvegard√© aux accord√©ons lors du chargement.
         */
        function applyAccordionStates() {
            const savedStates = JSON.parse(localStorage.getItem(ACCORDION_STATE_KEY)) || {};
            document.querySelectorAll('#rabais-actifs-display .store-rabais-group').forEach(details => {
                const summary = details.querySelector('.store-rabais-summary');
                if (summary && summary.firstChild) {
                    const storeName = summary.firstChild.textContent.trim();
                    // Si un √©tat est sauvegard√© pour ce magasin, on l'applique.
                    // Par d√©faut, l'accord√©on restera ferm√© si aucun √©tat n'est trouv√©.
                    if (savedStates.hasOwnProperty(storeName)) {
                        details.open = savedStates[storeName];
                    } else {
                        details.open = false; // Ferm√© par d√©faut
                    }
                }
            });
        }

        function saveFlyerData() { localStorage.setItem('flyerData', JSON.stringify(flyerData)); }
        function loadFlyerData() { flyerData = JSON.parse(localStorage.getItem('flyerData')) || {}; }
        function saveManualStores() { localStorage.setItem('manualStoresList', JSON.stringify(manualStores)); }
        function loadManualStores() { manualStores = JSON.parse(localStorage.getItem('manualStoresList')) || []; }
        
        function openFlyerManagerModal() {
            renderFlyerManagerList();
            flyerManagerModal.style.display = 'block';
        }

        function closeFlyerManagerModal() {
            flyerManagerModal.style.display = 'none';
        }

        function renderFlyerManagerList() {
            modalManagerBody.innerHTML = '';
            const savedFlyers = Object.keys(flyerData);

            if (savedFlyers.length === 0) {
                modalManagerBody.innerHTML = '<p class="placeholder">Aucune circulaire sauvegard√©e.</p>';
                return;
            }

            savedFlyers.sort().forEach(storeName => {
                const itemElement = document.createElement('div');
                itemElement.className = 'managed-flyer-item';
                itemElement.innerHTML = `
                    <span class="flyer-item-name">${storeName}</span>
                    <button class="btn btn-primary btn-small btn-delete-flyer" data-store-name="${storeName}">
                        <i class="bi bi-magic"></i> Supprimer
                    </button>
                `;
                modalManagerBody.appendChild(itemElement);
            });
            
            document.querySelectorAll('.btn-delete-flyer').forEach(button => {
                button.addEventListener('click', deleteFlyerAndStore);
            });
        }
        
        function deleteFlyerAndStore(event) {
            const storeNameToDelete = event.target.dataset.storeName;
            
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer la circulaire et le commerce associ√© "${storeNameToDelete}" ? Cette action est irr√©versible.`)) {
                if (flyerData[storeNameToDelete]) {
                    delete flyerData[storeNameToDelete];
                    saveFlyerData();
                }
                manualStores = manualStores.filter(store => store.name !== storeNameToDelete);
                saveManualStores();
                renderAllStores();
                renderFlyerManagerList();
            }
        }

        function openStoreEditModal(event) {
            const storeNameToEdit = event.target.dataset.storeName;
            const storeData = manualStores.find(s => s.name === storeNameToEdit);
            if (storeData) {
                document.getElementById('originalStoreName').value = storeData.name;
                document.getElementById('editStoreName').value = storeData.name;
                document.getElementById('editStoreAddress').value = storeData.address || '';
                document.getElementById('editStoreWebsite').value = (storeData.website && storeData.website !== '#') ? storeData.website : '';
                editStoreModal.style.display = 'block';
            }
        }

        function closeStoreEditModal() {
            editStoreModal.style.display = 'none';
        }

        function handleStoreEditFormSubmit(event) {
            event.preventDefault();
            const originalName = document.getElementById('originalStoreName').value;
            const newName = document.getElementById('editStoreName').value.trim();
            const newAddress = document.getElementById('editStoreAddress').value.trim();
            const newWebsite = document.getElementById('editStoreWebsite').value.trim();

            if (!newName) {
                alert("Le nom du commerce ne peut pas √™tre vide.");
                return;
            }

            const storeIndex = manualStores.findIndex(s => s.name === originalName);
            if (storeIndex === -1) {
                alert("Erreur: impossible de trouver le commerce original.");
                return;
            }

            if (newName.toLowerCase() !== originalName.toLowerCase() && manualStores.some(s => s.name.toLowerCase() === newName.toLowerCase())) {
                alert("Un commerce avec ce nom existe d√©j√†.");
                return;
            }

            manualStores[storeIndex].name = newName;
            manualStores[storeIndex].address = newAddress;
            manualStores[storeIndex].website = newWebsite || '#';
            saveManualStores();

            if (newName !== originalName && flyerData.hasOwnProperty(originalName)) {
                flyerData[newName] = flyerData[originalName];
                delete flyerData[originalName];
                saveFlyerData();
            }

            closeStoreEditModal();
            renderAllStores();
        }

        function copyAiPrompt() {
            aiPromptTextarea.select();
            aiPromptTextarea.setSelectionRange(0, 99999);
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    const originalText = copyAiPromptBtn.textContent;
                    copyAiPromptBtn.textContent = 'Copi√© !';
                    setTimeout(() => { copyAiPromptBtn.textContent = originalText; }, 2000);
                } else {
                    throw new Error('Copy command failed');
                }
            } catch (err) {
                alert('La copie automatique a √©chou√©. Veuillez copier le texte manuellement (Ctrl+C).');
            }
        }

        function extractNameFromUrl(urlString) {
            try {
                if (!urlString.startsWith('http')) { urlString = 'https://' + urlString; }
                const url = new URL(urlString);
                let hostname = url.hostname.replace(/^www\./i, '');
                const parts = hostname.split('.');
                const name = parts[0];
                return name.charAt(0).toUpperCase() + name.slice(1);
            } catch (e) {
                return null;
            }
        }

        function addStoreFromUrl(event) {
            event.preventDefault();
            const storeUrl = manualStoreUrlInput.value.trim();
            if (!storeUrl) return;

            const storeName = extractNameFromUrl(storeUrl);
            if (!storeName) { alert("Veuillez entrer une adresse web valide."); return; }

            const isAlreadyInManual = manualStores.some(s => s.website === storeUrl || s.name.toLowerCase() === storeName.toLowerCase());
            const isAlreadyInNearby = nearbyStores.some(store => store.name.toLowerCase() === storeName.toLowerCase());

            if (!isAlreadyInManual && !isAlreadyInNearby) {
                manualStores.push({ name: storeName, website: storeUrl, address: '' });
                saveManualStores(); renderAllStores(); manualStoreUrlInput.value = '';
            } else {
                alert('Ce commerce est d√©j√† dans la liste.');
            }
        }

        function deleteManualStore(event) {
            event.preventDefault(); event.stopPropagation();
            const nameToDelete = event.target.dataset.storeName;
            manualStores = manualStores.filter(store => store.name !== nameToDelete);
            
            if (flyerData[nameToDelete]) {
                delete flyerData[nameToDelete];
                saveFlyerData();
            }
            saveManualStores(); renderAllStores();
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        async function findNearbyStores() {
            findStoresBtn.disabled = true;
            sortStoresBtn.style.display = 'none';
            const storesListContainer = document.getElementById('stores-list-display');
            if (!storesListContainer) { console.error("Could not find stores-list-display"); return; }
            storesListContainer.innerHTML = '<p>Recherche des commerces en cours...</p>';

            if (!navigator.geolocation) {
                storesListContainer.innerHTML = '<p>La g√©olocalisation n\'est pas support√©e par votre navigateur.</p>';
                findStoresBtn.disabled = false;
                return;
            }

            const selectedTypes = Array.from(document.querySelectorAll('.store-type-filter:checked')).map(cb => cb.value);
            if (selectedTypes.length === 0) {
                storesListContainer.innerHTML = '<p>Veuillez s√©lectionner au moins un type de commerce.</p>';
                findStoresBtn.disabled = false;
                return;
            }

            navigator.geolocation.getCurrentPosition(async position => {
                const { latitude, longitude } = position.coords;
                const radius = 2000; // Rayon de recherche de 2km

                // --- D√âBUT DE LA MODIFICATION : Requ√™te Overpass simplifi√©e et plus robuste ---
                let queryParts = [];
                
                // Regroupe les types 'shop' pour une requ√™te plus efficace
                const shopTypes = selectedTypes.filter(type => ['supermarket', 'grocery', 'convenience'].includes(type));
                if (shopTypes.length > 0) {
                    // Utilise l'op√©rateur '~' pour une regex qui cherche l'un des types
                    const shopQuery = shopTypes.join('|');
                    queryParts.push(`nwr["shop"~"${shopQuery}"](around:${radius},${latitude},${longitude});`);
                }

                // G√®re la pharmacie s√©par√©ment car elle utilise la cl√© 'amenity'
                if (selectedTypes.includes('pharmacy')) {
                    queryParts.push(`nwr["amenity"="pharmacy"](around:${radius},${latitude},${longitude});`);
                }

                // 'nwr' est un raccourci pour 'node, way, relation', ce qui simplifie la requ√™te.
                const query = `[out:json][timeout:25]; (${queryParts.join('')}); out center;`;
                // --- FIN DE LA MODIFICATION ---

                const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        // Donne un message d'erreur plus sp√©cifique en cas d'√©chec de l'API
                        throw new Error(`Le service de cartographie a retourn√© une erreur : ${response.status} ${response.statusText}`);
                    }
                    const data = await response.json();
                    console.log("R√©ponse de l'API Overpass :", data);
                    processAndDisplayStores(data.elements, latitude, longitude);
                } catch (error) {
                    console.error("Erreur Overpass:", error);
                    storesListContainer.innerHTML = `<p>Impossible de r√©cup√©rer les donn√©es des commerces. Le service externe est peut-√™tre temporairement indisponible. <br>Erreur : ${error.message}</p>`;
                } finally {
                    findStoresBtn.disabled = false;
                }
            }, () => {
                storesListContainer.innerHTML = '<p>La g√©olocalisation a √©t√© refus√©e. Veuillez autoriser l\'acc√®s √† votre position pour utiliser cette fonctionnalit√©.</p>';
                findStoresBtn.disabled = false;
            });
        }
        
        function processAndDisplayStores(places, userLat, userLon) {
            let foundStores = []; // Cr√©e une liste temporaire pour les r√©sultats
            
            // G√®re le cas o√π la recherche ne retourne aucun r√©sultat
            if (!places || places.length === 0) {
                nearbyStores = []; // Vide la liste des commerces √† proximit√©
                renderAllStores(); // Affiche la liste (qui contiendra les commerces manuels)
                
                const storesListContainer = document.getElementById('stores-list-display');
                if (!storesListContainer) return;

                // Ajoute un message d'information clair pour l'utilisateur
                const message = document.createElement('p');
                message.style.color = '#e67e22'; // Orange pour un avertissement
                message.style.marginBottom = '15px';
                message.textContent = 'Aucun commerce correspondant aux crit√®res n\'a √©t√© trouv√© √† proximit√©.';
                storesListContainer.prepend(message);
                return;
            }

            const uniquePlaces = new Map();
            places.forEach(place => {
                // Utilise toLowerCase() pour √©viter les doublons dus √† la casse (ex: "Iga" et "IGA")
                if (place.tags && place.tags.name && !uniquePlaces.has(place.tags.name.toLowerCase())) {
                    uniquePlaces.set(place.tags.name.toLowerCase(), place);
                }
            });

            uniquePlaces.forEach(place => {
                const storeLat = place.type === 'node' ? place.lat : place.center.lat;
                const storeLon = place.type === 'node' ? place.lon : place.center.lon;
                const distance = calculateDistance(userLat, userLon, storeLat, storeLon);
                const website = place.tags.website || place.tags['contact:website'];
                const addressParts = [
                    place.tags['addr:housenumber'],
                    place.tags['addr:street'],
                    place.tags['addr:city'],
                    place.tags['addr:postcode']
                ].filter(Boolean); // Filtre les parties d'adresse vides
                const address = addressParts.join(', ') || 'Adresse non disponible';
                
                foundStores.push({
                    id: place.id,
                    name: place.tags.name,
                    distance: distance,
                    website: website,
                    address: address,
                    lat: storeLat,
                    lon: storeLon
                });
            });

            // Remplace l'ancienne liste des commerces √† proximit√© par la nouvelle
            nearbyStores = foundStores;
            
            renderAllStores(); // Met √† jour l'affichage global
            sortStoresBtn.style.display = nearbyStores.length > 0 ? 'inline-block' : 'none';
        }

        function renderAllStores() {
            const storesListContainer = document.getElementById('stores-list-display');
            if (!storesListContainer) { console.error("Element #stores-list-display not found!"); return; }
            storesListContainer.innerHTML = '';

            // --- Logique am√©lior√©e pour fusionner et d√©doublonner les listes ---
            const allStoresMap = new Map();
            
            // Les commerces manuels sont prioritaires
            manualStores.forEach(store => allStoresMap.set(store.name.toLowerCase(), store));
            
            // Ajoute les commerces √† proximit√© seulement s'ils ne sont pas d√©j√† dans la liste manuelle
            nearbyStores.forEach(store => {
                if (!allStoresMap.has(store.name.toLowerCase())) {
                    allStoresMap.set(store.name.toLowerCase(), store);
                }
            });

            const allStores = Array.from(allStoresMap.values());

            // Trie la liste : d'abord par distance, puis alphab√©tiquement pour les commerces manuels
            allStores.sort((a, b) => {
                const aHasDist = a.distance !== undefined;
                const bHasDist = b.distance !== undefined;

                if (aHasDist && !bHasDist) return -1;
                if (!aHasDist && bHasDist) return 1;
                if (aHasDist && bHasDist) return a.distance - b.distance;
                return a.name.localeCompare(b.name);
            });
            // --- Fin de la logique am√©lior√©e ---

            if (allStores.length === 0) {
                storesListContainer.innerHTML = '<p class="placeholder">La liste des commerces appara√Ætra ici. Utilisez la recherche ou ajoutez des commerces manuellement.</p>';
                return;
            }

            allStores.forEach(store => {
                const storeElement = document.createElement('div');
                storeElement.className = 'store-item';
                const sanitizedId = store.name.replace(/[^a-zA-Z0-9]/g, '');
                let isManual = manualStores.some(ms => ms.name.toLowerCase() === store.name.toLowerCase());
                
                let storeDetailsHtml;
                if (store.distance !== undefined) { // C'est un commerce trouv√© √† proximit√©
                    storeDetailsHtml = `<div class="store-address">${store.address}</div><div class="store-details"><span>Distance: ~${store.distance.toFixed(1)} km</span> | <a href="https://www.openstreetmap.org/?mlat=${store.lat}&mlon=${store.lon}#map=18/${store.lat}/${store.lon}" target="_blank">Voir sur la carte</a></div>`;
                } else { // C'est un commerce manuel
                    let addressHtml = store.address && store.address !== 'Adresse non fournie' ? `<div class="store-address">${store.address}</div>` : '';
                    let websiteHtml = store.website && store.website !== '#' ? `<a href="${store.website}" target="_blank">Visiter le site web</a>` : `<span>(Ajout√© manuellement)</span>`;
                    storeDetailsHtml = `${addressHtml}<div class="store-details">${websiteHtml}</div>`;
                }
                
                const storeNameTrimmed = store.name.trim();
                const flyerDataKeys = Object.keys(flyerData);
                const matchingKey = flyerDataKeys.find(key => key.trim().toLowerCase() === storeNameTrimmed.toLowerCase());
                const hasFlyer = !!matchingKey;
                
                let flyerButtonHtml = hasFlyer ? `<button class="btn btn-primary btn-view-flyer" data-store-name="${matchingKey}">
                    <i class="bi bi-magic"></i> Voir la circulaire
                </button>` : '';
                const editButtonHtml = isManual ? `<button class="btn btn-primary btn-edit-manual btn-small" data-store-name="${store.name}" style="background-color: #f39c12;">
                    <i class="bi bi-magic"></i> √âditer
                </button>` : '';
                const deleteButtonHtml = isManual ? `<button class="btn btn-primary btn-delete-manual btn-small" data-store-name="${store.name}" style="background-color: #c0392b;">
                    <i class="bi bi-magic"></i> X
                </button>` : '';

                storeElement.innerHTML = `<input type="checkbox" class="store-checkbox" value="${store.name}" id="store-${sanitizedId}" checked><label for="store-${sanitizedId}" style="display: flex; justify-content: space-between; align-items: center; width: 100%;"><div><div class="store-name">${store.name}</div>${storeDetailsHtml}</div><div class="store-actions">${editButtonHtml}${deleteButtonHtml}${flyerButtonHtml}</div></label>`;
                storesListContainer.appendChild(storeElement);
            });

            document.querySelectorAll('.btn-edit-manual').forEach(button => button.addEventListener('click', openStoreEditModal));
            document.querySelectorAll('.btn-delete-manual').forEach(button => button.addEventListener('click', deleteManualStore));
            document.querySelectorAll('.btn-view-flyer').forEach(button => button.addEventListener('click', openFlyerModal));
        }
        
        function sortStoresByDistance() {
            nearbyStores.sort((a, b) => a.distance - b.distance);
            renderAllStores();
        }
        function normalizeString(str) {
            return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        function isFuzzyMatch(shoppingItemName, flyerItemName) {
            const normalizedShoppingName = normalizeString(shoppingItemName);
            const normalizedFlyerName = normalizeString(flyerItemName);
            
            const searchWords = normalizedShoppingName.split(' ').filter(word => word.length > 1);
            return searchWords.every(word => normalizedFlyerName.includes(word));
        }

        // N√©cessaire pour les requ√™tes POST s√©curis√©es avec Django
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // MODIFIER la fonction loadStoresIntoModal pour qu'elle s'occupe de TOUTES les listes d√©roulantes
        async function loadStoresIntoModal() {
            try {
                //const response = await fetch('/api/commerces/');
                const stores = await apiCall('/api/commerces/'); // NOUVEAU CODE

                //if (!response.ok) throw new Error('Impossible de charger les commerces.');                
                //const stores = await response.json();

                allStores = stores; // Sauvegarde pour un acc√®s futur
                
                // --- DEBUT DE LA MODIFICATION ---
                const priceModalStoreSelect = document.getElementById('modal-store-select');
                const dealModalStoreSelect = document.getElementById('deal-store-select');

                // On r√©initialise les deux listes
                priceModalStoreSelect.innerHTML = '<option value="">-- Choisissez un commerce --</option>'; 
                dealModalStoreSelect.innerHTML = '<option value="">-- Choisissez un commerce --</option>';

                const sortedStores = [...allStores].sort((a, b) => a.nom.localeCompare(b.nom));

                sortedStores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store.id;
                    option.textContent = store.nom;
                    // On ajoute l'option clon√©e aux deux listes
                    priceModalStoreSelect.appendChild(option.cloneNode(true));
                    dealModalStoreSelect.appendChild(option.cloneNode(true));
                });
                // --- FIN DE LA MODIFICATION ---

            } catch (error) {
                console.error("Erreur de chargement des commerces:", error);
                // G√©rer l'erreur dans les deux listes
                document.getElementById('modal-store-select').innerHTML = '<option value="">Erreur</option>';
                document.getElementById('deal-store-select').innerHTML = '<option value="">Erreur</option>';
            }
        }

        // --- NOUVELLE LOGIQUE D'OUVERTURE DE LA MODALE (AVEC D√âL√âGATION D'√âV√âNEMENT) ---
        function openPriceModal(event) {
            // On v√©rifie si l'√©l√©ment cliqu√© est bien notre bouton
            if (event.target.classList.contains('btn-submit-price')) {
                const productName = event.target.dataset.itemName;
                
                // On remplit les champs de la modale
                modalProductName.textContent = productName;
                hiddenProductNameInput.value = productName;
                
                // On affiche la modale
                priceModal.style.display = 'block';
            }
        }


        // --- NOUVELLE LOGIQUE DE FERMETURE DE LA MODALE ---
        function closePriceModal() {
            priceModal.style.display = 'none';
            if (submitPriceForm) {
                submitPriceForm.reset(); // Vide le formulaire
            }
        }

        
        // --- NOUVELLE LOGIQUE DE SOUMISSION DU PRIX ---
        async function handlePriceSubmit(event) {
            event.preventDefault();
            
            const productName = hiddenProductNameInput.value;
            const commerceId = storeSelect.value;
            const price = priceInput.value;
            const token = localStorage.getItem('authToken');

            if (!token) {
                alert("Veuillez vous connecter pour soumettre un prix.");
                return;
            }

            try {
                const searchResponse = await apiCall(`/api/products/search/?q=${encodeURIComponent(productName)}`);
                const products = await searchResponse.json();
                
                let productId = null;
                if (products.length > 0) {
                    // On prend le premier r√©sultat qui correspond exactement (insensible √† la casse)
                    const exactMatch = products.find(p => p.nom.toLowerCase() === productName.toLowerCase());
                    productId = exactMatch ? exactMatch.id : products[0].id;
                }

                // --- DEBUT DE LA LOGIQUE MODIFI√âE ---
                if (productId) {
                    // Si le produit existe, on soumet le prix comme avant
                    await submitPrice(productId, commerceId, price, token);
                    alert('Merci ! Votre prix a √©t√© soumis avec succ√®s.');
                    closePriceModal();
                } else {
                    // Si le produit n'existe PAS, on ouvre la modale pour l'ajouter
                    newProductNameDisplay.textContent = productName;
                    hiddenNewProductNameInput.value = productName;
                    addProductModal.style.display = 'block';
                }
                // --- FIN DE LA LOGIQUE MODIFI√âE ---

            } catch (error) {
                console.error("Erreur lors de la soumission :", error);
                alert(error.message);
            }
        }


        // Fonction s√©par√©e pour la soumission de prix, pour la r√©utiliser
        async function submitPrice(productId, commerceId, price, token) {
            const submissionResponse = await apiCall('/api/prices/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Authorization': `Token ${token}`
                },
                body: JSON.stringify({
                    produit_id: productId,
                    commerce_id: parseInt(commerceId),
                    prix: price
                })
            });
            if (!submissionResponse.ok) {
                const errorData = await submissionResponse.json();
                throw new Error(errorData.detail || 'Erreur lors de la soumission du prix.');
            }
        }
        
        // --- DEBUT DES NOUVELLES FONCTIONS ---

        // G√®re la soumission du formulaire d'ajout de produit
        async function handleAddProductSubmit(event) {
            event.preventDefault();
            const token = localStorage.getItem('authToken');
            const productName = hiddenNewProductNameInput.value;
            const brand = document.getElementById('new-product-brand').value;

            try {
                // √âtape 1 : Cr√©er le nouveau produit via l'API
                const createResponse = await apiCall('/api/products/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Authorization': `Token ${token}`
                    },
                    body: JSON.stringify({ nom: productName, marque: brand })
                });

                if (!createResponse.ok) {
                    const errorData = await createResponse.json();
                    throw new Error(errorData.error || 'Erreur lors de la cr√©ation du produit.');
                }
                
                const newProduct = await createResponse.json();
                const newProductId = newProduct.id;

                // √âtape 2 : Soumettre le prix avec le nouvel ID de produit
                const commerceId = storeSelect.value;
                const price = priceInput.value;
                await submitPrice(newProductId, commerceId, price, token);
                
                alert('Produit ajout√© et prix soumis avec succ√®s !');
                addProductModal.style.display = 'none';
                closePriceModal();

            } catch (error) {
                alert(error.message);
            }
        }

        
        // G√®re la soumission du formulaire de rabais simple
        async function handleDealSubmit(event) {
            event.preventDefault();
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert("Veuillez vous connecter pour soumettre un rabais.");
                return;
            }

            const dealData = {
                product_name: document.getElementById('deal-product-name').value,
                brand: document.getElementById('deal-product-brand').value,
                commerce_id: document.getElementById('deal-store-select').value,
                price_details: document.getElementById('deal-price-details').value,
                single_price: document.getElementById('deal-single-price').value,
                date_debut: document.getElementById('deal-date-debut').value,
                date_fin: document.getElementById('deal-date-fin').value,
            };

            try {
                const response = await apiCall('/api/submit-deal/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Authorization': `Token ${token}`
                    },
                    body: JSON.stringify(dealData)
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Une erreur est survenue.');

                alert(result.message);
                submitDealModal.style.display = 'none';
                submitDealForm.reset();
                // Rafra√Æchir la liste des rabais pour voir le nouveau
                chargerRabaisActifs();

            } catch (error) {
                alert(error.message);
            }
        }

       
        // --- FONCTION DE RENDU MODIFI√âE ---
        function renderOptimizedList() {
            const optimizationDisplayContainer = document.getElementById('optimization-display');
            if (!optimizationDisplayContainer) { console.error("Element #optimization-display not found!"); return; }
            optimizationDisplayContainer.innerHTML = '';

            if (optimizedItems.length === 0) {
                optimizationDisplayContainer.innerHTML = '<p class="placeholder">Votre liste d\'√©picerie est vide ou n\'a pas encore √©t√© optimis√©e.</p>';
                findPricesBtn.style.display = 'none';
                return;
            }

            // On r√©cup√®re le nom de l'utilisateur actuellement connect√©
            const currentUser = localStorage.getItem('username');
            let total = 0;
            let hasItemsWithoutPrice = false;

            optimizedItems.forEach((item, itemIndex) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'optimized-item';
                itemElement.setAttribute('draggable', true);
                itemElement.setAttribute('data-index', itemIndex);

                const currentPrice = parseFloat(item.selectedPrice);
                total += isNaN(currentPrice) ? 0 : currentPrice;

                if (!item.selectedPrice || currentPrice === 0) {
                    hasItemsWithoutPrice = true;
                }

                let dealsHtml;
                if (item.deals && item.deals.length > 0) {
                    // Trier les offres: les rabais en premier, puis les prix communautaires
                    item.deals.sort((a, b) => {
                        if (a.type === 'rabais' && b.type !== 'rabais') return -1;
                        if (a.type !== 'rabais' && b.type === 'rabais') return 1;
                        return 0;
                    });

                    const optionsHtml = item.deals.map((deal, dealIndex) => {
                        const isSelected = item.selectedDeal && item.selectedDeal.name === deal.name && item.selectedDeal.store === deal.store;

                        let actionButtonsHtml = '';
                        // On affiche les boutons Confirmer/Signaler uniquement pour les prix communautaires
                        if (deal.type === 'communautaire' && deal.price_id) {
                            actionButtonsHtml = `
                                <button class="btn btn-primary btn-small btn-confirm-price" data-price-id="${deal.price_id}" style="background-color: #27ae60; margin-left: 10px;">
                                    <i class="bi bi-magic"></i> Confirmer
                                </button>
                                <button class="btn btn-primary btn-small btn-report-price" data-price-id="${deal.price_id}" data-product-name="${deal.name}" style="background-color: #e67e22; margin-left: 5px;">
                                    <i class="bi bi-magic"></i> Signaler
                                </button>
                            `;
                        }

                            let confirmButtonHtml = '';
                            // Condition 1: Le deal doit avoir √©t√© soumis par un utilisateur.
                            // Condition 2: Cet utilisateur ne doit PAS √™tre l'utilisateur actuel.
                            if (deal.submitted_by_username && deal.submitted_by_username !== currentUser) {
                                confirmButtonHtml = `<button class="btn btn-primary btn-small btn-confirm-price" data-price-id="${deal.price_id}" style="background-color: #27ae60; margin-left: 10px;">
                                    <i class="bi bi-magic"></i> Confirmer
                                </button>`;
                            }
                            return `
                            <div style="display: flex; align-items: center; padding: 5px 0;">
                                <input type="radio" name="deal-radio-${itemIndex}" id="deal-${itemIndex}-${dealIndex}" class="deal-selector-radio" data-item-index="${itemIndex}" data-deal-index="${dealIndex}" ${isSelected ? 'checked' : ''}>
                                <label for="deal-${itemIndex}-${dealIndex}" style="flex-grow: 1; margin-left: 5px;">${deal.details} - ${deal.store}</label>
                                ${confirmButtonHtml}
                            </div>
                        `;
                    }).join('');

                    // On n'utilise plus de <select>, mais une s√©rie de boutons radio
                    dealsHtml = `
                        <div class="deal-selector-group" data-item-index="${itemIndex}">
                            <p style="margin-top:0; margin-bottom: 5px; font-weight: bold;">Offres trouv√©es :</p>
                            ${optionsHtml}
                        </div>`;
                } else {
                    dealsHtml = `<span>Aucun rabais ou prix communautaire trouv√©</span>`;
                }

                const priceValue = item.selectedPrice !== undefined ? item.selectedPrice : '';

                itemElement.innerHTML = `
                    <span class="item-name-grid">${item.name} (Qt√©: ${item.quantity})</span>
                    <div class="item-deals-grid">
                        ${dealsHtml}
                        
                        <!-- ================== LIGNE AJOUT√âE ================== -->
                        <button 
                            class="btn btn-primary btn-small btn-submit-price" 
                            data-item-name="${item.name}" 
                            style="background-color: #16a085; margin-top: 8px;">
                            
                            <i class="bi bi-magic"></i> Soumettre un prix r√©gulier
                        </button>
                        <!-- =================================================== -->

                    </div>
                    <div class="item-price-grid">
                        <label for="price-${itemIndex}" style="font-size: 0.9em;">Prix Final:</label>
                        <input type="text" id="price-${itemIndex}" class="item-price-input" data-item-index="${itemIndex}" value="${priceValue}" placeholder="0.00" style="width: 80px; text-align: right; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                `;
                optimizationDisplayContainer.appendChild(itemElement);
            });

            // G√©rer la visibilit√© du bouton de recherche de prix
            findPricesBtn.style.display = hasItemsWithoutPrice ? 'inline-block' : 'none';

            // Ajouter le total √† la fin
            const totalElement = document.createElement('div');
            totalElement.style.textAlign = 'right';
            totalElement.style.marginTop = '20px';
            totalElement.style.paddingTop = '10px';
            totalElement.style.borderTop = '2px solid #333';
            totalElement.style.fontSize = '1.2em';
            totalElement.style.fontWeight = 'bold';
            totalElement.innerHTML = `Total estim√©: <span style="color: #27ae60;">${total.toFixed(2)} $</span>`;
            optimizationDisplayContainer.appendChild(totalElement);
        }

        async function handleConfirmPrice(event) {
            if (!event.target.classList.contains('btn-confirm-price')) {
                return; // Ne fait rien si ce n'est pas le bon bouton
            }

            const button = event.target;
            const priceId = button.dataset.priceId;
            const token = localStorage.getItem('authToken');

            if (!token) {
                alert("Veuillez vous connecter pour confirmer un prix.");
                return;
            }

            button.disabled = true;
            button.textContent = '...';

            try {
                const response = await apiCall(`/api/prices/${priceId}/confirm/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Authorization': `Token ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Une erreur est survenue.');
                }
                
                button.textContent = 'Confirm√© ‚úì';
                button.style.backgroundColor = '#7f8c8d';

                // Optionnel mais recommand√© : rafra√Æchir la liste pour voir le nombre de confirmations augmenter.
                optimizeShoppingList();

            } catch (error) {
                alert(error.message);
                button.disabled = false;
                button.textContent = 'Confirmer'; // R√©initialiser le bouton en cas d'erreur
            }
        }

        // --- NOUVELLES FONCTIONS POUR LE SIGNALEMENT ---

        // G√®re l'ouverture de la modale de signalement
        function openReportModal(event) {
            if (!event.target.classList.contains('btn-report-price')) {
                return;
            }
            const button = event.target;
            const priceId = button.dataset.priceId;
            const productName = button.dataset.productName;
            
            reportProductName.textContent = productName;
            hiddenReportPriceId.value = priceId;
            
            reportPriceModal.style.display = 'block';
        }

        // G√®re la fermeture de la modale
        function closeReportModal() {
            reportPriceModal.style.display = 'none';
            reportPriceForm.reset();
        }

        // G√®re la soumission du formulaire de signalement
        async function handleReportSubmit(event) {
            event.preventDefault();
            
            const priceId = hiddenReportPriceId.value;
            const token = localStorage.getItem('authToken');
            
            if (!token) {
                alert("Veuillez vous connecter pour signaler un prix.");
                return;
            }
            
            const formData = new FormData(reportPriceForm);
            const reason = formData.get('report_reason');
            const comments = document.getElementById('report-comments').value;

            try {
                const response = await apiCall(`/api/prices/${priceId}/report/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Authorization': `Token ${token}`
                    },
                    body: JSON.stringify({ reason, comments })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Une erreur est survenue.');
                
                alert(data.message);
                closeReportModal();

            } catch (error) {
                alert(error.message);
            }
        }
        
        function saveOptimizedList() {
            localStorage.setItem('savedOptimizedList', JSON.stringify(optimizedItems));
        }

        function handleDealSelection(event) {
            if (event.target.classList.contains('deal-selector')) {
                const activeElementId = document.activeElement ? document.activeElement.id : null;

                const itemIndex = parseInt(event.target.dataset.itemIndex, 10);
                const dealIndex = parseInt(event.target.value, 10);
                if (itemIndex >= 0 && itemIndex < optimizedItems.length) {
                    const item = optimizedItems[itemIndex];
                    if (dealIndex >= 0) {
                        const selectedDeal = item.deals[dealIndex];
                        item.selectedDeal = selectedDeal;
                        
                        const priceString = String(selectedDeal.price);
                        let priceForTotal = '';
                        
                        const singlePriceMatch = priceString.match(/\(([\d\.]+)\)/);
                        const mainPriceMatch = priceString.match(/^([\d\.\/]+)/);

                        if (singlePriceMatch && singlePriceMatch[1]) {
                             priceForTotal = singlePriceMatch[1];
                        } else if (mainPriceMatch && mainPriceMatch[1]) {
                            const pricePart = mainPriceMatch[1];
                            if (pricePart.includes('/')) {
                                const parts = pricePart.split('/');
                                if (parts.length === 2 && !isNaN(parseFloat(parts[0])) && !isNaN(parseFloat(parts[1]))) {
                                    priceForTotal = (parseFloat(parts[1]) / parseFloat(parts[0])).toFixed(2);
                                }
                            } else {
                                priceForTotal = pricePart;
                            }
                        }
                        item.selectedPrice = priceForTotal;
                    } else {
                        item.selectedDeal = null;
                        item.selectedPrice = '';
                    }
                    saveOptimizedList();
                    renderOptimizedList();

                    if (activeElementId) {
                        const newActiveElement = document.getElementById(activeElementId);
                        if (newActiveElement) newActiveElement.focus();
                    }
                }
            }
        }
        
        function handlePriceChange(event) {
            if (event.target.classList.contains('item-price-input')) {
                const itemIndex = parseInt(event.target.dataset.itemIndex, 10);
                
                const activeElement = document.activeElement;
                const activeElementId = activeElement ? activeElement.id : null;
                const selectionStart = activeElement ? activeElement.selectionStart : null;
                const selectionEnd = activeElement ? activeElement.selectionEnd : null;

                if (itemIndex >= 0 && itemIndex < optimizedItems.length) {
                    optimizedItems[itemIndex].selectedPrice = event.target.value;
                    saveOptimizedList();
                    renderOptimizedList(); // Re-rendre pour mettre √† jour le total
                }

                if (activeElementId) {
                    const newActiveElement = document.getElementById(activeElementId);
                    if (newActiveElement) {
                        newActiveElement.focus();
                        if (selectionStart !== null && selectionEnd !== null) {
                            newActiveElement.setSelectionRange(selectionStart, selectionEnd);
                        }
                    }
                }
            }
        }

        function loadSavedOptimizedList() {
            const savedList = JSON.parse(localStorage.getItem('savedOptimizedList'));
            if (savedList && Array.isArray(savedList) && savedList.length > 0) {
                optimizedItems = savedList;
                renderOptimizedList();
            }
        }
        
        // --- NOUVELLE FONCTION D'IMPRESSION ROBUSTE ---
        function printOptimizedList() {
            if (!optimizedItems || optimizedItems.length === 0) {
                alert("Veuillez d'abord optimiser votre liste pour pouvoir l'imprimer.");
                return;
            }

            const itemsToPrint = optimizedItems;
            let total = 0;
            const itemCount = itemsToPrint.length;

            // 1. Classification de la liste
            let bodyClass = 'liste-courte';
            if (itemCount > 70) {
                bodyClass = 'liste-tres-longue-2col';
            } else if (itemCount > 48) {
                bodyClass = 'liste-longue-2col';
            } else if (itemCount > 28) {
                bodyClass = 'liste-moyenne';
            }

            const printWindow = window.open('', '_blank');
            let printContent = `
                <html>
                <head>
                    <title>Liste d'√âpicerie Optimis√©e</title>
                    <style>
                        /* Styles de base pour la structure */
                        body { 
                            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                            margin: 0;
                        }
                        .print-body {
                            display: flex;
                            flex-direction: column;
                            height: 100%;
                            padding: 5mm; /* Marges g√©r√©es par le padding */
                            box-sizing: border-box;
                        }
                        h1 { 
                            color: #2c3e50; 
                            border-bottom: 2px solid #ccc; 
                            padding-bottom: 5px; 
                            margin: 0 0 5px 0;
                        }
                        .print-container {
                            flex-grow: 1; /* Prend tout l'espace disponible */
                            overflow: hidden; /* Emp√™che le d√©bordement du conteneur lui-m√™me */
                        }
                        .print-item {
                            border-bottom: 1px solid #eee;
                            word-wrap: break-word;
                        }
                        .item-title { font-weight: bold; font-size: 1.05em; }
                        .item-deal, .item-no-deal { font-size: 0.9em; padding-left: 10px; }
                        .item-deal { color: #27ae60; }
                        .item-no-deal { color: #7f8c8d; font-style: italic; }
                        .total-footer {
                            text-align: right;
                            padding-top: 5px;
                            border-top: 2px solid #333;
                            font-weight: bold;
                            flex-shrink: 0; /* Emp√™che le pied de page de r√©tr√©cir */
                        }
                        
                        /* Styles sp√©cifiques aux classes de liste */
                        .liste-courte { font-size: 11pt; line-height: 1.4; }
                        .liste-courte .print-item { padding: 3px 0; }
                        
                        .liste-moyenne { font-size: 9.5pt; line-height: 1.3; }
                        .liste-moyenne .print-item { padding: 2px 0; }

                        .liste-longue-2col { font-size: 8.5pt; line-height: 1.25; }
                        .liste-longue-2col .print-item { padding: 1px 0; }
                        .liste-longue-2col .print-container { column-count: 2; column-gap: 12px; }
                        .liste-longue-2col .print-item { break-inside: avoid; }

                        .liste-tres-longue-2col { font-size: 7.5pt; line-height: 1.2; }
                        .liste-tres-longue-2col .print-item { padding: 1px 0; }
                        .liste-tres-longue-2col .print-container { column-count: 2; column-gap: 12px; }
                        .liste-tres-longue-2col .print-item { break-inside: avoid; }

                        @media print {
                            @page {
                                size: letter portrait;
                                margin: 0; /* Les marges sont g√©r√©es par le padding du .print-body */
                            }
                             html, body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body class="${bodyClass}">
                    <div class="print-body">
                        <h1>Liste d'√âpicerie Compl√®te</h1>
                        <div class="print-container">`;
            
            itemsToPrint.forEach(item => {
                total += parseFloat(item.selectedPrice) || 0;
                let dealHtml;
                if (item.selectedDeal) {
                    const finalPriceText = item.selectedPrice ? `<strong>$${parseFloat(item.selectedPrice).toFixed(2)}</strong>` : `(${item.selectedDeal.price})`;
                    dealHtml = `<div class="item-deal">‚Ü≥ <strong>${item.selectedDeal.store}</strong>: ${item.selectedDeal.name} - Prix final: ${finalPriceText}</div>`;
                } else {
                     const finalPriceText = item.selectedPrice ? `<strong>$${parseFloat(item.selectedPrice).toFixed(2)}</strong>` : `(aucun prix entr√©)`;
                    dealHtml = `<div class="item-no-deal">‚Ü≥ Aucun rabais s√©lectionn√© - Prix manuel: ${finalPriceText}</div>`;
                }
                printContent += `<div class="print-item"><div class="item-title">${item.name} (Qt√©: ${item.quantity})</div>${dealHtml}</div>`;
            });

            printContent += `</div>`; // .print-container
            printContent += `<div class="total-footer">Total Estim√©: ${total.toFixed(2)} $</div>`;
            printContent += `</div></body></html>`; // .print-body

            printWindow.document.write(printContent);
            printWindow.document.close();
            
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        async function optimizeShoppingList() {
            const shoppingList = JSON.parse(localStorage.getItem('shoppingList')) || [];
            if (shoppingList.length === 0) {
                const optimizationDisplayContainer = document.getElementById('optimization-display');
                if (optimizationDisplayContainer) {
                    optimizationDisplayContainer.innerHTML = '<p class="placeholder">Votre liste d\'√©picerie est vide. Ajoutez des articles depuis la page principale.</p>';
                }
                return;
            }

            const selectedStores = Array.from(document.querySelectorAll('.store-checkbox:checked')).map(node => node.value);
            if (selectedStores.length === 0) {
                alert("Veuillez s√©lectionner au moins un commerce pour lancer l'optimisation.");
                return;
            }

            // On ajoute un param√®tre unique pour forcer le navigateur √† ne pas utiliser de cache
            const cacheBuster = `?t=${new Date().getTime()}`;
            const [flyerDeals, communityPrices] = await Promise.all([
                apiCall(`/api/rabais-actifs/${cacheBuster}`),
                apiCall(`/api/community-prices/${cacheBuster}`)
            ]);
            
            // On fusionne les deux listes en une seule
            const allAvailablePrices = [
                ...flyerDeals.map(d => ({ ...d, type: 'rabais' })), // On ajoute le type 'rabais'
                ...communityPrices.map(p => ({ ...p, type: 'communautaire' })) // On ajoute le type 'communautaire'
            ];
            // --- FIN DE LA NOUVELLE LOGIQUE ---

            optimizedItems = [];
            shoppingList.forEach(shoppingItem => {
                const potentialDeals = [];
                const shoppingItemNameLower = shoppingItem.name.toLowerCase().normalize("NFD").replace(/[\u00-[\u036f]/g, "");

                // On cherche dans la liste fusionn√©e
                // La logique a √©t√© grandement simplifi√©e pour √©viter toute erreur.
                allAvailablePrices.forEach(deal => {
                    const storeIsSelected = selectedStores.some(selectedStore => deal.commerce_nom.includes(selectedStore));
                    
                    if (storeIsSelected) {
                        const dealNameLower = deal.produit_nom.toLowerCase().normalize("NFD").replace(/[\u00-[\u036f]/g, "");
                        
                        if (dealNameLower.includes(shoppingItemNameLower)) {
                            // On cr√©e un objet unique qui contient TOUTES les informations n√©cessaires,
                            // y compris le 'submitted_by_username' qui √©tait perdu auparavant.
                            potentialDeals.push({
                                type: deal.type,
                                price_id: deal.price_id,
                                store: deal.commerce_nom,
                                name: deal.produit_nom,
                                price: deal.prix,
                                details: deal.details_prix,
                                submitted_by_username: deal.submitted_by_username // L'information cruciale est maintenant pr√©serv√©e.
                            });
                        }
                    }
                });
                   
                optimizedItems.push({
                    name: shoppingItem.name,
                    quantity: shoppingItem.quantity,
                    deals: potentialDeals,
                    selectedDeal: null,
                    selectedPrice: '',
                });
            });

            renderOptimizedList();
            saveOptimizedList();
        }

        function generateRoute() {
            const routeDisplayContainer = document.getElementById('route-display');
            if (!routeDisplayContainer) { console.error("Element #route-display not found!"); return; }

            if (optimizedItems.length === 0) {
                routeDisplayContainer.innerHTML = '<p>Veuillez d\'abord optimiser votre liste.</p>';
                return;
            }
            const storesToVisit = [...new Set(optimizedItems.filter(item => item.selectedDeal && item.selectedDeal.store).map(item => item.selectedDeal.store))];

            if (storesToVisit.length === 0) {
                routeDisplayContainer.innerHTML = '<p>Aucune offre s√©lectionn√©e. Choisissez des articles dans la liste optimis√©e pour g√©n√©rer un itin√©raire.</p>';
                return;
            }
            
            routeDisplayContainer.innerHTML = '<h3>Magasins √† visiter :</h3>';
            const routeList = document.createElement('ol');
            routeList.id = 'route-list';
            storesToVisit.forEach(store => {
                const li = document.createElement('li');
                li.textContent = store;
                routeList.appendChild(li);
            });
            routeDisplayContainer.appendChild(routeList);
        }

        function formatPrice(item) {
            if (item.member_price) return `${item.member_price} ${item.unit || ''} (Membre)`;
            if (item.price && typeof item.price === 'string' && item.price.includes('/')) return `${item.price} ${item.unit || ''}${item.single_price ? ` (${item.single_price})` : ''}`;
            if (item.price) return `${item.price} ${item.unit || ''}`;
            return "Prix non disponible";
        }

        function chargerCommercesDepuisDB(shouldRender = true) {
            return apiCall('/api/commerces/')
                .then(commercesFromDB => {
                    if (!Array.isArray(commercesFromDB)) {
                        throw new Error('La r√©ponse des commerces n\'est pas un tableau.');
                    }
                    const allStores = new Map();
                    manualStores.forEach(store => allStores.set(store.name.toLowerCase(), store));
                    commercesFromDB.forEach(commerce => {
                        allStores.set(commerce.nom.toLowerCase(), {
                            name: commerce.nom,
                            address: commerce.adresse,
                            website: commerce.site_web
                        });
                    });
                    manualStores = Array.from(allStores.values());
                    saveManualStores();
                    if (shouldRender) {
                        renderAllStores();
                    }
                })
                .catch(error => {
                    console.error("Erreur lors du chargement des commerces depuis la DB:", error);
                    if (shouldRender) {
                        renderAllStores();
                    }
                });
        }

        // Fonction pour charger les commerces (depuis la DB et le localStorage)
        function chargerCommerces() {
            // On charge d'abord ceux qui sont sauvegard√©s localement
            loadManualStores(); 
            // Ensuite, on met √† jour avec ceux de la base de donn√©es
            return apiCall('/api/commerces/')
                .then(response => response.json())
                .then(commercesFromDB => {
                    const allStoresMap = new Map();
                    manualStores.forEach(store => allStoresMap.set(store.name.toLowerCase(), store));
                    commercesFromDB.forEach(commerce => {
                        allStoresMap.set(commerce.nom.toLowerCase(), {
                            name: commerce.nom,
                            address: commerce.adresse,
                            website: commerce.site_web
                        });
                    });
                    manualStores = Array.from(allStoresMap.values());
                    saveManualStores();
                });
        }

        // Fonction pour charger les donn√©es des circulaires actives
        function chargerCirculairesActives() {
            return apiCall('/api/circulaires-actives/')
                .then(data => {
                    flyerData = data;
                    // Sauvegarder dans localStorage pour la page d'inventaire
                    localStorage.setItem('flyerData', JSON.stringify(flyerData)); 
                });
        }

        // Fonction pour charger les rabais (pour la section "Rabais Actifs")
        function chargerRabaisActifs() {
            return apiCall('/api/rabais-actifs/')
                .then(data => {
                    activeDeals = data;
                    renderRabaisGrid(data); // Met √† jour l'affichage de cette section
                });
        }

        function chargerDonneesCirculaires(shouldRender = true) {
            return apiCall('/api/circulaires-actives/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erreur r√©seau lors de la r√©cup√©ration des circulaires.');
                    }
                    return response.json();
                })
                .then(data => {
                    flyerData = data;
                    saveFlyerData();
                    if (shouldRender) {
                        renderAllStores();
                    }
                })
                .catch(error => {
                    console.error("Erreur lors du chargement des donn√©es de circulaires:", error);
                    if (shouldRender) {
                        renderAllStores();
                    }
                });
        }

        async function importFlyerData(event) {
            event.preventDefault();
            const jsonString = flyerJsonInput.value.trim();
            if (!jsonString) {
                alert("Veuillez coller le contenu JSON de la circulaire.");
                return;
            }

            let dataToImport;
            try {
                // √âtape 1 : Valider que le texte est un JSON correct
                dataToImport = JSON.parse(jsonString);
            } catch (error) {
                alert("Le texte fourni n'est pas un JSON valide. Veuillez v√©rifier le format.");
                console.error("Erreur de parsing JSON:", error);
                return;
            }

            try {
                // √âtape 2 : Utiliser correctement la fonction `apiCall`
                const result = await apiCall('/api/import-flyer/', 'POST', dataToImport);
                
                alert(result.message);
                flyerJsonInput.value = '';
                
                // √âtape 3 : Recharger toutes les donn√©es pour mettre √† jour la page
                await Promise.all([
                    chargerCommercesDepuisDB(false),
                    chargerCirculairesActives(),
                    chargerRabaisActifs()
                ]);
                
                renderAllStores();
                
            } catch (error) {
                console.error('Erreur lors de l\'importation via API:', error);
                alert(`Une erreur est survenue lors de l'importation : ${error.message}`);
            }
        }
        
        function openFlyerModal(event) {
            const storeName = event.target.dataset.storeName;
            const flyerContent = flyerData[storeName];

            if (!flyerContent || !Array.isArray(flyerContent.categories)) {
                console.error("Le contenu de la circulaire est invalide ou manque la cl√© 'categories'.");
                return;
            }
            
            modalTitle.textContent = `Circulaire - ${storeName}`;
            modalBody.innerHTML = '';

            if (flyerContent.categories.length === 0) {
                 modalBody.innerHTML = '<p class="placeholder">Cette circulaire ne contient aucun article.</p>';
            } else {
                flyerContent.categories.forEach(category => {
                    if(category.category_name) {
                        const categoryTitle = document.createElement('h4');
                        categoryTitle.textContent = category.category_name;
                        categoryTitle.style.marginTop = '15px';
                        categoryTitle.style.paddingBottom = '5px';
                        categoryTitle.style.borderBottom = '1px solid #ccc';
                        modalBody.appendChild(categoryTitle);
                    }

                    if (category.items && Array.isArray(category.items)) {
                        category.items.forEach(item => {
                            const itemElement = document.createElement('div');
                            itemElement.className = 'flyer-item';
                            const priceInfo = formatPrice(item);
                            itemElement.innerHTML = `<span class="flyer-item-name">${item.name}</span> <span class="flyer-item-price">${priceInfo}</span>`;
                            modalBody.appendChild(itemElement);
                        });
                    }
                });
            }
            
            flyerModal.style.display = 'block';
        }

        function closeFlyerModal() { flyerModal.style.display = 'none'; }
        
        // --- NOUVELLES FONCTIONS POUR LA RECHERCHE DE PRIX ---
        function generatePriceFinderPrompt() {
            const itemsToPrice = optimizedItems.filter(item => !item.selectedPrice || parseFloat(item.selectedPrice) === 0);

            if (itemsToPrice.length === 0) {
                priceFinderPromptOutput.style.display = 'none';
                document.querySelector('#price-importer-section p').textContent = "Tous les articles ont d√©j√† un prix. Aucune recherche n'est n√©cessaire.";
                return;
            }

            const itemNames = itemsToPrice.map(item => `    "${item.name}"`).join(',\n');

            const promptText = `Agis comme un assistant d'√©picerie pour le Qu√©bec, Canada.
Ta t√¢che est de trouver le prix courant et non en solde pour la liste d'articles suivante.

Fournis la r√©ponse uniquement sous la forme d'un tableau JSON. N'inclus aucun texte, explication ou formatage avant ou apr√®s le bloc de code JSON.

Chaque objet dans le tableau doit avoir exactement deux cl√©s :
1. "name" : une cha√Æne de caract√®res (string) qui doit correspondre EXACTEMENT au nom de l'article fourni.
2. "price" : un nombre (number) repr√©sentant le prix, par exemple 4.99.

Voici la liste des articles √† rechercher :
[
${itemNames}
]

Voici un exemple de la sortie attendue :
\`\`\`json
[
  {
    "name": "Laitue Iceberg",
    "price": 2.99
  },
  {
    "name": "Pain blanc en tranches",
    "price": 3.79
  }
]
\`\`\`

Maintenant, g√©n√®re le JSON pour la liste que je t'ai fournie.`;

            priceFinderPromptTextarea.value = promptText;
            priceFinderPromptOutput.style.display = 'block';
        }

        function importPricesFromJson() {
            const jsonString = importPricesJsonTextarea.value.trim();
            if (!jsonString) {
                alert("Veuillez coller le JSON fourni par l'IA dans la zone de texte.");
                return;
            }

            try {
                const importedPrices = JSON.parse(jsonString);
                if (!Array.isArray(importedPrices)) {
                    throw new Error("Le JSON doit √™tre un tableau (une liste) d'articles.");
                }

                let updatedCount = 0;
                importedPrices.forEach(importedItem => {
                    if (importedItem && importedItem.name && typeof importedItem.price === 'number') {
                        const itemIndex = optimizedItems.findIndex(optItem => 
                            optItem.name === importedItem.name && 
                            (!optItem.selectedPrice || parseFloat(optItem.selectedPrice) === 0)
                        );
                        
                        if (itemIndex !== -1) {
                            optimizedItems[itemIndex].selectedPrice = importedItem.price.toFixed(2);
                            updatedCount++;
                        }
                    }
                });

                if (updatedCount > 0) {
                    saveOptimizedList();
                    renderOptimizedList();
                    importPricesJsonTextarea.value = '';
                    priceFinderContainer.style.display = 'none';
                    alert(`${updatedCount} prix ont √©t√© mis √† jour avec succ√®s !`);
                } else {
                    alert("Aucun prix n'a √©t√© mis √† jour. V√©rifiez que les noms dans le JSON correspondent aux articles sans prix dans votre liste.");
                }

            } catch (error) {
                console.error("Erreur d'importation de prix:", error);
                alert("Erreur lors de l'importation : " + error.message + ". Assurez-vous que le JSON est valide et respecte le format demand√©.");
            }
        }
        
        // --- MISE √Ä JOUR DE LA FONCTION DE RENDU DES RABAIS ---
        function renderRabaisGrid(rabais) {
            const container = document.getElementById('rabais-actifs-display');
            container.innerHTML = '';
            if (rabais.length === 0) {
                container.innerHTML = '<p class="placeholder">Aucun rabais actif trouv√©.</p>';
                return;
            }

            const rabaisParCommerce = rabais.reduce((acc, item) => {
                const store = item.commerce_nom;
                if (!acc[store]) acc[store] = [];
                acc[store].push(item);
                return acc;
            }, {});

            const sortedStores = Object.keys(rabaisParCommerce).sort();

            sortedStores.forEach(storeName => {
                const itemsDuCommerce = rabaisParCommerce[storeName];
                const storeDetails = document.createElement('details');
                storeDetails.className = 'store-rabais-group';
                storeDetails.open = true; // Ouvert par d√©faut avant application de l'√©tat sauvegard√©

                const storeSummary = document.createElement('summary');
                storeSummary.className = 'store-rabais-summary';
                storeSummary.innerHTML = `${storeName} <span class="deal-count">${itemsDuCommerce.length} rabais</span>`;
                storeDetails.appendChild(storeSummary);

                const rabaisParCategorie = itemsDuCommerce.reduce((acc, item) => {
                    const category = item.categorie_nom || "Non class√©";
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(item);
                    return acc;
                }, {});
                
                Object.keys(rabaisParCategorie).sort().forEach(categoryName => {
                    const categoryDetails = document.createElement('details');
                    categoryDetails.className = 'category-rabais-group';
                    categoryDetails.innerHTML = `<summary class="category-rabais-summary">${categoryName} <span class="deal-count">${rabaisParCategorie[categoryName].length}</span></summary>`;
                    
                    const grid = document.createElement('div');
                    grid.className = 'rabais-grid';
                    rabaisParCategorie[categoryName].forEach(item => {
                        const confirmButtonHtml = (item.submitted_by_username && item.submitted_by_username !== localStorage.getItem('username')) ?
                            `<button class="btn btn-small btn-confirm-price" data-price-id="${item.price_id}" style="background-color: #27ae60; margin-top: 8px;">Confirmer</button>` : '';

                        grid.innerHTML += `
                            <div class="rabais-item">
                                <div>
                                    <span class="produit-nom">${item.produit_nom}</span>
                                    <span class="commerce-nom">${item.commerce_nom}</span>
                                </div>
                                <div style="text-align: right; flex-shrink: 0;">
                                    <div class="prix-info">${item.details_prix || item.prix + ' $'}</div>
                                    ${confirmButtonHtml}
                                </div>
                            </div>`;
                    });
                    categoryDetails.appendChild(grid);
                    storeDetails.appendChild(categoryDetails);
                });
                container.appendChild(storeDetails);
            });
            
            // --- MODIFICATION : Applique l'√©tat sauvegard√© ---
            applyAccordionStates();
        }

        function chargerRabaisActifs() {
            return apiCall('/api/rabais-actifs/') // On appelle l'API des rabais
                .then(data => {
                    activeDeals = data; 
                    renderRabaisGrid(data); // Met √† jour la section "Rabais Actifs"
                })
                .catch(error => {
                    console.error("Erreur chargement rabais:", error);
                    const container = document.getElementById('rabais-actifs-display');
                    container.innerHTML = '<p class="placeholder" style="color: red;">Impossible de charger les rabais pour le moment.</p>';
                });
        }

        function chargerPrixActifs() {
            return apiCall('/api/active-prices/')
                .then(data => {
                    activeDeals = data; 
                    renderRabaisGrid(data);
                })
                .catch(error => {
                    console.error("Erreur:", error);
                    const container = document.getElementById('rabais-actifs-display');
                    container.innerHTML = '<p class="placeholder" style="color: red;">Impossible de charger les prix pour le moment.</p>';
                });
        }

        async function initializePage() {
            // 1. Initialiser les biblioth√®ques qui manipulent le DOM
            initializeGrid();

            // 2. Capturer toutes les r√©f√©rences aux √©l√©ments du DOM
            findStoresBtn = document.getElementById('findStoresBtn');
            sortStoresBtn = document.getElementById('sortStoresBtn');
            optimizeListBtn = document.getElementById('optimizeListBtn');
            printListBtn = document.getElementById('printListBtn');
            generateRouteBtn = document.getElementById('generateRouteBtn');
            addStoreUrlForm = document.getElementById('addStoreUrlForm');
            manualStoreUrlInput = document.getElementById('manualStoreUrl');
            importFlyerForm = document.getElementById('importFlyerForm');
            flyerJsonInput = document.getElementById('flyerJsonInput');
            flyerModal = document.getElementById('flyerModal');
            modalTitle = document.getElementById('modal-title');
            modalBody = document.getElementById('modal-body');
            closeBtn = document.querySelector('.close-btn');
            manageFlyersBtn = document.getElementById('manageFlyersBtn');
            flyerManagerModal = document.getElementById('flyerManagerModal');
            modalManagerBody = document.getElementById('modal-manager-body');
            closeBtnManager = document.querySelector('.close-btn-manager');
            editStoreModal = document.getElementById('editStoreModal');
            closeBtnEdit = document.querySelector('.close-btn-edit');
            editStoreForm = document.getElementById('editStoreForm');
            copyAiPromptBtn = document.getElementById('copy-ai-prompt-btn');
            aiPromptTextarea = document.getElementById('ai-prompt-textarea');
            findPricesBtn = document.getElementById('findPricesBtn');
            priceFinderContainer = document.getElementById('price-finder-container');
            priceFinderPromptOutput = document.getElementById('price-finder-prompt-output');
            priceFinderPromptTextarea = document.getElementById('price-finder-prompt-textarea');
            copyPriceFinderPromptBtn = document.getElementById('copy-price-finder-prompt-btn');
            importPricesJsonTextarea = document.getElementById('import-prices-json');
            importPricesBtn = document.getElementById('importPricesBtn');
            priceModal = document.getElementById('submit-price-modal');
            closePriceModalBtn = document.getElementById('close-price-modal-btn');
            submitPriceForm = document.getElementById('submit-price-form');
            modalProductName = document.getElementById('modal-product-name');
            hiddenProductNameInput = document.getElementById('hidden-product-name');
            storeSelect = document.getElementById('modal-store-select');
            priceInput = document.getElementById('modal-price-input');
            addProductModal = document.getElementById('add-product-modal');
            closeAddProductModalBtn = document.getElementById('close-add-product-modal-btn');
            addProductForm = document.getElementById('add-product-form');
            newProductNameDisplay = document.getElementById('new-product-name-display');
            hiddenNewProductNameInput = document.getElementById('hidden-new-product-name');
            addDealBtn = document.getElementById('add-deal-btn');
            submitDealModal = document.getElementById('submit-deal-modal');
            closeDealModalBtn = document.getElementById('close-deal-modal-btn');
            submitDealForm = document.getElementById('submit-deal-form');
            reportPriceModal = document.getElementById('report-price-modal');
            closeReportModalBtn = document.getElementById('close-report-modal-btn');
            reportPriceForm = document.getElementById('report-price-form');
            reportProductName = document.getElementById('report-product-name');
            hiddenReportPriceId = document.getElementById('hidden-report-price-id');
            optimizationDisplay = document.getElementById('optimization-display');

            // 3. Attacher les √©couteurs d'√©v√©nements (avec v√©rification pour plus de robustesse)
            if (findStoresBtn) findStoresBtn.addEventListener('click', findNearbyStores);
            if (sortStoresBtn) sortStoresBtn.addEventListener('click', sortStoresByDistance);
            if (optimizeListBtn) optimizeListBtn.addEventListener('click', optimizeShoppingList);
            if (printListBtn) printListBtn.addEventListener('click', printOptimizedList);
            if (generateRouteBtn) generateRouteBtn.addEventListener('click', generateRoute);
            if (addStoreUrlForm) addStoreUrlForm.addEventListener('submit', addStoreFromUrl);
            if (importFlyerForm) importFlyerForm.addEventListener('submit', importFlyerData);
            if (optimizationDisplay) {
                optimizationDisplay.addEventListener('change', handleDealSelection);
                optimizationDisplay.addEventListener('input', handlePriceChange);
                optimizationDisplay.addEventListener('dragstart', (e) => { if (e.target.classList.contains('optimized-item')) { draggedItemIndex = parseInt(e.target.dataset.index, 10); e.target.classList.add('dragging'); } });
                optimizationDisplay.addEventListener('dragover', (e) => { e.preventDefault(); const target = e.target.closest('.optimized-item'); if (target && parseInt(target.dataset.index, 10) !== draggedItemIndex) { document.querySelectorAll('.optimized-item.drag-over').forEach(el => el.classList.remove('drag-over')); target.classList.add('drag-over'); } });
                optimizationDisplay.addEventListener('dragleave', (e) => { if (e.target.classList.contains('optimized-item')) { e.target.classList.remove('drag-over'); } });
                optimizationDisplay.addEventListener('drop', (e) => { e.preventDefault(); const dropTarget = e.target.closest('.optimized-item'); if (dropTarget) { const dropIndex = parseInt(dropTarget.dataset.index, 10); const itemToMove = optimizedItems.splice(draggedItemIndex, 1)[0]; optimizedItems.splice(dropIndex, 0, itemToMove); saveOptimizedList(); renderOptimizedList(); } });
                optimizationDisplay.addEventListener('dragend', (e) => { document.querySelectorAll('.optimized-item.dragging, .optimized-item.drag-over').forEach(el => el.classList.remove('dragging', 'drag-over')); draggedItemIndex = null; });
                optimizationDisplay.addEventListener('click', openPriceModal);
            }
            if (copyAiPromptBtn) copyAiPromptBtn.addEventListener('click', copyAiPrompt);
            if (closeBtn) closeBtn.addEventListener('click', closeFlyerModal);
            if (manageFlyersBtn) manageFlyersBtn.addEventListener('click', openFlyerManagerModal);
            if (closeBtnManager) closeBtnManager.addEventListener('click', closeFlyerManagerModal);
            if (closeBtnEdit) closeBtnEdit.addEventListener('click', closeStoreEditModal);
            if (editStoreForm) editStoreForm.addEventListener('submit', handleStoreEditFormSubmit);
            if (findPricesBtn) findPricesBtn.addEventListener('click', () => {
                const isVisible = priceFinderContainer.style.display === 'block';
                priceFinderContainer.style.display = isVisible ? 'none' : 'block';
                if (!isVisible) {
                    generatePriceFinderPrompt();
                }
            });
            if (copyPriceFinderPromptBtn) copyPriceFinderPromptBtn.addEventListener('click', () => {
                priceFinderPromptTextarea.select();
                document.execCommand('copy');
                const originalText = copyPriceFinderPromptBtn.textContent;
                copyPriceFinderPromptBtn.textContent = 'Copi√© !';
                setTimeout(() => { copyPriceFinderPromptBtn.textContent = originalText; }, 2000);
            });
            if (importPricesBtn) importPricesBtn.addEventListener('click', importPricesFromJson);

            if (optimizationDisplay) optimizationDisplay.addEventListener('click', openReportModal);
            if (optimizationDisplay) optimizationDisplay.addEventListener('click', handleConfirmPrice);
            
            if (closePriceModalBtn) closePriceModalBtn.addEventListener('click', closePriceModal);
            if (submitPriceForm) submitPriceForm.addEventListener('submit', handlePriceSubmit);
            if (addProductForm) addProductForm.addEventListener('submit', handleAddProductSubmit);
            if (submitDealForm) submitDealForm.addEventListener('submit', handleDealSubmit);

            if (addDealBtn) addDealBtn.addEventListener('click', () => submitDealModal.style.display = 'block');
            if (closeAddProductModalBtn) closeAddProductModalBtn.addEventListener('click', () => addProductModal.style.display = 'none');
            if (closeDealModalBtn) closeDealModalBtn.addEventListener('click', () => submitDealModal.style.display = 'none');
            if (closeReportModalBtn) closeReportModalBtn.addEventListener('click', closeReportModal);
            if (reportPriceForm) reportPriceForm.addEventListener('submit', handleReportSubmit);

            const rabaisActifsDisplay = document.getElementById('rabais-actifs-display');
            if (rabaisActifsDisplay) {
                rabaisActifsDisplay.addEventListener('click', handleConfirmPrice);
                rabaisActifsDisplay.addEventListener('toggle', (event) => {
                    if (event.target.classList.contains('store-rabais-group')) {
                        saveAccordionStates();
                    }
                }, true); // Important : la phase de capture est n√©cessaire pour l'√©v√©nement 'toggle'
            }
 
            const searchRabaisInput = document.getElementById('search-rabais-input');
            if (searchRabaisInput) {
                searchRabaisInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    const filteredDeals = activeDeals.filter(deal => 
                        deal.produit_nom.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").includes(searchTerm)
                    );
                    renderRabaisGrid(filteredDeals);

                    if (searchTerm.length > 1) {
                        document.querySelectorAll('#rabais-actifs-display details').forEach(details => {
                            details.open = true;
                        });
                    }
                });
            }
            
            // 4. Charger les donn√©es initiales
            loadFlyerData();
            loadManualStores();
            loadSavedOptimizedList();
            await loadStoresIntoModal();

            Promise.all([
                chargerCirculairesActives(),
                chargerRabaisActifs(),
                chargerCommercesDepuisDB(false)
            ]).then(() => {
                console.log("Donn√©es de circulaires, rabais et commerces charg√©es.");
                renderAllStores();
            }).catch(error => {
                console.error("Une erreur est survenue lors du chargement des donn√©es initiales:", error);
            });
            
            if (localStorage.getItem('authToken')) {
                try {
                    const layout = await apiCall('/api/user/layout/', 'GET');
                    if (grid && layout && layout.length > 0) {
                        grid.load(layout);
                    }
                } catch (error) {
                    console.error("Erreur de chargement de la disposition:", error);
                }
            }
        }
        
        // --- PARTIE 4 : D√âMARRAGE ---
        initializePage();
        
        // √âcouteur global pour fermer les modales en cliquant √† l'ext√©rieur
        window.addEventListener('click', (event) => {
            if (event.target == flyerModal) closeFlyerModal();
            if (event.target == flyerManagerModal) closeFlyerManagerModal();
            if (event.target == editStoreModal) closeStoreEditModal();
            if (event.target == priceModal) closePriceModal();
            if (event.target == addProductModal) addProductModal.style.display = 'none';
            if (event.target == submitDealModal) submitDealModal.style.display = 'none';
            if (event.target == reportPriceModal) closeReportModal();
        });
    });
    </script>
{% endblock %}