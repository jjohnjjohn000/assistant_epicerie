{% extends "core/base.html" %}
{% load static %}

{% block title %}Optimiseur de Rabais et Itin√©raire{% endblock %}

{% block head_styles %}
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; background-color: #f4f7f9; color: #333; margin: 0; padding: 0; }
        .content-wrapper { padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        h2 { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;}
        h4 { display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 16px; background-color: #3498db; }
        .btn-small { font-size: 12px; padding: 5px 10px; }
        .btn:hover { background-color: #2980b9; }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .section { margin-bottom: 40px; }
        
        /* --- D√âBUT DE LA SOLUTION ROBUSTE (CSS GRID) --- */
        .optimized-item {
            display: grid;
            grid-template-columns: 1fr auto; /* La 1√®re colonne prend l'espace, la 2√®me s'adapte au contenu */
            grid-template-rows: auto auto; /* 2 rang√©es qui s'adaptent √† la hauteur du contenu */
            grid-template-areas:
                "name price"
                "deals price";
            align-items: center; /* Centre verticalement les √©l√©ments dans leur cellule de grille */
            column-gap: 15px; /* Espace entre les colonnes */
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            cursor: grab;
        }
        .item-name-grid {
            grid-area: name; /* Assigne cet √©l√©ment √† la zone "name" de la grille */
            font-weight: 500;
        }
        .item-deals-grid {
            grid-area: deals; /* Assigne cet √©l√©ment √† la zone "deals" */
            padding-top: 5px;
            font-size: 0.9em;
            color: #7f8c8d;
        }
        .item-deals-grid select {
            width: 100%;
        }
        .item-price-grid {
            grid-area: price; /* Assigne cet √©l√©ment √† la zone "price", qui s'√©tend sur 2 rang√©es */
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        /* --- FIN DE LA SOLUTION ROBUSTE --- */

        .optimized-item.dragging { opacity: 0.5; background-color: #ecf0f1; }
        .optimized-item.drag-over { border-top: 2px solid #3498db; }
        .item-price { color: #27ae60; font-weight: bold; }
        .item-store { font-size: 0.9em; color: #7f8c8d; }
        #route-list { list-style-type: decimal; padding-left: 20px; }
        #route-list li { padding: 8px 0; font-size: 1.1em; color: #34495e; }
        .placeholder-text { color: #7f8c8d; font-style: italic; }
        .store-item { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 5px; padding: 12px; margin-bottom: 8px; display: flex; align-items: center; }
        .store-item input[type="checkbox"] { margin-right: 12px; transform: scale(1.2); }
        .store-item label { flex-grow: 1; cursor: pointer; }
        .store-name { font-weight: bold; }
        #store-type-filters { margin: 15px 0; padding: 10px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 5px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; }
        #store-type-filters label { cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .store-details { font-size: 0.85em; color: #555; margin-top: 4px; }
        .store-details a { color: #2980b9; text-decoration: none; }
        .store-details a:hover { text-decoration: underline; }
        .store-address { font-size: 0.85em; color: #333; margin-top: 5px; }
        .store-actions { display: flex; flex-direction: column; gap: 5px; align-items: flex-end; }
        .btn-view-flyer { background-color: #9b59b6; font-size: 12px; padding: 5px 10px; margin-top: 5px; }
        .modal { display: none; position: fixed; z-index: 1056; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .modal-header h2 { margin: 0; color: #2c3e50; border-bottom: none; }
        .close-btn, .close-btn-manager, .close-btn-edit { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover, .close-btn:focus, .close-btn-manager:hover, .close-btn-manager:focus, .close-btn-edit:hover, .close-btn-edit:focus { color: black; }
        .flyer-item-list { max-height: 400px; overflow-y: auto; margin-top: 15px; }
        .flyer-item { display: flex; justify-content: space-between; padding: 8px 5px; border-bottom: 1px solid #eee; }
        .flyer-item-name { font-weight: 500; }
        .flyer-item-price { color: #27ae60; }
        .managed-flyer-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid #eee; }
        .btn-delete-flyer { background-color: #e74c3c; }
        .btn-delete-flyer:hover { background-color: #c0392b; }
        .rabais-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        .rabais-item {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            /* --- LIGNES AJOUT√âES --- */
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
            /* --- FIN DES LIGNES AJOUT√âES --- */
        }
        .rabais-item .produit-nom {
            font-weight: bold;
            color: #34495e;
            display: block;
        }
        .rabais-item .commerce-nom {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        .rabais-item .prix-info {
            font-size: 1.2em;
            font-weight: bold;
            color: #27ae60;
            text-align: right;
        }
        
        /* --- NOUVEAUX STYLES POUR L'ACCORD√âON DE RABAIS --- */
        .store-rabais-group {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #fff;
            overflow: hidden; /* Emp√™che le contenu de d√©border lors de l'animation */
            transition: all 0.3s ease-in-out;
        }
        .store-rabais-summary {
            padding: 15px;
            font-weight: bold;
            cursor: pointer;
            color: #34495e;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            list-style: none; /* Cache le marqueur par d√©faut */
        }
        .store-rabais-summary::-webkit-details-marker { display: none; } /* Cache le marqueur sur Chrome/Safari */
        .store-rabais-summary::before { /* Marqueur personnalis√© */
            content: '‚ñ∂';
            margin-right: 10px;
            font-size: 0.8em;
            color: #3498db;
            transition: transform 0.2s ease-in-out;
        }
        .store-rabais-group[open] > .store-rabais-summary::before {
             transform: rotate(90deg);
        }
        .store-rabais-summary:hover {
            background-color: #f8f9fa;
        }
        .deal-count {
            font-size: 0.9em;
            font-weight: normal;
            color: #7f8c8d;
            background-color: #e9ecef;
            padding: 3px 8px;
            border-radius: 12px;
        }
        .store-rabais-group[open] > .store-rabais-summary {
            border-bottom: 1px solid #e9ecef;
        }
        .store-rabais-group .rabais-grid {
            padding: 15px;
        }
        /* --- NOUVEAUX STYLES POUR L'ACCORD√âON DE CAT√âGORIES --- */
        .category-rabais-group {
            margin: 0 15px 10px 15px;
            border: 1px solid #f0f0f0;
            border-radius: 6px;
            background-color: #fcfcfc;
        }
        .category-rabais-summary {
            padding: 10px 15px;
            font-weight: 500; /* Moins gras que le magasin */
            cursor: pointer;
            color: #4a5568; /* Un peu plus clair */
            font-size: 1em;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .category-rabais-summary::-webkit-details-marker { display: none; }
        .category-rabais-summary:hover {
            background-color: #f0f3f5;
        }
        .category-rabais-summary::before {
            content: '‚Ä∫';
            margin-right: 8px;
            font-weight: bold;
            color: #3498db;
            transition: transform 0.2s ease-in-out;
            transform: rotate(0deg);
        }
        .category-rabais-group[open] > .category-rabais-summary::before {
             transform: rotate(90deg);
        }
        .category-rabais-group[open] > .category-rabais-summary {
            border-bottom: 1px solid #e9ecef;
        }
        .container {
            /* On ajuste le conteneur principal pour la grille */
            width: 100%;
            max-width: 1400px !important;
            padding: 0 !important;
            background: transparent !important;
            box-shadow: none !important;
        }
        .grid-stack-item-content {
            /* Style de base pour chaque "widget" */
            background-color: #ffffff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: auto !important; /* Permet le d√©filement interne */
            padding: 20px;
            height: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        .grid-stack-item-content section {
            flex-grow: 1; /* Assure que la section remplit le widget */
        }
        .grid-stack-item-content h1, .grid-stack-item-content h2 {
            margin-top: 0;
        }
    </style>
{% endblock %}

{% block content %}
            <div class="grid-stack">
                <!-- WIDGET 1: Rabais Actifs -->
                <div class="grid-stack-item" gs-id="flyer-deals-widget" gs-w="12" gs-h="6" gs-x="0" gs-y="0">
                    <div class="grid-stack-item-content">
                        <section id="flyer-deals-section" class="section">
                            <h2>Rabais Actifs des Circulaires</h2>
                            <input type="search" id="search-rabais-input" class="form-control form-control-lg mb-3" placeholder="Filtrer les rabais par nom de produit...">
                            <div id="rabais-actifs-display">
                                <p class="placeholder-text">Chargement des rabais en cours...</p>
                            </div>
                        </section>
                    </div>
                </div>
            

                <!-- WIDGET 2: S√©lection des Commerces & Outils -->
                <div class="grid-stack-item" gs-id="store-selection-widget" gs-w="6" gs-h="8" gs-x="0" gs-y="6">
                    <div class="grid-stack-item-content">
                        <section id="store-selection-section" class="section">
                            <!-- Tout le contenu de l'ancienne section "1. S√©lection des Commerces" va ici -->
                            <h2>1. S√©lection des Commerces</h2>
                            <p>Trouvez les magasins √† proximit√© ou ajoutez-les via leur site web ou une circulaire JSON.</p>
                            
                            <div id="store-type-filters">
                                <label><input type="checkbox" class="store-type-filter" value="supermarket" checked> Grandes surfaces</label>
                                <label><input type="checkbox" class="store-type-filter" value="grocery" checked> √âpiceries</label>
                                <label><input type="checkbox" class="store-type-filter" value="convenience" checked> D√©panneurs</label>
                                <label><input type="checkbox" class="store-type-filter" value="pharmacy" checked> Pharmacies</label>
                            </div>
                
                            <div>
                                <button id="findStoresBtn" class="btn btn-primary">
                                    <i class="bi bi-magic"></i> Trouver les commerces √† proximit√©
                                </button>
                                <button id="sortStoresBtn" class="btn btn-primary" style="display: none; background-color: #16a085; margin-left: 10px;">
                                    <i class="bi bi-magic"></i> Trier par distance
                                </button>
                            </div>
                
                            <div id="manual-add-section" style="margin-top: 25px;">
                                <h4>Ajouter un commerce via son site web</h4>
                                <form id="addStoreUrlForm" class="input-group">
                                    <input type="url" id="manualStoreUrl" class="form-control" placeholder="https://www.exemple.com" required>
                                    <button type="submit" class="btn btn-outline-secondary">
                                        <i class="bi bi-plus-lg"></i> Ajouter
                                    </button>
                                </form>
                            </div>

                            <div id="community-add-section" style="margin-top: 25px;">
                                <h4>Contribution Communautaire</h4>
                                <button id="add-deal-btn" class="btn btn-primary" style="background-color: #e67e22;">
                                    <i class="bi bi-magic"></i> Soumettre un rabais
                                </button>
                                <p style="font-size: 0.9em; color: #555;">Aidez la communaut√© en ajoutant un rabais que vous avez vu en magasin ou sur une circulaire.</p>
                            </div>
                            
                            <div id="flyer-import-section" style="margin-top: 25px;">
                                <div id="ai-converter-helper" style="background-color: #e8f4fd; border: 1px solid #d1e9fc; border-radius: 8px; padding: 20px; margin-bottom: 25px;">
                                    <h4>Besoin d'aide pour convertir une circulaire ?</h4>
                                    <p>Utilisez un assistant IA comme Gemini pour transformer automatiquement une circulaire (PDF, image ou site web) en format JSON compatible.</p>
                                    <p><strong>√âtape 1 :</strong> Copiez l'instruction ci-dessous. <br><strong>√âtape 2 :</strong> Ouvrez Gemini, collez l'instruction, puis ajoutez le lien ou le contenu de la circulaire que vous voulez convertir.</p>
                                    
                                    <textarea id="ai-prompt-textarea" rows="12" readonly style="width: 100%; box-sizing: border-box; font-family: monospace; padding: 10px; border-radius: 5px; border: 1px solid #ccc; background-color: #f8f9fa;">
Agis comme un expert en extraction de donn√©es de circulaires d'√©picerie. Ta t√¢che est de transformer les informations d'une circulaire que je vais te fournir en un format JSON structur√©.

Pour les dates, il est imp√©ratif d'utiliser les cl√©s `date_debut` et `date_fin` et de fournir les dates au format `AAAA-MM-JJ`.

Le JSON doit imp√©rativement suivre la structure suivante. Ne fournis aucune explication, commentaire ou texte avant ou apr√®s le bloc de code JSON.

Voici la structure exacte √† respecter :
\`\`\`json
{
"store": "NomDuMagasin",
"address": "123 Rue Principale, Ville, QC",
"website": "https://www.example.com",
"date_debut": "AAAA-MM-JJ",
"date_fin": "AAAA-MM-JJ",
"categories": [
    {
    "category_name": "Nom de la cat√©gorie (ex: √âpicerie, Fruits et l√©gumes)",
    "items": [
        {
        "name": "Nom complet de l'article",
        "brand": "Marque (si disponible)",
        "description": "Description additionnelle",
        "price": "Prix affich√© (ex: 5.99, 2/4.00)",
        "quantity": "Quantit√© ou poids (ex: 500g, Paquet de 2)",
        "unit": "$/lb, l'unit√©, pour 2, etc.",
        "member_price": "Prix membre (si diff√©rent)",
        "regular_price": "Prix r√©gulier (si un rabais est indiqu√©)",
        "single_price": "Prix √† l'unit√© (si un prix de groupe est affich√©, ex: 2.50)",
        "local": true,
        "scene_points": "Points Sc√®ne+ (ou autre programme de points)"
        }
    ]
    }
]
}
\`\`\`

Maintenant, analyse la circulaire que je vais te fournir et g√©n√®re le JSON correspondant.
                                    </textarea>
                                                            
                                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                                        <button id="copy-ai-prompt-btn" class="btn btn-primary" style="background-color: #27ae60;">
                                            <i class="bi bi-magic"></i> Copier l'instruction
                                        </button>
                                        <a href="https://gemini.google.com/app" target="_blank" class="btn btn-primary" style="background-color: #8e44ad; text-decoration: none; text-align: center;">
                                            <i class="bi bi-magic"></i> Ouvrir Gemini
                                        </a>
                                    </div>
                                </div>

                                <h4>
                                    <span>Ajouter une circulaire (JSON)</span>
                                    <button id="manageFlyersBtn" class="btn btn-primary btn-small" style="background-color: #7f8c8d;">
                                        <i class="bi bi-magic"></i> G√©rer les circulaires
                                    </button>
                                </h4>
                                <form id="importFlyerForm">
                                    <p style="margin-top:0; font-size: 0.9em; color: #555;">
                                        Collez ici les donn√©es de la circulaire au format JSON pour l'int√©grer √† l'optimiseur.
                                    </p>
                                    <textarea id="flyerJsonInput" placeholder='{"store": "NomDuMagasin", "categories": [{"items": [...]}]}' style="width: 100%; min-height: 100px; box-sizing: border-box; border: 1px solid #ced4da; border-radius: 4px; padding: 10px; font-family: monospace; margin-bottom: 10px;"></textarea>
                                    <button type="submit" class="btn btn-primary" style="background-color: #8e44ad;">
                                        <i class="bi bi-magic"></i> Int√©grer la circulaire
                                    </button>
                                </form>
                            </div>
                
                            <div id="stores-list-display" style="margin-top: 20px;">
                                <p class="placeholder-text">La liste des commerces appara√Ætra ici.</p>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- WIDGET 3: Optimisation -->
                <div class="grid-stack-item" gs-id="optimization-widget" gs-w="6" gs-h="5" gs-x="6" gs-y="6">
                    <div class="grid-stack-item-content">
                        <section id="optimization-section" class="section">
                            <h2>
                                <span>2. Optimisation</span>
                                <div>
                                    <button id="findPricesBtn" class="btn btn-primary btn-small" style="background-color: #f39c12; display: none;">
                                        <i class="bi bi-magic"></i> Chercher prix manquants
                                    </button>
                                    <button id="printListBtn" class="btn btn-primary btn-small" style="background-color: #16a085;">
                                        <i class="bi bi-magic"></i> Imprimer la liste
                                    </button>
                                </div>
                            </h2>
                            <p>Comparez votre liste d'√©picerie avec les rabais des commerces s√©lectionn√©s.</p>
                            <button id="optimizeListBtn" class="btn btn-primary">
                                <i class="bi bi-magic"></i> Optimiser ma liste
                            </button>

                            <div id="price-finder-container" style="margin-top: 25px; display: none;">
                                <hr style="margin-bottom: 25px;">
                                <h4><span role="img" aria-label="robot">ü§ñ</span> Trouver les Prix Manquants avec l'IA</h4>
                                <p>Utilisez l'IA pour rechercher le prix r√©gulier des articles sans rabais s√©lectionn√©.</p>
                                
                                <div id="price-finder-prompt-output" style="display: none; background-color: #e8f4fd; border: 1px solid #d1e9fc; border-radius: 8px; padding: 20px; margin-bottom: 25px;">
                                    <p><strong>√âtape 1 :</strong> Copiez l'instruction. <br><strong>√âtape 2 :</strong> Collez-la dans Gemini pour obtenir les prix.</p>
                                    <textarea id="price-finder-prompt-textarea" rows="10" readonly style="width: 100%; box-sizing: border-box; font-family: monospace; padding: 10px; border-radius: 5px; border: 1px solid #ccc; background-color: #f8f9fa;"></textarea>
                                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                                        <button id="copy-price-finder-prompt-btn" class="btn btn-primary" style="background-color: #27ae60;">
                                            <i class="bi bi-magic"></i> Copier l'instruction
                                        </button>
                                        <a href="https://gemini.google.com/app" target="_blank" class="btn btn-primary" style="background-color: #8e44ad; text-decoration: none; text-align: center;">
                                            <i class="bi bi-magic"></i> Ouvrir Gemini
                                        </a>
                                    </div>
                                </div>
                        
                                <div id="price-importer-section">
                                    <p><strong>√âtape 3 :</strong> Collez le JSON fourni par Gemini ci-dessous.</p>
                                    <textarea id="import-prices-json" placeholder='[{"name": "Nom De L&#39;article", "price": 4.99}, ...]' style="width: 100%; min-height: 80px; box-sizing: border-box; border: 1px solid #ced4da; border-radius: 4px; padding: 10px; font-family: monospace; margin-bottom: 10px;"></textarea>
                                    <button id="importPricesBtn" class="btn btn-primary" style="background-color: #16a085;">
                                        <i class="bi bi-magic"></i> Importer les Prix
                                    </button>
                                </div>
                            </div>

                            <div id="optimization-display" style="margin-top: 20px;">
                                <p class="placeholder-text">Votre liste optimis√©e appara√Ætra ici.</p>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- WIDGET 4: Itin√©raire -->
                <div class="grid-stack-item" gs-id="route-widget" gs-w="6" gs-h="3" gs-x="6" gs-y="11">
                    <div class="grid-stack-item-content">
                        <section id="route-section" class="section">
                            <h2>3. Itin√©raire d'Achat Sugg√©r√©</h2>
                            <p>G√©n√©rez un itin√©raire simple bas√© sur les magasins o√π se trouvent les meilleures offres.</p>
                            <button id="generateRouteBtn" class="btn btn-primary">
                                <i class="bi bi-magic"></i> G√©n√©rer l'itin√©raire
                            </button>
                            <div id="route-display" style="margin-top: 20px;">
                                <p class="placeholder-text">Votre itin√©raire appara√Ætra ici.</p>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

    <div id="flyerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Circulaire</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div id="modal-body" class="flyer-item-list"></div>
        </div>
    </div>
    
    <div id="flyerManagerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-manager-title">G√©rer les Circulaires Sauvegard√©es</h2>
                <span class="close-btn-manager">&times;</span>
            </div>
            <div id="modal-manager-body" class="flyer-item-list"></div>
        </div>
    </div>

    <div id="editStoreModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>√âditer le Commerce</h2>
                <span class="close-btn-edit">&times;</span>
            </div>
            <div id="modal-edit-body">
                <form id="editStoreForm">
                    <input type="hidden" id="originalStoreName">
                    <div style="margin-bottom: 15px;">
                        <label for="editStoreName" style="display: block; margin-bottom: 5px; font-weight: bold;">Nom du commerce</label>
                        <input type="text" id="editStoreName" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="editStoreAddress" style="display: block; margin-bottom: 5px; font-weight: bold;">Adresse</label>
                        <input type="text" id="editStoreAddress" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label for="editStoreWebsite" style="display: block; margin-bottom: 5px; font-weight: bold;">Site web</label>
                        <input type="url" id="editStoreWebsite" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    <div style="text-align: right;">
                        <button type="submit" class="btn btn-primary" style="background-color: #2ecc71;">
                            <i class="bi bi-magic"></i> Sauvegarder
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="submit-price-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Soumettre un Prix R√©gulier</h2>
                <span id="close-price-modal-btn" class="close-btn">&times;</span>
            </div>
            <div id="modal-price-body">
                <p>
                    Vous soumettez un prix pour le produit : 
                    <strong id="modal-product-name"></strong>
                </p>

                <form id="submit-price-form">
                    <!-- Champ cach√© pour garder en m√©moire le nom du produit -->
                    <input type="hidden" id="hidden-product-name">

                    <div style="margin-bottom: 15px;">
                        <label for="modal-store-select" style="display: block; margin-bottom: 5px; font-weight: bold;">
                            Dans quel commerce avez-vous vu ce prix ?
                        </label>
                        <select id="modal-store-select" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                            <option value="">-- Choisissez un commerce --</option>
                            <!-- Les commerces seront ajout√©s ici par JavaScript -->
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label for="modal-price-input" style="display: block; margin-bottom: 5px; font-weight: bold;">
                            Quel est le prix ?
                        </label>
                        <input type="number" id="modal-price-input" step="0.01" min="0" required placeholder="Ex: 4.99" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                    </div>

                    <div style="text-align: right;">
                        <button type="submit" class="btn btn-primary" style="background-color: #2ecc71;">
                            <i class="bi bi-magic"></i> Soumettre
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- ====== D√âBUT DES NOUVELLES MODALES ====== -->
    <!-- ============================================= -->

    <div id="add-product-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Ajouter un Nouveau Produit au Catalogue</h2>
                <span id="close-add-product-modal-btn" class="close-btn">&times;</span>
            </div>
            <div id="modal-add-product-body">
                <p>Le produit "<strong id="new-product-name-display"></strong>" n'a pas √©t√© trouv√©. Veuillez fournir quelques d√©tails pour l'ajouter.</p>
                <form id="add-product-form">
                    <input type="hidden" id="hidden-new-product-name">
                    <div style="margin-bottom: 15px;">
                        <label for="new-product-brand" style="display: block; margin-bottom: 5px; font-weight: bold;">Marque (facultatif)</label>
                        <input type="text" id="new-product-brand" placeholder="Ex: Kraft, St-M√©thode" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    <!-- On pourrait ajouter une s√©lection de cat√©gorie ici plus tard -->
                    <div style="text-align: right;">
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="submit-deal-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Soumettre un Rabais de Circulaire</h2>
                <span id="close-deal-modal-btn" class="close-btn">&times;</span>
            </div>
            <div id="modal-deal-body">
                <form id="submit-deal-form">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label for="deal-product-name" style="font-weight: bold;">Nom du Produit *</label>
                            <input type="text" id="deal-product-name" required placeholder="Ex: Beurre d'arachide">
                        </div>
                        <div>
                            <label for="deal-product-brand" style="font-weight: bold;">Marque</label>
                            <input type="text" id="deal-product-brand" placeholder="Ex: Kraft">
                        </div>
                        <div>
                            <label for="deal-store-select" style="font-weight: bold;">Commerce *</label>
                            <select id="deal-store-select" required></select>
                        </div>
                        <div>
                            <label for="deal-price-details" style="font-weight: bold;">Prix Affich√© *</label>
                            <input type="text" id="deal-price-details" required placeholder="Ex: 2 pour 5.00$">
                        </div>
                         <div>
                            <label for="deal-single-price" style="font-weight: bold;">Prix Unitaire Calcul√© *</label>
                            <input type="number" id="deal-single-price" step="0.01" min="0" required placeholder="Ex: 2.50">
                        </div>
                        <div>
                            <label for="deal-date-debut" style="font-weight: bold;">Date de D√©but du Rabais *</label>
                            <input type="date" id="deal-date-debut" required>
                        </div>
                         <div>
                            <label for="deal-date-fin" style="font-weight: bold;">Date de Fin du Rabais *</label>
                            <input type="date" id="deal-date-fin" required>
                        </div>
                    </div>
                    <style> #submit-deal-form input, #submit-deal-form select { width: 100%; padding: 8px; box-sizing: border-box; margin-top: 5px;} </style>
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary" style="background-color: #2ecc71;">
                            <i class="bi bi-magic"></i> Soumettre le Rabais
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="report-price-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Signaler un Prix</h2>
                <span id="close-report-modal-btn" class="close-btn">&times;</span>
            </div>
            <div id="modal-report-body">
                <p>
                    Vous signalez une information pour le produit : 
                    <strong id="report-product-name"></strong>
                </p>
                <form id="report-price-form">
                    <input type="hidden" id="hidden-report-price-id">
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">
                            Quelle est la raison du signalement ? *
                        </label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label><input type="radio" name="report_reason" value="INCORRECT_PRICE" required> Le prix est incorrect</label>
                            <label><input type="radio" name="report_reason" value="WRONG_PRODUCT"> Ce n'est pas le bon produit/commerce</label>
                            <label><input type="radio" name="report_reason" value="EXPIRED_DEAL"> Le rabais est expir√©</label>
                            <label><input type="radio" name="report_reason" value="OTHER"> Autre (pr√©cisez ci-dessous)</label>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label for="report-comments" style="display: block; margin-bottom: 5px; font-weight: bold;">
                            Commentaires (optionnel)
                        </label>
                        <textarea id="report-comments" placeholder="Fournissez plus de d√©tails si n√©cessaire" style="width: 100%; min-height: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"></textarea>
                    </div>

                    <div style="text-align: right;">
                        <button type="submit" class="btn btn-primary" style="background-color: #e74c3c;">
                            <i class="bi bi-magic"></i> Envoyer le signalement
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- ============== FIN DES MODALES ============== -->
    <!-- ============================================= -->
{% endblock %}

{% block body_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/gridstack@10.2.0/dist/gridstack-all.js"></script>
    <script src="{% static 'js/optimizer_page.js' %}"></script>
{% endblock %}